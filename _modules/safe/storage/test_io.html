


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>safe.storage.test_io &mdash; InaSAFE 1.0.1-final documentation</title>
    
    <link rel="stylesheet" href="../../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.1-final',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../../_static/toggle_sections.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="InaSAFE 1.0.1-final documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Home</a> &raquo;</li>
    <li><a href="../../../contents.html">Contents</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for safe.storage.test_io</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>

<span class="kn">from</span> <span class="nn">raster</span> <span class="kn">import</span> <span class="n">Raster</span>
<span class="kn">from</span> <span class="nn">vector</span> <span class="kn">import</span> <span class="n">Vector</span>
<span class="kn">from</span> <span class="nn">vector</span> <span class="kn">import</span> <span class="n">convert_polygons_to_centroids</span>
<span class="kn">from</span> <span class="nn">projection</span> <span class="kn">import</span> <span class="n">Projection</span>
<span class="kn">from</span> <span class="nn">projection</span> <span class="kn">import</span> <span class="n">DEFAULT_PROJECTION</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">read_layer</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">write_raster_data</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">write_keywords</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">read_keywords</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">bbox_intersection</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">minimal_bounding_box</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">buffered_bounding_box</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">array2wkt</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">calculate_polygon_area</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">calculate_polygon_centroid</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">points_along_line</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">geotransform2bbox</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">geotransform2resolution</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">raster_geometry2geotransform</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">get_bounding_box</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">bboxlist2string</span><span class="p">,</span> <span class="n">bboxstring2list</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">check_bbox_string</span>
<span class="kn">from</span> <span class="nn">utilities_test</span> <span class="kn">import</span> <span class="n">same_API</span>
<span class="kn">from</span> <span class="nn">geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">safe.common.numerics</span> <span class="kn">import</span> <span class="n">nanallclose</span>
<span class="kn">from</span> <span class="nn">safe.common.testing</span> <span class="kn">import</span> <span class="n">TESTDATA</span><span class="p">,</span> <span class="n">HAZDATA</span><span class="p">,</span> <span class="n">DATADIR</span>
<span class="kn">from</span> <span class="nn">safe.common.testing</span> <span class="kn">import</span> <span class="n">FEATURE_COUNTS</span>
<span class="kn">from</span> <span class="nn">safe.common.testing</span> <span class="kn">import</span> <span class="n">GEOTRANSFORMS</span>
<span class="kn">from</span> <span class="nn">safe.common.utilities</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">tr</span><span class="p">,</span> <span class="n">unique_filename</span>
<span class="kn">from</span> <span class="nn">safe.common.polygon</span> <span class="kn">import</span> <span class="n">is_inside_polygon</span>
<span class="kn">from</span> <span class="nn">safe.common.exceptions</span> <span class="kn">import</span> <span class="n">BoundingBoxError</span><span class="p">,</span> <span class="n">ReadLayerError</span>
<span class="kn">from</span> <span class="nn">safe.common.exceptions</span> <span class="kn">import</span> <span class="n">VerificationError</span><span class="p">,</span> <span class="n">InaSAFEError</span>


<span class="c"># Auxiliary function for raster test</span>
<div class="viewcode-block" id="linear_function"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.linear_function">[docs]</a><span class="k">def</span> <span class="nf">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Auxiliary function for use with raster test</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">/</span> <span class="mf">2.</span>

</div>
<div class="viewcode-block" id="Test_IO"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO">[docs]</a><span class="k">class</span> <span class="nc">Test_IO</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests for reading and writing of raster and vector data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Test_IO.test_instantiation_of_empty_layers"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_instantiation_of_empty_layers">[docs]</a>    <span class="k">def</span> <span class="nf">test_instantiation_of_empty_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vector and Raster objects can be instantiated with None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">is_inasafe_spatial_object</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Vector data&#39;</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">is_inasafe_spatial_object</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Raster data&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_vector_feature_count"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_vector_feature_count">[docs]</a>    <span class="k">def</span> <span class="nf">test_vector_feature_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of features read from vector data is as expected</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read and verify test data</span>
        <span class="k">for</span> <span class="n">vectorname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;test_buildings.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;Padang_WGS84.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;OSM_building_polygons_20110905.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;OSM_subset.shp&#39;</span><span class="p">]:</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">vectorname</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Check basic data integrity</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
            <span class="k">assert</span> <span class="n">FEATURE_COUNTS</span><span class="p">[</span><span class="n">vectorname</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>
</div>
    <span class="n">test_vector_feature_count</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_reading_and_writing_of_vector_point_data"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_reading_and_writing_of_vector_point_data">[docs]</a>    <span class="k">def</span> <span class="nf">test_reading_and_writing_of_vector_point_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vector point data can be read and written correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># First test that some error conditions are caught</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;nshoe66u&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ReadLayerError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Exception for unknown extension should have been raised&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.gml&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ReadLayerError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Exception for non-existing file should have been raised&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Read and verify test data</span>
        <span class="k">for</span> <span class="n">vectorname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;test_buildings.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;Padang_WGS84.shp&#39;</span><span class="p">,</span>
                           <span class="p">]:</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">vectorname</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">())</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Check basic data integrity</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>
            <span class="k">assert</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

            <span class="k">assert</span> <span class="n">FEATURE_COUNTS</span><span class="p">[</span><span class="n">vectorname</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="nb">basestring</span><span class="p">)</span>

            <span class="c"># Check projection</span>
            <span class="n">wkt</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">wkt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;GEOGCS&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">Projection</span><span class="p">(</span><span class="n">DEFAULT_PROJECTION</span><span class="p">)</span>

            <span class="c"># Check integrity of each feature</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="c"># Consistency between of geometry and fields</span>

                <span class="n">x1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Inconsistent longitudes: </span><span class="si">%f</span><span class="s"> != </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">msg</span>

                <span class="n">x1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;LATITUDE&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Inconsistent longitudes: </span><span class="si">%f</span><span class="s"> != </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">msg</span>

                <span class="c"># Verify that each feature has the same fields</span>
                <span class="k">if</span> <span class="n">field_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">field_names</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">assert</span> <span class="n">field_names</span> <span class="o">==</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

            <span class="c"># Write data back to file</span>
            <span class="c"># FIXME (Ole): I would like to use gml here, but OGR does not</span>
            <span class="c">#              store the spatial reference! Ticket #18</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
            <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wkt</span><span class="p">,</span>
                   <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;point&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>

            <span class="c"># Read again and check</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">is_point_data</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">())</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Check basic data integrity</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>
            <span class="k">assert</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

            <span class="c"># Check projection</span>
            <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">Projection</span><span class="p">(</span><span class="n">DEFAULT_PROJECTION</span><span class="p">)</span>

            <span class="c"># Check integrity of each feature</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>

                <span class="c"># Consistency between of geometry and fields</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Inconsistent longitudes: </span><span class="si">%f</span><span class="s"> != </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">msg</span>

                <span class="n">x1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;LATITUDE&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Inconsistent longitudes: </span><span class="si">%f</span><span class="s"> != </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">msg</span>

                <span class="c"># Verify that each feature has the same fields</span>
                <span class="k">if</span> <span class="n">field_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">field_names</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">assert</span> <span class="n">field_names</span> <span class="o">==</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

            <span class="c"># Test individual extraction</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</div>
    <span class="n">test_reading_and_writing_of_vector_point_data</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.Xtest_reading_and_writing_of_sqlite_vector_data"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.Xtest_reading_and_writing_of_sqlite_vector_data">[docs]</a>    <span class="k">def</span> <span class="nf">Xtest_reading_and_writing_of_sqlite_vector_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;SQLite vector data can be read and written correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># First test that some error conditions are caught</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;lembang_osm_20121003.sqlite&#39;</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">L</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Test_IO.test_donut_polygons"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_donut_polygons">[docs]</a>    <span class="k">def</span> <span class="nf">test_donut_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Donut polygon can be read, interpreted and written correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read real polygon with holes</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;donut.shp&#39;</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Write this new object, read it again and check</span>
        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>

        <span class="c"># Read back</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Geometry of polygon was not preserved after reading &#39;</span>
               <span class="s">&#39;and re-writing&#39;</span><span class="p">)</span>

        <span class="c"># Check</span>
        <span class="k">assert</span> <span class="n">R</span> <span class="o">==</span> <span class="n">L</span><span class="p">,</span> <span class="n">msg</span>
</div>
    <span class="n">test_donut_polygons</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_3d_polygon"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_3d_polygon">[docs]</a>    <span class="k">def</span> <span class="nf">test_3d_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;3D polygons can be read correctly with z component dismissed</span>

<span class="sd">        3D polygons are a specialisation of &#39;2d&#39; polygons which assigns</span>
<span class="sd">        a &#39;z&#39; to each vertex (wkbPolygon25D in ogr parlance).</span>
<span class="sd">        It&#39;s normally referred to as 2.5D since the format does not</span>
<span class="sd">        truly represent volumetric spaces</span>

<span class="sd">        This test verifies that such polygons can be read as 2d - i.e.</span>
<span class="sd">        with the third dimension removed.</span>

<span class="sd">        ogrinfo reports this for 25d polygons:</span>
<span class="sd">        INFO: Open of `../inasafe_data/test/25dpolygon.shp&#39;</span>
<span class="sd">        using driver `ESRI Shapefile&#39; successful.</span>
<span class="sd">        1: 25dpolygon (3D Polygon)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read real polygon with holes</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;25dpolygon.shp&#39;</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Write this new object, read it again and check</span>
        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>

        <span class="c"># Read back</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Geometry of polygon was not preserved after reading &#39;</span>
               <span class="s">&#39;and re-writing&#39;</span><span class="p">)</span>

        <span class="c"># Check</span>
        <span class="k">assert</span> <span class="n">R</span> <span class="o">==</span> <span class="n">L</span><span class="p">,</span> <span class="n">msg</span>
</div>
<div class="viewcode-block" id="Test_IO.test_analysis_of_vector_data_top_N"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_analysis_of_vector_data_top_N">[docs]</a>    <span class="k">def</span> <span class="nf">test_analysis_of_vector_data_top_N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Analysis of vector data - get top N of an attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">vectorname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;test_buildings.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">]:</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">vectorname</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Check exceptions</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_topN</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;FLOOR_AREA&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">VerificationError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Exception should have been raised for N == 0&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c"># Check results</span>
            <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">vectorname</span> <span class="o">==</span> <span class="s">&#39;test_buildings.shp&#39;</span><span class="p">:</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_topN</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;FLOOR_AREA&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>

                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Got projection </span><span class="si">%s</span><span class="s">, expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">projection</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">L</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">layer</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="n">msg</span>
                    <span class="c">#print [a[&#39;FLOOR_AREA&#39;] for a in L.attributes]</span>
                <span class="k">elif</span> <span class="n">vectorname</span> <span class="o">==</span> <span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">:</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_topN</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;STR_VALUE&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
                    <span class="k">assert</span> <span class="n">L</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span> <span class="o">==</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;STR_VALUE&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">L</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>

                    <span class="n">ref</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;STR_VALUE&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">]</span>
                    <span class="n">ref</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                    <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ref</span><span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="p">:],</span>
                                          <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span>
</div>
<div class="viewcode-block" id="Test_IO.test_vector_class"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_vector_class">[docs]</a>    <span class="k">def</span> <span class="nf">test_vector_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Consistency of vector class for point data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read data file</span>
        <span class="n">layername</span> <span class="o">=</span> <span class="s">&#39;test_buildings.shp&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">layername</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Add some additional keywords</span>
        <span class="n">V</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;kw1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;value1&#39;</span>
        <span class="n">V</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;kw2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;value2&#39;</span>

        <span class="c"># Check string representation of vector class</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Vector data&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

        <span class="c"># Make a smaller dataset</span>
        <span class="n">V_ref</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_topN</span><span class="p">(</span><span class="s">&#39;FLOOR_AREA&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="n">geometry</span> <span class="o">=</span> <span class="n">V_ref</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">V_ref</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">V_ref</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span>

        <span class="k">assert</span> <span class="s">&#39;kw1&#39;</span> <span class="ow">in</span> <span class="n">V_ref</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s">&#39;kw2&#39;</span> <span class="ow">in</span> <span class="n">V_ref</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span>

        <span class="c"># Create new object from test data</span>
        <span class="n">V_new</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
                       <span class="n">keywords</span><span class="o">=</span><span class="n">V_ref</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">())</span>

        <span class="c"># Check equality operations</span>
        <span class="k">assert</span> <span class="n">V_new</span> <span class="o">==</span> <span class="n">V_ref</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">V_new</span> <span class="o">!=</span> <span class="n">V_ref</span>

        <span class="n">V3</span> <span class="o">=</span> <span class="n">V_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">V_new</span> <span class="o">==</span> <span class="n">V3</span>  <span class="c"># Copy is OK</span>

        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;FLOOR_AREA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0e-5</span>
        <span class="k">assert</span> <span class="n">V_new</span> <span class="o">==</span> <span class="n">V3</span>  <span class="c"># Copy is OK within tolerance</span>

        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;FLOOR_AREA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0e-2</span>
        <span class="k">assert</span> <span class="n">V_new</span> <span class="o">!=</span> <span class="n">V3</span>  <span class="c"># Copy is outside tolerance</span>

        <span class="n">V3</span> <span class="o">=</span> <span class="n">V_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">V4</span> <span class="o">=</span> <span class="n">V_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">assert</span> <span class="n">V4</span> <span class="o">==</span> <span class="n">V3</span>  <span class="c"># Booleans work</span>

        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">V4</span> <span class="o">!=</span> <span class="n">V3</span>  <span class="c"># Booleans work</span>

        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">V4</span> <span class="o">!=</span> <span class="n">V3</span>  <span class="c"># None works</span>

        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">V4</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">V4</span> <span class="o">==</span> <span class="n">V3</span>  <span class="c"># False matches None</span>

        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">V4</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">V4</span> <span class="o">==</span> <span class="n">V3</span>  <span class="c"># False matches 0</span>

        <span class="n">V3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">V4</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;BUILDING_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">assert</span> <span class="n">V4</span> <span class="o">==</span> <span class="n">V3</span>  <span class="c"># True matches 1</span>

        <span class="c"># Write this new object, read it again and check</span>
        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">V_new</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>

        <span class="n">V_tmp</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">V_tmp</span> <span class="o">==</span> <span class="n">V_ref</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">V_tmp</span> <span class="o">!=</span> <span class="n">V_ref</span>

        <span class="c"># Check that equality raises exception when type is wrong</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">V_tmp</span> <span class="o">==</span> <span class="n">Raster</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised TypeError&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Check that differences in keywords affect comparison</span>
        <span class="k">assert</span> <span class="n">V_new</span> <span class="o">==</span> <span class="n">V_ref</span>
        <span class="n">V_tmp</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;kw2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;blah&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">V_tmp</span> <span class="o">==</span> <span class="n">V_ref</span>
        <span class="k">assert</span> <span class="n">V_tmp</span> <span class="o">!=</span> <span class="n">V_ref</span>
</div>
<div class="viewcode-block" id="Test_IO.test_ordering_polygon_vertices"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_ordering_polygon_vertices">[docs]</a>    <span class="k">def</span> <span class="nf">test_ordering_polygon_vertices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ordering of polygon vertices is preserved when writing and reading</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># So far the admissible classes are Point, Line and Polygon</span>
        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>

        <span class="c"># Simple polygon (in clock wise order)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.80</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.24</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.77</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.21</span><span class="p">]])</span>

        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">],</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;polygon&#39;</span><span class="p">)</span>
        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_ref</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">v_file</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Read geometry </span><span class="si">%s</span><span class="s">, but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">msg</span>

        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v_file</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="c"># Reversed order (OGR will swap back to clockwise)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.77</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.21</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.80</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.24</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">]])</span>

        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">],</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;polygon&#39;</span><span class="p">)</span>
        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_ref</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>  <span class="c"># Flip Up-Down to get order clockwise</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">v_file</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Read geometry </span><span class="si">%s</span><span class="s">, but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v_file</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="c"># Self intersecting polygon (in this case order will be flipped)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.80</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.24</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.77</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.21</span><span class="p">]])</span>
        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">],</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;polygon&#39;</span><span class="p">)</span>
        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_ref</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>  <span class="c"># Flip Up-Down to get order clockwise</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">v_file</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Read geometry </span><span class="si">%s</span><span class="s">, but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">msg</span>

        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v_file</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">3</span>
</div>
<div class="viewcode-block" id="Test_IO.test_vector_class_geometry_types"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_vector_class_geometry_types">[docs]</a>    <span class="k">def</span> <span class="nf">test_vector_class_geometry_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Admissible geometry types work in vector class</span>

<span class="sd">        Also check that reported bounding boxes are correct</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># So far the admissible classes are Point, Line and Polygon</span>
        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>

        <span class="c"># Check that one single polygon works</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.80</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.24</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.77</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.21</span><span class="p">]])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">],</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;polygon&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_ref</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">v_file</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Read geometry </span><span class="si">%s</span><span class="s">, but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">msg</span>

        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v_file</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="c"># Then a more complex dataset</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">122.226889</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.625599</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.227299</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.624500</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.227409</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.624221</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.227536</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.624059</span><span class="p">]]),</span>
                     <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">122.237129</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.628637</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.233170</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.627332</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.231621</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.626837</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.231021</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.626557</span><span class="p">]]),</span>
                     <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">122.247938</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.632926</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.247940</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.633560</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.247390</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.636220</span><span class="p">]]),</span>
                     <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">122.22</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.6256</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.23</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.6245</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.24</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.6242</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.22</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.6240</span><span class="p">]]),</span>
                     <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">122.24</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.63</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.23</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.63</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.23</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.62</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.23</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.61</span><span class="p">]]),</span>
                     <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">122.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.63</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.24</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.633</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">122.23</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.64</span><span class="p">]])]</span>

        <span class="c"># Point data</span>
        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">is_point_data</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">data_bbox</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">()</span>

        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v_file</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_point_data</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v_file</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">(),</span> <span class="n">data_bbox</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;point&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">is_point_data</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geometry_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">is_point_data</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v</span>

        <span class="c"># Line data</span>
        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">is_line_data</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">data_bbox</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">()</span>

        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v_file</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_line_data</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v_file</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">(),</span> <span class="n">data_bbox</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_ref</span>

        <span class="c"># Polygon data</span>
        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="n">data_bbox</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">()</span>

        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_ref</span> <span class="o">==</span> <span class="n">v_file</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v_file</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">(),</span> <span class="n">data_bbox</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;polygon&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_ref</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_ref</span>
</div>
<div class="viewcode-block" id="Test_IO.test_polygons_with_inner_rings"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_polygons_with_inner_rings">[docs]</a>    <span class="k">def</span> <span class="nf">test_polygons_with_inner_rings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Polygons with inner rings can be written and read</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Define two (closed) outer rings - clock wise direction</span>
        <span class="n">outer_rings</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.233</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.80</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.24</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.77</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.21</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.233</span><span class="p">]]),</span>
                       <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.76</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.72</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.72</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.72</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.21</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">106.76</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23</span><span class="p">]])]</span>

        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>

        <span class="c"># Do outer rings first (use default geometry type polygon)</span>
        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">outer_rings</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">is_polygon_data</span>

        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_polygon_data</span>

        <span class="c"># Do it again but with (closed) inner rings as well</span>

        <span class="c"># Define inner rings (counter clock wise)</span>
        <span class="n">inner_rings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c"># 2 rings for feature 0</span>
            <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.77827</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2252</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.77775</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22378</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22311</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.78017</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22530</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.77827</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2252</span><span class="p">]])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
             <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.78652</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23215</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.78642</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23075</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.78746</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23143</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.78831</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23307</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.78652</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.23215</span><span class="p">]])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
            <span class="c"># 1 ring for feature 1</span>
            <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.73709</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22752</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.73911</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22585</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.74265</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22814</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.73971</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22926</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">106.73709</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.22752</span><span class="p">]])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>

        <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">outer_ring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outer_rings</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">outer_ring</span><span class="o">=</span><span class="n">outer_ring</span><span class="p">,</span> <span class="n">inner_rings</span><span class="o">=</span><span class="n">inner_rings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">polygons</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="n">data_bbox</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">()</span>

        <span class="c"># Check data from Vector object</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">v_ref</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">outer_ring</span><span class="p">,</span> <span class="n">outer_rings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inner_rings</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="c"># Write to file and read again</span>
        <span class="n">v_ref</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="c">#print &#39;With inner rings, written to &#39;, tmp_filename</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">v_file</span> <span class="o">==</span> <span class="n">v_ref</span>
        <span class="k">assert</span> <span class="n">v_file</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v_file</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">(),</span> <span class="n">data_bbox</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

        <span class="c"># Check data from file</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">v_file</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">outer_ring</span><span class="p">,</span> <span class="n">outer_rings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inner_rings</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Test_IO.test_attribute_types"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_attribute_types">[docs]</a>    <span class="k">def</span> <span class="nf">test_attribute_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Different attribute types are handled correctly in vector data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read a data file</span>
        <span class="n">layername</span> <span class="o">=</span> <span class="s">&#39;test_buildings.shp&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">layername</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Make a smaller dataset</span>
        <span class="n">V_ref</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_topN</span><span class="p">(</span><span class="s">&#39;FLOOR_AREA&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="n">geometry</span> <span class="o">=</span> <span class="n">V_ref</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="c">#data = V_ref.get_data()</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">V_ref</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span>

        <span class="c"># Create new attributes with a range of types</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="s">&#39;String&#39;</span><span class="p">,</span> <span class="s">&#39;Boolean&#39;</span><span class="p">,</span> <span class="s">&#39;Integer&#39;</span><span class="p">,</span> <span class="s">&#39;Real&#39;</span><span class="p">,</span>
                <span class="s">&#39;Array 1D&#39;</span><span class="p">,</span> <span class="s">&#39;Array 2D&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;Test&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">,</span>
                  <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.56</span><span class="p">]),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">6.21</span><span class="p">]])]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="p">)):</span>
            <span class="n">D</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;Boolean&#39;</span><span class="p">:</span>
                    <span class="c"># Add a little variation</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">D</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">D</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">D</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>

        <span class="c"># Create new object from test data</span>
        <span class="n">V_new</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">)</span>

        <span class="c"># Write this new object, read it again and check</span>
        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">V_new</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>

        <span class="n">V_tmp</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>

        <span class="c">#print V_new.get_data()[1]</span>
        <span class="c">#print V_tmp.get_data()[1]</span>

        <span class="k">assert</span> <span class="n">V_tmp</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">V_new</span><span class="o">.</span><span class="n">projection</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">V_tmp</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">V_new</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">V_tmp</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">V_new</span><span class="o">.</span><span class="n">data</span>
        <span class="k">assert</span> <span class="n">V_tmp</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span> <span class="o">==</span> <span class="n">V_new</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">V_tmp</span> <span class="o">==</span> <span class="n">V_new</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">V_tmp</span> <span class="o">!=</span> <span class="n">V_new</span>
</div>
<div class="viewcode-block" id="Test_IO.test_reading_and_writing_of_vector_polygon_data"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_reading_and_writing_of_vector_polygon_data">[docs]</a>    <span class="k">def</span> <span class="nf">test_reading_and_writing_of_vector_polygon_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vector polygon data can be read and written correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read and verify test data</span>
        <span class="n">vectorname</span> <span class="o">=</span> <span class="s">&#39;kecamatan_jakarta_osm.shp&#39;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">vectorname</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">is_polygon_data</span>

        <span class="c"># Check basic data integrity</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>

        <span class="k">assert</span> <span class="n">FEATURE_COUNTS</span><span class="p">[</span><span class="n">vectorname</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="nb">basestring</span><span class="p">)</span>

        <span class="c"># Check projection</span>
        <span class="n">wkt</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">wkt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;GEOGCS&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">Projection</span><span class="p">(</span><span class="n">DEFAULT_PROJECTION</span><span class="p">)</span>

        <span class="c"># Check each polygon</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">2</span>
            <span class="k">assert</span> <span class="n">geom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

            <span class="c"># Check that polygon is closed</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># But that not all points are the same</span>
            <span class="n">max_dist</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">geom</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">max_dist</span><span class="p">:</span>
                    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">assert</span> <span class="n">max_dist</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c"># Check integrity of each feature</span>
        <span class="n">expected_features</span> <span class="o">=</span> <span class="p">{</span><span class="mi">13</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;KAB_NAME&#39;</span><span class="p">:</span> <span class="s">&#39;JAKARTA PUSAT&#39;</span><span class="p">,</span>
                                  <span class="s">&#39;KEC_NAME&#39;</span><span class="p">:</span> <span class="s">&#39;SAWAH BESAR&#39;</span><span class="p">},</span>
                             <span class="mi">20</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;KAB_NAME&#39;</span><span class="p">:</span> <span class="s">&#39;JAKARTA SELATAN&#39;</span><span class="p">,</span>
                                  <span class="s">&#39;KEC_NAME&#39;</span><span class="p">:</span> <span class="s">&#39;MAMPANG PRAPATAN&#39;</span><span class="p">}}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="c"># Consistency with attributes read manually with qgis</span>

            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expected_features</span><span class="p">:</span>
                <span class="n">att</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="n">expected_features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected attribute </span><span class="si">%s</span><span class="s"> was not found in feature </span><span class="si">%i</span><span class="s">&#39;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">att</span><span class="p">,</span> <span class="n">msg</span>

                    <span class="n">a</span> <span class="o">=</span> <span class="n">att</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Got </span><span class="si">%s</span><span class="s">: &quot;</span><span class="si">%s</span><span class="s">&quot; but expected &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">a</span> <span class="o">==</span> <span class="n">e</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Write data back to file</span>
        <span class="c"># FIXME (Ole): I would like to use gml here, but OGR does not</span>
        <span class="c">#              store the spatial reference! Ticket #18</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wkt</span><span class="p">,</span>
               <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;polygon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>

        <span class="c"># Read again and check</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">is_polygon_data</span>
        <span class="n">geometry_new</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">attributes_new</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry_new</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes_new</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">geometry_new</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>  <span class="c"># OGR works in single precision</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes_new</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attributes_new</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">attributes_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
</div>
    <span class="n">test_reading_and_writing_of_vector_polygon_data</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_centroids_from_polygon_data"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_centroids_from_polygon_data">[docs]</a>    <span class="k">def</span> <span class="nf">test_centroids_from_polygon_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Centroid point data can be derived from polygon data</span>

<span class="sd">        Test against centroid data generated by QGIS: shapefiles with</span>
<span class="sd">        a _centroids.shp suffix.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">vectorname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;kecamatan_jakarta_osm.shp&#39;</span><span class="p">,</span>
                           <span class="s">&#39;OSM_subset.shp&#39;</span><span class="p">]:</span>

            <span class="c"># Read and verify test data</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">vectorname</span><span class="p">)</span>
            <span class="n">p_layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">p_geometry</span> <span class="o">=</span> <span class="n">p_layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">p_attributes</span> <span class="o">=</span> <span class="n">p_layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_layer</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">FEATURE_COUNTS</span><span class="p">[</span><span class="n">vectorname</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>

            <span class="c"># Read reference centroids generated by Qgis</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">vectorname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_centroids.shp&#39;</span><span class="p">)</span>
            <span class="n">r_layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">r_geometry</span> <span class="o">=</span> <span class="n">r_layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">r_attributes</span> <span class="o">=</span> <span class="n">r_layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_layer</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>

            <span class="c"># Compute centroid data</span>
            <span class="n">c_layer</span> <span class="o">=</span> <span class="n">convert_polygons_to_centroids</span><span class="p">(</span><span class="n">p_layer</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_layer</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
            <span class="n">c_geometry</span> <span class="o">=</span> <span class="n">c_layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">c_attributes</span> <span class="o">=</span> <span class="n">c_layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Check that attributes are the same</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">p_att</span> <span class="o">=</span> <span class="n">p_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">c_att</span> <span class="o">=</span> <span class="n">c_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r_att</span> <span class="o">=</span> <span class="n">r_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">p_att</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">c_att</span>
                    <span class="k">assert</span> <span class="n">c_att</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">p_att</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">r_att</span>
                    <span class="k">assert</span> <span class="n">c_att</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">r_att</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c"># Check that coordinates are the same up to machine precision</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">c_geom</span> <span class="o">=</span> <span class="n">c_geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r_geom</span> <span class="o">=</span> <span class="n">r_geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c_geom</span><span class="p">,</span> <span class="n">r_geom</span><span class="p">,</span>
                                      <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

            <span class="c"># Check that each centroid fall within its polygon</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">c_geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">p_geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">is_inside_polygon</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">polygon</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="c"># Write to file (for e.g. visual inspection)</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;centroid&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
            <span class="c">#print &#39;writing to&#39;, out_filename</span>
            <span class="n">c_layer</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
</div>
    <span class="n">test_centroids_from_polygon_data</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_rasters_and_arrays"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_rasters_and_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">test_rasters_and_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Consistency of rasters and associated arrays</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create test data</span>
        <span class="n">lon_ul</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c"># Longitude of upper left corner</span>
        <span class="n">lat_ul</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c"># Latitude of upper left corner</span>
        <span class="n">numlon</span> <span class="o">=</span> <span class="mi">8</span>    <span class="c"># Number of longitudes</span>
        <span class="n">numlat</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c"># Number of latitudes</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c"># Define array where latitudes are rows and longitude columns</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numlat</span><span class="p">,</span> <span class="n">numlon</span><span class="p">))</span>

        <span class="c"># Establish coordinates for lower left corner</span>
        <span class="n">lat_ll</span> <span class="o">=</span> <span class="n">lat_ul</span> <span class="o">-</span> <span class="n">numlat</span>
        <span class="n">lon_ll</span> <span class="o">=</span> <span class="n">lon_ul</span>

        <span class="c"># Define pixel centers along each direction</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">lon_ll</span> <span class="o">+</span> <span class="n">numlon</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">numlon</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">lat_ll</span> <span class="o">+</span> <span class="n">numlat</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">numlat</span><span class="p">)</span>

        <span class="c"># Define raster with latitudes going bottom-up (south to north).</span>
        <span class="c"># Longitudes go left-right (west to east)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlon</span><span class="p">):</span>
                <span class="n">A1</span><span class="p">[</span><span class="n">numlat</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># Throw in a nodata element</span>
        <span class="n">A1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>

        <span class="c"># Upper left corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">105.25</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="c"># Lower left corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">103.25</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># Upper right corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mf">112.25</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="c"># Lower right corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mf">110.25</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># Generate raster object and write</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;GEOGCS[&quot;WGS 84&quot;,&#39;</span>
                      <span class="s">&#39;DATUM[&quot;WGS_1984&quot;,&#39;</span>
                      <span class="s">&#39;SPHEROID[&quot;WGS 84&quot;,6378137,298.2572235630016,&#39;</span>
                      <span class="s">&#39;AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]],&#39;</span>
                      <span class="s">&#39;AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]],&#39;</span>
                      <span class="s">&#39;PRIMEM[&quot;Greenwich&quot;,0],&#39;</span>
                      <span class="s">&#39;UNIT[&quot;degree&quot;,0.0174532925199433],&#39;</span>
                      <span class="s">&#39;AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]]&#39;</span><span class="p">)</span>
        <span class="n">geotransform</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_ul</span><span class="p">,</span> <span class="n">dlon</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lat_ul</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dlat</span><span class="p">)</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">geotransform</span><span class="p">,</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;testkwd&#39;</span><span class="p">:</span> <span class="s">&#39;testval&#39;</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="s">&#39;small&#39;</span><span class="p">})</span>

        <span class="c"># Check string representation of raster class</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Raster data&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>

        <span class="c"># Test conversion between geotransform and</span>
        <span class="c"># geometry (longitudes and latitudes)</span>
        <span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Longitudes not as expected: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">longitudes</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="p">[</span><span class="mf">100.5</span><span class="p">,</span> <span class="mf">101.5</span><span class="p">,</span> <span class="mf">102.5</span><span class="p">,</span> <span class="mf">103.5</span><span class="p">,</span> <span class="mf">104.5</span><span class="p">,</span>
                                           <span class="mf">105.5</span><span class="p">,</span> <span class="mf">106.5</span><span class="p">,</span> <span class="mf">107.5</span><span class="p">]),</span> <span class="n">msg</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Latitudes not as expected: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">latitudes</span><span class="p">,</span> <span class="p">[</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">]),</span> <span class="n">msg</span>

        <span class="n">gt</span> <span class="o">=</span> <span class="n">raster_geometry2geotransform</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Conversion from coordinates to geotransform failed: </span><span class="si">%s</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">gt</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">geotransform</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Dimensions of raster array do not match those of &#39;</span>
               <span class="s">&#39;raster object&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numlat</span> <span class="o">==</span> <span class="n">R1</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">numlon</span> <span class="o">==</span> <span class="n">R1</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Write back to new (tif) file</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.tif&#39;</span><span class="p">)</span>
        <span class="n">R1</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">R1</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="n">out_filename</span>

        <span class="c"># Check nodata in original layer</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">get_nodata_value</span><span class="p">())</span>

        <span class="c"># Read again and check consistency</span>
        <span class="n">R2</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">R2</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="n">out_filename</span>

        <span class="c"># Check nodata in read layer</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">R2</span><span class="o">.</span><span class="n">get_nodata_value</span><span class="p">())</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Dimensions of written raster array do not match those &#39;</span>
               <span class="s">&#39;of input raster file</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;    Dimensions of input file &#39;</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s">:  (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">numlat</span><span class="p">,</span> <span class="n">numlon</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;    Dimensions of output file </span><span class="si">%s</span><span class="s">: &#39;</span>
                <span class="s">&#39;(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">R2</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">R2</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">R2</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">numlat</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">numlon</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">A2</span> <span class="o">=</span> <span class="n">R2</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">A1</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">A2</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">A1</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">A2</span><span class="p">))</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Array values of written raster array were not as expected&#39;</span>
        <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Geotransforms were different&#39;</span>
        <span class="k">assert</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">()</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span> <span class="n">msg</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">R2</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Projections were different: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">p1</span> <span class="o">==</span> <span class="n">p1</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Exercise projection __eq__ method</span>
        <span class="k">assert</span> <span class="n">R1</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">projection</span>

        <span class="c"># Check that equality raises exception when type is wrong</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">R1</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="mi">234</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised TypeError&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Check keywords</span>
        <span class="k">assert</span> <span class="n">R1</span><span class="o">.</span><span class="n">keywords</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">keywords</span>

        <span class="c"># Check override of ==</span>
        <span class="k">assert</span> <span class="n">R1</span> <span class="o">==</span> <span class="n">R2</span>
</div>
<div class="viewcode-block" id="Test_IO.test_rasters_created_with_projected_srs"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_rasters_created_with_projected_srs">[docs]</a>    <span class="k">def</span> <span class="nf">test_rasters_created_with_projected_srs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rasters can be created from arrays in projected coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create test data</span>
        <span class="n">x_ul</span> <span class="o">=</span> <span class="mi">220534</span>  <span class="c"># x value of upper left corner</span>
        <span class="n">y_ul</span> <span class="o">=</span> <span class="mi">827790</span>   <span class="c"># y_value of upper left corner</span>
        <span class="n">numx</span> <span class="o">=</span> <span class="mi">8</span>    <span class="c"># Number of xs</span>
        <span class="n">numy</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c"># Number of ys</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">200</span>

        <span class="c"># Define array where ys are rows and xs columns</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numy</span><span class="p">,</span> <span class="n">numx</span><span class="p">))</span>

        <span class="c"># Establish coordinates for lower left corner</span>
        <span class="n">y_ll</span> <span class="o">=</span> <span class="n">y_ul</span> <span class="o">-</span> <span class="n">numy</span> <span class="o">*</span> <span class="n">dy</span>
        <span class="n">x_ll</span> <span class="o">=</span> <span class="n">x_ul</span>

        <span class="c"># Define pixel centers along each direction</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">x_ll</span> <span class="o">+</span> <span class="n">numx</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">numx</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">y_ll</span> <span class="o">+</span> <span class="n">numy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">numy</span><span class="p">)</span>

        <span class="c"># Define raster with latitudes going bottom-up (south to north).</span>
        <span class="c"># Longitudes go left-right (west to east)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numy</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numx</span><span class="p">):</span>
                <span class="n">A1</span><span class="p">[</span><span class="n">numy</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># Throw in a nodata element</span>
        <span class="n">A1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>

        <span class="c"># Upper left corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="c"># Lower left corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># Upper right corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="c"># Lower right corner</span>
        <span class="k">assert</span> <span class="n">A1</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># Generate raster object and write</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;PROJCS[&quot;DGN95 / Indonesia TM-3 zone 48.2&quot;,</span>
<span class="s">                        GEOGCS[&quot;DGN95&quot;,</span>
<span class="s">                            DATUM[&quot;Datum_Geodesi_Nasional_1995&quot;,</span>
<span class="s">                                SPHEROID[&quot;WGS 84&quot;,6378137,298.257223563,</span>
<span class="s">                                    AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]],</span>
<span class="s">                                TOWGS84[0,0,0,0,0,0,0],</span>
<span class="s">                                AUTHORITY[&quot;EPSG&quot;,&quot;6755&quot;]],</span>
<span class="s">                            PRIMEM[&quot;Greenwich&quot;,0,</span>
<span class="s">                                AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]],</span>
<span class="s">                            UNIT[&quot;degree&quot;,0.01745329251994328,</span>
<span class="s">                                AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],</span>
<span class="s">                            AUTHORITY[&quot;EPSG&quot;,&quot;4755&quot;]],</span>
<span class="s">                        UNIT[&quot;metre&quot;,1,</span>
<span class="s">                            AUTHORITY[&quot;EPSG&quot;,&quot;9001&quot;]],</span>
<span class="s">                        PROJECTION[&quot;Transverse_Mercator&quot;],</span>
<span class="s">                        PARAMETER[&quot;latitude_of_origin&quot;,0],</span>
<span class="s">                        PARAMETER[&quot;central_meridian&quot;,106.5],</span>
<span class="s">                        PARAMETER[&quot;scale_factor&quot;,0.9999],</span>
<span class="s">                        PARAMETER[&quot;false_easting&quot;,200000],</span>
<span class="s">                        PARAMETER[&quot;false_northing&quot;,1500000],</span>
<span class="s">                        AUTHORITY[&quot;EPSG&quot;,&quot;23834&quot;],</span>
<span class="s">                        AXIS[&quot;X&quot;,EAST],</span>
<span class="s">                        AXIS[&quot;Y&quot;,NORTH]]&quot;&quot;&quot;</span>

        <span class="n">geotransform</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_ul</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y_ul</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">geotransform</span><span class="p">,</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;testkwd&#39;</span><span class="p">:</span> <span class="s">&#39;testval&#39;</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="s">&#39;small&#39;</span><span class="p">})</span>

        <span class="c"># Check string representation of raster class</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Raster data&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span> <span class="n">A1</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span> <span class="n">geotransform</span><span class="p">,</span>
                           <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s">&#39;DGN95&#39;</span> <span class="ow">in</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Test_IO.test_reading_and_writing_of_real_rasters"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_reading_and_writing_of_real_rasters">[docs]</a>    <span class="k">def</span> <span class="nf">test_reading_and_writing_of_real_rasters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rasters can be read and written correctly in different formats</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">rastername</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Earthquake_Ground_Shaking_clip.tif&#39;</span><span class="p">,</span>
                           <span class="s">&#39;Population_2010_clip.tif&#39;</span><span class="p">,</span>
                           <span class="s">&#39;shakemap_padang_20090930.asc&#39;</span><span class="p">,</span>
                           <span class="s">&#39;population_padang_1.asc&#39;</span><span class="p">,</span>
                           <span class="s">&#39;population_padang_2.asc&#39;</span><span class="p">]:</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">rastername</span><span class="p">)</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">R1</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="n">filename</span>

            <span class="c"># Check consistency of raster</span>
            <span class="n">A1</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">A1</span><span class="o">.</span><span class="n">shape</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Dimensions of raster array do not match those of &#39;</span>
                   <span class="s">&#39;raster file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">R1</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">M</span> <span class="o">==</span> <span class="n">R1</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="n">R1</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Test conversion between geotransform and</span>
            <span class="c"># geometry (longitudes and latitudes)</span>
            <span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">gt</span> <span class="o">=</span> <span class="n">raster_geometry2geotransform</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Conversion from coordinates to geotransform failed: </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">gt</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span>
                                  <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c"># Write back to new file</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;.tif&#39;</span><span class="p">]:</span>  <span class="c"># Would like to also have , &#39;.asc&#39;]:</span>
                <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">write_raster_data</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span>
                                  <span class="n">R1</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                                  <span class="n">R1</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span>
                                  <span class="n">out_filename</span><span class="p">,</span>
                                  <span class="n">keywords</span><span class="o">=</span><span class="n">R1</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>

                <span class="c"># Read again and check consistency</span>
                <span class="n">R2</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">R2</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="n">out_filename</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Dimensions of written raster array do not match those &#39;</span>
                       <span class="s">&#39;of input raster file</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;    Dimensions of input file &#39;</span>
                        <span class="s">&#39;</span><span class="si">%s</span><span class="s">:  (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;    Dimensions of output file </span><span class="si">%s</span><span class="s">: &#39;</span>
                        <span class="s">&#39;(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">R2</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">R2</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">R2</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

                <span class="k">assert</span> <span class="n">M</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">msg</span>
                <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">msg</span>

                <span class="n">A2</span> <span class="o">=</span> <span class="n">R2</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">A1</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">A2</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">A1</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">A2</span><span class="p">))</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Array values of written raster array were not as &#39;</span>
                       <span class="s">&#39;expected&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">),</span> <span class="n">msg</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Geotransforms were different&#39;</span>
                <span class="k">assert</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">()</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span> <span class="n">msg</span>

                <span class="n">p1</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">R2</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Projections were different: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">p1</span> <span class="o">==</span> <span class="n">p1</span><span class="p">,</span> <span class="n">msg</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Keywords were different: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span>
                                                             <span class="n">R2</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">R1</span><span class="o">.</span><span class="n">keywords</span> <span class="o">==</span> <span class="n">R2</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="n">msg</span>

                <span class="c"># Use overridden == and != to verify</span>
                <span class="k">assert</span> <span class="n">R1</span> <span class="o">==</span> <span class="n">R2</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">R1</span> <span class="o">!=</span> <span class="n">R2</span>

                <span class="c"># Check equality within tolerance</span>
                <span class="n">R3</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">R3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0e-5</span>  <span class="c"># This is within tolerance</span>
                <span class="k">assert</span> <span class="n">R1</span> <span class="o">==</span> <span class="n">R3</span>

                <span class="n">R3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0e-2</span>  <span class="c"># This is outside tolerance</span>
                <span class="k">assert</span> <span class="n">R1</span> <span class="o">!=</span> <span class="n">R3</span>

                <span class="c"># Check that equality raises exception when type is wrong</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">R1</span> <span class="o">==</span> <span class="n">Vector</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised TypeError&#39;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
    <span class="n">test_reading_and_writing_of_real_rasters</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_no_projection"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_no_projection">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raster layers with no projection causes Exception to be raised</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rastername</span> <span class="o">=</span> <span class="s">&#39;grid_without_projection.asc&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">rastername</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised RuntimeError&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_bad_ascii_data"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_bad_ascii_data">[docs]</a>    <span class="k">def</span> <span class="nf">test_bad_ascii_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ASC raster files with bad data causes good error message</span>

<span class="sd">        This example is courtesy of Hyeuk Ryu</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Bad file</span>
        <span class="n">asc_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;bad_ascii_format.asc&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_layer</span><span class="p">(</span><span class="n">asc_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ReadLayerError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Check that error message is reasonable, e.g.</span>
            <span class="c"># File /home/nielso/sandpit/inasafe_data/test/bad_ascii_format.asc</span>
            <span class="c"># exists, but could not be read. Please check if the file can</span>
            <span class="c"># be opened with e.g. qgis or gdalinfo</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Unexpected error message for corrupt asc file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">assert</span> <span class="s">&#39;exists&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="s">&#39;gdalinfo&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="s">&#39;qgis&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="s">&#39;Please&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># No file</span>
        <span class="n">asc_filename</span> <span class="o">=</span> <span class="s">&#39;nonexisting_ascii_file_234xxxlcrhgqjk.asc&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_layer</span><span class="p">(</span><span class="n">asc_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ReadLayerError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Check that this error message reflects that file did not exist</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Unexpected error message for non existing asc file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">assert</span> <span class="s">&#39;Could not find file&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">msg</span>
</div>
    <span class="n">test_bad_ascii_data</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_nodata_value"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_nodata_value">[docs]</a>    <span class="k">def</span> <span class="nf">test_nodata_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;NODATA value is correctly handled for GDAL layers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read files with -9999 as nominated nodata value</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;Population_2010_clip.tif&#39;</span><span class="p">),</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span>
                                      <span class="s">&#39;Lembang_Earthquake_Scenario.asc&#39;</span><span class="p">),</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span>
                                      <span class="s">&#39;Earthquake_Ground_Shaking.asc&#39;</span><span class="p">)]:</span>

            <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="c"># Verify nodata value</span>
            <span class="n">Amin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flat</span><span class="p">[:])</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Raster must have -9999 as its minimum for this test. &#39;</span>
                   <span class="s">&#39;We got </span><span class="si">%f</span><span class="s"> for file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Amin</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">Amin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Verify that GDAL knows about this</span>
            <span class="n">nodata</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_nodata_value</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;File </span><span class="si">%s</span><span class="s"> should have registered nodata &#39;</span>
                   <span class="s">&#39;value </span><span class="si">%i</span><span class="s"> but it was </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">Amin</span><span class="p">,</span> <span class="n">nodata</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">nodata</span> <span class="o">==</span> <span class="n">Amin</span><span class="p">,</span> <span class="n">msg</span>

            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Earthquake_Ground_Shaking.asc&#39;</span><span class="p">):</span>
                <span class="c"># Slow</span>
                <span class="k">continue</span>

            <span class="c"># Then try using numpy.nan</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># Verify nodata value</span>
            <span class="n">Amin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flat</span><span class="p">[:])</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;True raster minimum must exceed -9999. &#39;</span>
                   <span class="s">&#39;We got </span><span class="si">%f</span><span class="s"> for file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Amin</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">Amin</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Then try with a number</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=-</span><span class="mi">100000</span><span class="p">)</span>

            <span class="c"># Verify nodata value</span>
            <span class="n">Amin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flat</span><span class="p">[:])</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Raster must have -100000 as its minimum for this test. &#39;</span>
                   <span class="s">&#39;We got </span><span class="si">%f</span><span class="s"> for file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Amin</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">Amin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100000</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Try with illegal nan values</span>
            <span class="k">for</span> <span class="n">illegal</span> <span class="ow">in</span> <span class="p">[{},</span> <span class="p">(),</span> <span class="p">[],</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;oeuu&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="n">illegal</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InaSAFEError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Illegal nan value </span><span class="si">%s</span><span class="s"> should have raised &#39;</span>
                           <span class="s">&#39;exception&#39;</span> <span class="o">%</span> <span class="n">illegal</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
    <span class="n">test_nodata_value</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_vector_extrema"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_vector_extrema">[docs]</a>    <span class="k">def</span> <span class="nf">test_vector_extrema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vector extremum calculation works</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">layername</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;test_buildings.shp&#39;</span><span class="p">,</span>
                          <span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">]:</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">layername</span><span class="p">)</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">layername</span> <span class="o">==</span> <span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">:</span>
                <span class="n">attributes</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;STR_VALUE&#39;</span><span class="p">,</span> <span class="s">&#39;CONT_VALUE&#39;</span><span class="p">]:</span>
                    <span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">minimum</span> <span class="o">&lt;=</span> <span class="n">maximum</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span>
                                          <span class="p">[</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">],</span>
                                          <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">layername</span> <span class="o">==</span> <span class="s">&#39;test_buildings.shp&#39;</span><span class="p">:</span>
                <span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">(</span><span class="s">&#39;FLOOR_AREA&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">minimum</span> <span class="o">==</span> <span class="n">maximum</span>  <span class="c"># All identical</span>
                <span class="k">assert</span> <span class="n">maximum</span> <span class="o">==</span> <span class="mi">250</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">L</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">(</span><span class="s">&#39;NONEXISTING_ATTRIBUTE_NAME_8462&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">VerificationError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Non existing attribute name should have &#39;</span>
                           <span class="s">&#39;raised VerificationError&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">L</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Missing attribute name should have &#39;</span>
                           <span class="s">&#39;raised RuntimeError&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_raster_extrema"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_raster_extrema">[docs]</a>    <span class="k">def</span> <span class="nf">test_raster_extrema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raster extrema (including NAN&#39;s) are correct.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">rastername</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Earthquake_Ground_Shaking_clip.tif&#39;</span><span class="p">,</span>
                           <span class="s">&#39;Population_2010_clip.tif&#39;</span><span class="p">,</span>
                           <span class="s">&#39;shakemap_padang_20090930.asc&#39;</span><span class="p">,</span>
                           <span class="s">&#39;population_padang_1.asc&#39;</span><span class="p">,</span>
                           <span class="s">&#39;population_padang_2.asc&#39;</span><span class="p">]:</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">rastername</span><span class="p">)</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="c"># Check consistency of raster</span>

            <span class="c"># Use numpy to establish the extrema instead of gdal</span>
            <span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

            <span class="c"># Check that arrays with NODATA value replaced by NaN&#39;s agree</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="c"># Check that extrema are OK</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">maximum</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">A</span><span class="p">[:]))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">maximum</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">B</span><span class="p">[:]))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">B</span><span class="p">[:]))</span>

            <span class="c"># Check that nodata can be replaced by 0.0</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;-9999 should have been replaced by 0.0 in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rastername</span>
            <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">flat</span><span class="p">[:])</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">msg</span>
</div>
    <span class="n">test_raster_extrema</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_bins"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_bins">[docs]</a>    <span class="k">def</span> <span class="nf">test_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Linear and quantile bins are correct</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/population_padang_1.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">,</span>
                         <span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_grid.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">]:</span>

            <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">]:</span>
                <span class="n">linear_intervals</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_bins</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

                <span class="k">assert</span> <span class="n">linear_intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rmin</span>
                <span class="k">assert</span> <span class="n">linear_intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">rmax</span>

                <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmax</span> <span class="o">-</span> <span class="n">rmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">linear_intervals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rmin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>

                <span class="n">quantiles</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_bins</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>  <span class="c"># Omit NaN&#39;s</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_grid.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">:</span>
                    <span class="c"># Check that NaN&#39;s were removed</span>
                    <span class="k">assert</span> <span class="n">l1</span> <span class="o">==</span> <span class="mi">35</span>
                    <span class="k">assert</span> <span class="n">l2</span> <span class="o">==</span> <span class="mi">30</span>

                <span class="c"># Assert that there are no NaN&#39;s</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>

                <span class="n">number_of_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                <span class="n">average_elements_per_bin</span> <span class="o">=</span> <span class="n">number_of_elements</span> <span class="o">/</span> <span class="n">N</span>

                <span class="c"># Count elements in each bin and check</span>
                <span class="n">i0</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">A</span> <span class="o">&lt;</span> <span class="n">i1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i0</span> <span class="o">==</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">refcount</span> <span class="o">=</span> <span class="n">count</span>

                    <span class="k">if</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="n">quantiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="c"># Number of elements in each bin must vary by no</span>
                        <span class="c"># more than 1</span>
                        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">refcount</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
                        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">average_elements_per_bin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># The last bin is allowed vary by more</span>
                        <span class="k">pass</span>

                    <span class="n">i0</span> <span class="o">=</span> <span class="n">i1</span>
</div>
    <span class="n">test_bins</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_raster_to_vector_points"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_raster_to_vector_points">[docs]</a>    <span class="k">def</span> <span class="nf">test_raster_to_vector_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raster layers can be converted to vector point layers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_grid.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Check data directly</span>
        <span class="n">coordinates</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">to_vector_points</span><span class="p">()</span>
        <span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">M</span> <span class="o">*</span> <span class="n">N</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:</span><span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">longitudes</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:</span><span class="n">L</span><span class="p">:</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">latitudes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flat</span><span class="p">[:],</span> <span class="n">values</span><span class="p">)</span>

        <span class="c"># Generate vector layer</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">to_vector_layer</span><span class="p">()</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Vector geometry should have been a list. I got </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">geometry</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Store it for visual inspection e.g. with QGIS</span>
        <span class="c">#out_filename = unique_filename(suffix=&#39;.shp&#39;)</span>
        <span class="c">#V.write_to_file(out_filename)</span>
        <span class="c">#print &#39;Written to &#39;, out_filename</span>

        <span class="c"># Check against cells that were verified manually using QGIS</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mf">96.97137053</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.34965715</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="p">[</span><span class="mf">97.0021116</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.38039821</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mf">50.6014</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="p">[</span><span class="mf">97.0021116</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.411139276</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="p">[</span><span class="mf">97.06359372</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.44188034</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Test_IO.test_raster_to_vector_points2"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_raster_to_vector_points2">[docs]</a>    <span class="k">def</span> <span class="nf">test_raster_to_vector_points2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raster layers can be converted to vector point layers (real data)</span>

<span class="sd">        # See qgis project in test data: raster_point_and_clipping_test.qgs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/population_5x5_jakarta.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Check data directly</span>
        <span class="n">coordinates</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">to_vector_points</span><span class="p">()</span>
        <span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">M</span> <span class="o">*</span> <span class="n">N</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:</span><span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">longitudes</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:</span><span class="n">L</span><span class="p">:</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">latitudes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flat</span><span class="p">[:],</span> <span class="n">values</span><span class="p">)</span>

        <span class="c"># Generate vector layer</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">to_vector_layer</span><span class="p">()</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Store it for visual inspection e.g. with QGIS</span>
        <span class="c">#out_filename = unique_filename(suffix=&#39;.shp&#39;)</span>
        <span class="c">#V.write_to_file(out_filename)</span>
        <span class="c">#print &#39;Written to &#39;, out_filename</span>

        <span class="c"># Systematic check of all cells</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">latitudes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c"># Start from bottom</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">longitudes</span><span class="p">):</span>  <span class="c"># The fastest varying dim</span>

                <span class="c"># Test location</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Got </span><span class="si">%s</span><span class="s"> but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">msg</span>

                <span class="c"># Test value</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span>
                                      <span class="n">A</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="Test_IO.test_get_bounding_box"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_get_bounding_box">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bounding box is correctly extracted from file.</span>

<span class="sd">        Reference data::</span>

<span class="sd">            gdalinfo Earthquake_Ground_Shaking_clip.tif</span>
<span class="sd">            Driver: GTiff/GeoTIFF</span>
<span class="sd">            Files: Earthquake_Ground_Shaking_clip.tif</span>
<span class="sd">            Size is 345, 263</span>
<span class="sd">            Coordinate System is:</span>
<span class="sd">            GEOGCS[&quot;WGS 84&quot;,</span>
<span class="sd">                DATUM[&quot;WGS_1984&quot;,</span>
<span class="sd">                    SPHEROID[&quot;WGS 84&quot;,6378137,298.2572235630016,</span>
<span class="sd">                        AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]],</span>
<span class="sd">                    AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]],</span>
<span class="sd">                PRIMEM[&quot;Greenwich&quot;,0],</span>
<span class="sd">                UNIT[&quot;degree&quot;,0.0174532925199433],</span>
<span class="sd">                AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]]</span>
<span class="sd">            Origin = (99.364169565217395,-0.004180608365019)</span>
<span class="sd">            Pixel Size = (0.008339130434783,-0.008361216730038)</span>
<span class="sd">            Metadata:</span>
<span class="sd">            AREA_OR_POINT=Point</span>
<span class="sd">            TIFFTAG_XRESOLUTION=1</span>
<span class="sd">            TIFFTAG_YRESOLUTION=1</span>
<span class="sd">            TIFFTAG_RESOLUTIONUNIT=1 (unitless)</span>
<span class="sd">            Image Structure Metadata:</span>
<span class="sd">            COMPRESSION=LZW</span>
<span class="sd">            INTERLEAVE=BAND</span>
<span class="sd">            Corner Coordinates:</span>
<span class="sd">            Upper Left  (  99.3641696,  -0.0041806)</span>
<span class="sd">                        ( 99d21&#39;51.01&quot;E,  0d 0&#39;15.05&quot;S)</span>
<span class="sd">            Lower Left  (  99.3641696,  -2.2031806)</span>
<span class="sd">                        ( 99d21&#39;51.01&quot;E,  2d12&#39;11.45&quot;S)</span>
<span class="sd">            Upper Right ( 102.2411696,  -0.0041806)</span>
<span class="sd">                        (102d14&#39;28.21&quot;E,  0d 0&#39;15.05&quot;S)</span>
<span class="sd">            Lower Right ( 102.2411696,  -2.2031806)</span>
<span class="sd">                        (102d14&#39;28.21&quot;E,  2d12&#39;11.45&quot;S)</span>
<span class="sd">            Center      ( 100.8026696,  -1.1036806)</span>
<span class="sd">                        (100d48&#39;9.61&quot;E,  1d 6&#39;13.25&quot;S)</span>
<span class="sd">            Band 1 Block=256x256 Type=Float64, ColorInterp=Gray</span>


<span class="sd">        Note post gdal 1.8 it is::</span>
<span class="sd">            Upper Left  (  99.3600000,   0.0000000)</span>
<span class="sd">                        ( 99d21&#39;36.00&quot;E,  0d 0&#39; 0.01&quot;N)</span>
<span class="sd">            Lower Left  (  99.3600000,  -2.1990000)</span>
<span class="sd">                        ( 99d21&#39;36.00&quot;E,  2d11&#39;56.40&quot;S)</span>
<span class="sd">            Upper Right ( 102.2370000,   0.0000000)</span>
<span class="sd">                        (102d14&#39;13.20&quot;E,  0d 0&#39; 0.01&quot;N)</span>
<span class="sd">            Lower Right ( 102.2370000,  -2.1990000)</span>
<span class="sd">                        (102d14&#39;13.20&quot;E,  2d11&#39;56.40&quot;S)</span>
<span class="sd">            Center      ( 100.7985000,  -1.0995000)</span>
<span class="sd">                        (100d47&#39;54.60&quot;E,  1d 5&#39;58.20&quot;S)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Note there are two possible correct values of bbox depending on</span>
        <span class="c"># the version of gdal:</span>
        <span class="c"># http://trac.osgeo.org/gdal/wiki/rfc33_gtiff_pixelispoint</span>

        <span class="c"># Get gdal version number</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">VersionInfo</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;dev&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c"># Turn into number and</span>
        <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># Remove trailing comma</span>

        <span class="c"># Reference bbox for vector data</span>
        <span class="n">ref_bbox</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">150.15238387897742</span><span class="p">,</span>
                                                      <span class="o">-</span><span class="mf">35.71084183517241</span><span class="p">,</span>
                                                      <span class="mf">150.18779267086208</span><span class="p">,</span>
                                                      <span class="o">-</span><span class="mf">35.70131768155173</span><span class="p">]}</span>

        <span class="c"># Select correct reference bbox for rasters</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">:</span>
            <span class="n">ref_bbox</span><span class="p">[</span><span class="s">&#39;Earthquake_Ground_Shaking_clip.tif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">99.3641696</span><span class="p">,</span>
                                                              <span class="o">-</span><span class="mf">2.2031806</span><span class="p">,</span>
                                                              <span class="mf">102.2411696</span><span class="p">,</span>
                                                              <span class="o">-</span><span class="mf">0.0041806</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_bbox</span><span class="p">[</span><span class="s">&#39;Earthquake_Ground_Shaking_clip.tif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">99.36</span><span class="p">,</span>
                                                              <span class="o">-</span><span class="mf">2.199</span><span class="p">,</span>
                                                              <span class="mf">102.237</span><span class="p">,</span>
                                                              <span class="mf">0.0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Earthquake_Ground_Shaking_clip.tif&#39;</span><span class="p">,</span>
                         <span class="s">&#39;tsunami_building_exposure.shp&#39;</span><span class="p">]:</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">get_bounding_box</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Got bbox </span><span class="si">%s</span><span class="s"> from filename </span><span class="si">%s</span><span class="s">, but expected </span><span class="si">%s</span><span class="s"> &#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bbox</span><span class="p">),</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_bbox</span><span class="p">[</span><span class="n">filename</span><span class="p">])))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">ref_bbox</span><span class="p">[</span><span class="n">filename</span><span class="p">]),</span> <span class="n">msg</span>

            <span class="c"># Check the conversions</span>
            <span class="n">bbox_string</span> <span class="o">=</span> <span class="n">bboxlist2string</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

            <span class="c"># Check the check :-)</span>
            <span class="n">check_bbox_string</span><span class="p">(</span><span class="n">bbox_string</span><span class="p">)</span>

            <span class="c"># Check that it works for layer objects instantiated from file</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
            <span class="n">L_bbox</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Got bbox </span><span class="si">%s</span><span class="s"> from filename </span><span class="si">%s</span><span class="s">, but expected </span><span class="si">%s</span><span class="s"> &#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">L_bbox</span><span class="p">),</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_bbox</span><span class="p">[</span><span class="n">filename</span><span class="p">])))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">L_bbox</span><span class="p">,</span> <span class="n">ref_bbox</span><span class="p">[</span><span class="n">filename</span><span class="p">]),</span> <span class="n">msg</span>

            <span class="c"># Check that it works for layer objects instantiated from data</span>
            <span class="k">if</span> <span class="n">L</span><span class="o">.</span><span class="n">is_raster</span><span class="p">:</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
                           <span class="n">projection</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                           <span class="n">geotransform</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">L</span><span class="o">.</span><span class="n">is_vector</span><span class="p">:</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
                           <span class="n">projection</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                           <span class="n">geometry</span><span class="o">=</span><span class="n">L</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Unexpected layer object: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c"># Check that get_bounding_box works for data instantiated layers</span>
            <span class="n">D_bbox</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">get_bounding_box</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Got bbox </span><span class="si">%s</span><span class="s"> from layer </span><span class="si">%s</span><span class="s">, but expected </span><span class="si">%s</span><span class="s"> &#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">D_bbox</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">D</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">L_bbox</span><span class="p">)))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">D_bbox</span><span class="p">,</span> <span class="n">L_bbox</span><span class="p">),</span> <span class="n">msg</span>
</div>
<div class="viewcode-block" id="Test_IO.test_layer_API"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_layer_API">[docs]</a>    <span class="k">def</span> <span class="nf">test_layer_API</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vector and Raster instances have a similar API</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Exceptions</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;get_topN&#39;</span><span class="p">,</span> <span class="s">&#39;get_bins&#39;</span><span class="p">,</span>
                   <span class="s">&#39;get_geotransform&#39;</span><span class="p">,</span>
                   <span class="s">&#39;get_nodata_value&#39;</span><span class="p">,</span>
                   <span class="s">&#39;get_attribute_names&#39;</span><span class="p">,</span>
                   <span class="s">&#39;get_resolution&#39;</span><span class="p">,</span>
                   <span class="s">&#39;get_geometry_type&#39;</span><span class="p">,</span>
                   <span class="s">&#39;get_geometry_name&#39;</span><span class="p">,</span>
                   <span class="s">&#39;to_vector_points&#39;</span><span class="p">,</span>
                   <span class="s">&#39;to_vector_layer&#39;</span><span class="p">]</span>

        <span class="n">V</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">()</span>  <span class="c"># Empty vector instance</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">()</span>  <span class="c"># Empty raster instance</span>

        <span class="k">assert</span> <span class="n">same_API</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span>
                                      <span class="s">&#39;test_buildings.shp&#39;</span><span class="p">),</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span>
                                      <span class="s">&#39;Lembang_Earthquake_Scenario.asc&#39;</span><span class="p">)]:</span>

            <span class="n">L</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">same_API</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">same_API</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_keywords_file"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_keywords_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_keywords_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Keywords can be written and read</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kwd_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.keywords&#39;</span><span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;impact_summary&#39;</span><span class="p">:</span> <span class="s">&#39;Describing the layer&#39;</span><span class="p">,</span>
                    <span class="s">&#39;category&#39;</span><span class="p">:</span> <span class="s">&#39;impact&#39;</span><span class="p">,</span>
                    <span class="s">&#39;subcategory&#39;</span><span class="p">:</span> <span class="s">&#39;flood&#39;</span><span class="p">,</span>
                    <span class="s">&#39;layer&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;kw&#39;</span><span class="p">:</span> <span class="s">&#39;with:colon&#39;</span><span class="p">,</span>
                    <span class="s">&#39;with spaces&#39;</span><span class="p">:</span> <span class="s">&#39;trailing_ws &#39;</span><span class="p">,</span>
                    <span class="s">&#39; preceding_ws&#39;</span><span class="p">:</span> <span class="s">&#39; mixed spaces &#39;</span><span class="p">,</span>
                    <span class="s">&#39;number&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
                    <span class="s">&#39;a_float &#39;</span><span class="p">:</span> <span class="mf">13.42</span><span class="p">,</span>
                    <span class="s">&#39;a_tuple&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">),</span>
                    <span class="s">&#39;a_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">],</span>
                    <span class="s">&#39;a_dict&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;I&#39;</span><span class="p">:</span> <span class="s">&#39;love&#39;</span><span class="p">,</span> <span class="s">&#39;cheese&#39;</span><span class="p">:</span> <span class="s">&#39;cake&#39;</span><span class="p">,</span> <span class="s">&#39;number&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                    <span class="s">&#39;a_nested_thing&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;k&#39;</span><span class="p">:</span> <span class="mf">17.8</span><span class="p">},</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>
                    <span class="s">&#39;an_expression&#39;</span><span class="p">:</span> <span class="s">&#39;37 + 5&#39;</span><span class="p">,</span>  <span class="c"># Evaluate to &#39;37 + 5&#39;, not 42</span>
                    <span class="c"># Potentially dangerous - e.g. if calling rm</span>
                    <span class="s">&#39;dangerous&#39;</span><span class="p">:</span> <span class="s">&#39;__import__(&quot;os&quot;).system(&quot;ls -l&quot;)&#39;</span><span class="p">,</span>
                    <span class="s">&#39;yes&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s">&#39;no&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

        <span class="n">write_keywords</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">kwd_filename</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Keywords file </span><span class="si">%s</span><span class="s"> was not created&#39;</span> <span class="o">%</span> <span class="n">kwd_filename</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

            <span class="n">k</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find keyword &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">keywords</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Got value &quot;</span><span class="si">%s</span><span class="s">&quot;, expected &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                                                     <span class="nb">str</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">msg</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">read_keywords</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="c"># Check keyword names</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Read unexpected key </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span>
            <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">msg</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected key </span><span class="si">%s</span><span class="s"> was not read from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span>
                                                            <span class="n">kwd_filename</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Check keyword values</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="n">refval</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c"># Expected value</span>
            <span class="n">newval</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c"># Value from keywords file</span>

            <span class="c"># Catch all - comparing string reprentations</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected value &quot;</span><span class="si">%s</span><span class="s">&quot; was not read from &quot;</span><span class="si">%s</span><span class="s">&quot;. &#39;</span>
                   <span class="s">&#39;I got &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">refval</span><span class="p">,</span> <span class="n">kwd_filename</span><span class="p">,</span> <span class="n">newval</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">refval</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">newval</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c"># Check None</span>
            <span class="k">if</span> <span class="n">refval</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">newval</span> <span class="ow">is</span> <span class="bp">None</span>

            <span class="c"># Check Booleans - explicitly</span>
            <span class="k">if</span> <span class="n">refval</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">newval</span> <span class="ow">is</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">refval</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">newval</span> <span class="ow">is</span> <span class="bp">False</span>

            <span class="c"># Check equality of python structures</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refval</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%s</span><span class="s"> but got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">refval</span><span class="p">,</span> <span class="n">newval</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">newval</span> <span class="o">==</span> <span class="n">refval</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Check catching wrong extensions</span>
        <span class="n">kwd_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.xxxx&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_keywords</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">kwd_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">VerificationError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised assertion error for wrong extension&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Make a spatial layer with these keywords</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_buildings.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(),</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                   <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;impact_summary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">V</span><span class="o">.</span><span class="n">get_impact_summary</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">V</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected keywords[</span><span class="si">%s</span><span class="s">] to be &quot;</span><span class="si">%s</span><span class="s">&quot; but &#39;</span>
                   <span class="s">&#39;got &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">keywords</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">val</span><span class="p">))</span>

            <span class="k">assert</span> <span class="n">keywords</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">,</span> <span class="n">msg</span>
            <span class="c">#if key in [&#39; preceding_ws&#39;, &#39;with spaces&#39;]:</span>
            <span class="c">#    # Accept that surrounding whitespace may be stripped</span>
            <span class="c">#    assert keywords[key].strip() == val, msg</span>
            <span class="c">#else:</span>
            <span class="c">#    assert keywords[key] == val, msg</span>
</div>
<div class="viewcode-block" id="Test_IO.test_empty_keywords_file"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_empty_keywords_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_empty_keywords_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empty keywords can be handled</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kwd_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.keywords&#39;</span><span class="p">)</span>
        <span class="n">write_keywords</span><span class="p">({},</span> <span class="n">kwd_filename</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Keywords file </span><span class="si">%s</span><span class="s"> was not created&#39;</span> <span class="o">%</span> <span class="n">kwd_filename</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">read_keywords</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Test_IO.test_keywords_with_colon"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_keywords_with_colon">[docs]</a>    <span class="k">def</span> <span class="nf">test_keywords_with_colon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Keywords and values with colons raise error messages</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Colon in key</span>
        <span class="n">kwd_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.keywords&#39;</span><span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;with_a_colon:in_it&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">}</span>  <span class="c"># This one is illegal</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_keywords</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">kwd_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">VerificationError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Colon in keywords key </span><span class="si">%s</span><span class="s"> was not caught&#39;</span> <span class="o">%</span> <span class="n">keywords</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Colon in value</span>
        <span class="n">kwd_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.keywords&#39;</span><span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;with_a_colon&#39;</span><span class="p">:</span> <span class="s">&#39;take: that!&#39;</span><span class="p">}</span>  <span class="c"># This one is ok</span>
        <span class="n">k</span> <span class="o">=</span> <span class="s">&#39;with_a_colon&#39;</span>

        <span class="n">write_keywords</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">kwd_filename</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">read_keywords</span><span class="p">(</span><span class="n">kwd_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">keywords</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Test_IO.test_bounding_box_conversions"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_bounding_box_conversions">[docs]</a>    <span class="k">def</span> <span class="nf">test_bounding_box_conversions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bounding boxes can be converted between list and string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Good ones</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[[</span><span class="mi">105</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">106.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">94.972335</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.009721</span><span class="p">,</span> <span class="mf">141.014</span><span class="p">,</span> <span class="mf">6.073612333333</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">105.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.5</span><span class="p">,</span> <span class="mf">110.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.5</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">105.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.8</span><span class="p">,</span> <span class="mf">110.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.1</span><span class="p">]]:</span>
            <span class="n">bbox_string</span> <span class="o">=</span> <span class="n">bboxlist2string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">bboxstring2list</span><span class="p">(</span><span class="n">bbox_string</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;105,-7,108,-5&#39;</span><span class="p">,</span>
                  <span class="s">&#39;106.5, -6.5, 107,-6&#39;</span><span class="p">,</span>
                  <span class="s">&#39;94.972335,-11.009721,141.014,6.073612333333&#39;</span><span class="p">]:</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">bboxstring2list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="c"># Check that numbers are numerically consistent</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)],</span>
                                  <span class="n">bbox_list</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>

        <span class="c"># Bad ones</span>
        <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="p">[[</span><span class="mi">105</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">106.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">94.972335</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.009721</span><span class="p">,</span> <span class="mf">141.014</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bbox_string</span> <span class="o">=</span> <span class="n">bboxlist2string</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BoundingBoxError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised BoundingBoxError&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;106.5,-6.5,-6&#39;</span><span class="p">,</span>
                  <span class="s">&#39;106.5,-6.5,-6,4,10&#39;</span><span class="p">,</span>
                  <span class="s">&#39;94.972335,x,141.014,6.07&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">bboxstring2list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BoundingBoxError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised exception: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_bounding_box_intersection"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_bounding_box_intersection">[docs]</a>    <span class="k">def</span> <span class="nf">test_bounding_box_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Intersections of bounding boxes work</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">west_java</span> <span class="o">=</span> <span class="p">[</span><span class="mi">105</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">jakarta</span> <span class="o">=</span> <span class="p">[</span><span class="mf">106.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">]</span>

        <span class="c"># Test commutative law</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">west_java</span><span class="p">,</span> <span class="n">jakarta</span><span class="p">),</span>
                              <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">jakarta</span><span class="p">,</span> <span class="n">west_java</span><span class="p">))</span>

        <span class="c"># Test inclusion</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">west_java</span><span class="p">,</span> <span class="n">jakarta</span><span class="p">),</span> <span class="n">jakarta</span><span class="p">)</span>

        <span class="c"># Ignore Bounding Boxes that are None</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">west_java</span><span class="p">,</span> <span class="n">jakarta</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
            <span class="n">jakarta</span><span class="p">)</span>

        <span class="c"># Realistic ones</span>
        <span class="n">bbox1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">94.972335</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.009721</span><span class="p">,</span> <span class="mf">141.014</span><span class="p">,</span> <span class="mf">6.073612333333</span><span class="p">]</span>
        <span class="n">bbox2</span> <span class="o">=</span> <span class="p">[</span><span class="mf">105.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.5</span><span class="p">,</span> <span class="mf">110.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.5</span><span class="p">]</span>
        <span class="n">bbox3</span> <span class="o">=</span> <span class="p">[</span><span class="mf">105.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.8</span><span class="p">,</span> <span class="mf">110.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.1</span><span class="p">]</span>

        <span class="n">ref1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">),</span> <span class="n">ref1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">),</span> <span class="n">bbox2</span><span class="p">)</span>

        <span class="n">ref2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">bbox3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">bbox3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">bbox3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">bbox3</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox3</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">),</span> <span class="n">ref2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox2</span><span class="p">,</span> <span class="n">bbox3</span><span class="p">),</span> <span class="n">ref2</span><span class="p">)</span>

        <span class="c"># Multiple boxes</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">,</span> <span class="n">bbox3</span><span class="p">),</span>
                              <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">,</span> <span class="n">bbox3</span><span class="p">,</span>
                                                <span class="n">west_java</span><span class="p">,</span> <span class="n">jakarta</span><span class="p">),</span>
                              <span class="n">jakarta</span><span class="p">)</span>

        <span class="c"># From actual example</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">94.972335000000001</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.009721000000001</span><span class="p">,</span>
              <span class="mf">141.014002</span><span class="p">,</span> <span class="mf">6.0736119999999998</span><span class="p">]</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">95.059660952000002</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.997409961000001</span><span class="p">,</span>
              <span class="mf">141.00132578099999</span><span class="p">,</span> <span class="mf">5.9109226959999983</span><span class="p">)</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">94.972335000000001</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.009721000000001</span><span class="p">,</span>
              <span class="mf">141.0140016666665</span><span class="p">,</span> <span class="mf">6.0736123333332639</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="mf">95.059660952</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.997409961</span><span class="p">,</span>
                                    <span class="mf">141.001325781</span><span class="p">,</span> <span class="mf">5.910922695999998</span><span class="p">],</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

        <span class="c"># Empty intersection should return None</span>
        <span class="k">assert</span> <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox2</span><span class="p">,</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">None</span>

        <span class="c"># Deal with invalid boxes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="p">[</span><span class="mi">53</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">BoundingBoxError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised exception&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">BoundingBoxError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised exception&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="s">&#39;blko ho skrle&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BoundingBoxError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised exception&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bbox_intersection</span><span class="p">(</span><span class="n">bbox1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">VerificationError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised exception&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bbox_intersection</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">VerificationError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised exception&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bbox_intersection</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">VerificationError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised exception&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_minimal_bounding_box"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_minimal_bounding_box">[docs]</a>    <span class="k">def</span> <span class="nf">test_minimal_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bounding box minimal size can be controlled</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">big</span> <span class="o">=</span> <span class="p">(</span><span class="mf">95.06</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.0</span><span class="p">,</span> <span class="mf">141.0</span><span class="p">,</span> <span class="mf">5.9</span><span class="p">)</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">103.28</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.46</span><span class="p">,</span> <span class="mf">109.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.68</span><span class="p">]</span>
        <span class="n">sml</span> <span class="o">=</span> <span class="p">(</span><span class="mf">106.818998</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.18585170</span><span class="p">,</span> <span class="mf">106.82264510</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.1810</span><span class="p">)</span>

        <span class="n">min_res</span> <span class="o">=</span> <span class="mf">0.008333333333000</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0e-4</span>

        <span class="c"># Check that sml box is actually too small</span>
        <span class="k">assert</span> <span class="n">sml</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">sml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_res</span>
        <span class="k">assert</span> <span class="n">sml</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">sml</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_res</span>

        <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="p">[</span><span class="n">big</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">sml</span><span class="p">]:</span>
            <span class="c"># Calculate minimal bounding box</span>
            <span class="n">adjusted_bbox</span> <span class="o">=</span> <span class="n">minimal_bounding_box</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">min_res</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>

            <span class="c"># Check that adjusted box exceeds minimal resolution</span>
            <span class="k">assert</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_res</span>
            <span class="k">assert</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_res</span>

            <span class="c"># Check that if box was adjusted eps was applied</span>
            <span class="k">if</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_res</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="n">min_res</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eps</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_res</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">min_res</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eps</span><span class="p">))</span>

            <span class="c"># Check that input box was not changed</span>
            <span class="k">assert</span> <span class="n">adjusted_bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">bbox</span>
</div>
<div class="viewcode-block" id="Test_IO.test_buffered_bounding_box"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_buffered_bounding_box">[docs]</a>    <span class="k">def</span> <span class="nf">test_buffered_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bounding box can be buffered</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">big</span> <span class="o">=</span> <span class="p">(</span><span class="mf">95.06</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.0</span><span class="p">,</span> <span class="mf">141.0</span><span class="p">,</span> <span class="mf">5.9</span><span class="p">)</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">103.28</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.46</span><span class="p">,</span> <span class="mf">109.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.68</span><span class="p">]</span>
        <span class="n">sml</span> <span class="o">=</span> <span class="p">(</span><span class="mf">106.818998</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.18585170</span><span class="p">,</span> <span class="mf">106.82264510</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.1810</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="p">[</span><span class="n">big</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">sml</span><span class="p">]:</span>

            <span class="c"># Set common resolution which is bigger than the smallest box</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

            <span class="c"># Calculate minimal bounding box</span>
            <span class="n">adjusted_bbox</span> <span class="o">=</span> <span class="n">buffered_bounding_box</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>

            <span class="c"># Check that adjusted box exceeds minimal resolution</span>
            <span class="k">assert</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">adjusted_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c"># Check that input box was not changed</span>
            <span class="k">assert</span> <span class="n">adjusted_bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">bbox</span>
</div>
<div class="viewcode-block" id="Test_IO.test_array2wkt"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_array2wkt">[docs]</a>    <span class="k">def</span> <span class="nf">test_array2wkt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Conversion to wkt data works</span>

<span class="sd">        It should create something like this</span>
<span class="sd">            &#39;POLYGON((0 1, 2 3, 4 5, 6 7, 8 9))&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Arrays first</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">wkt</span> <span class="o">=</span> <span class="n">array2wkt</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">geom_type</span><span class="o">=</span><span class="s">&#39;POLYGON&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">wkt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;POLYGON((&#39;</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">wkt</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)])</span>

        <span class="c"># Then list</span>
        <span class="n">wkt</span> <span class="o">=</span> <span class="n">array2wkt</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">geom_type</span><span class="o">=</span><span class="s">&#39;POLYGON&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">wkt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;POLYGON((&#39;</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">wkt</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)])</span>

        <span class="c"># Then a linestring example (note one less bracket)</span>
        <span class="n">wkt</span> <span class="o">=</span> <span class="n">array2wkt</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">geom_type</span><span class="o">=</span><span class="s">&#39;LINESTRING&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">wkt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;LINESTRING(&#39;</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">wkt</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="Test_IO.test_polygon_area"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_polygon_area">[docs]</a>    <span class="k">def</span> <span class="nf">test_polygon_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Polygon areas are computed correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create closed simple polygon (counter clock wise)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Calculated area was </span><span class="si">%f</span><span class="s">, expected 1.0 deg^2&#39;</span> <span class="o">%</span> <span class="n">A</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Create closed simple polygon (clock wise)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Calculated area was </span><span class="si">%f</span><span class="s">, expected 1.0 deg^2&#39;</span> <span class="o">%</span> <span class="n">A</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Calculated signed area was </span><span class="si">%f</span><span class="s">, expected -1.0 deg^2&#39;</span> <span class="o">%</span> <span class="n">A</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Not starting at zero</span>
        <span class="c"># Create closed simple polygon (counter clock wise)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">169</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">169</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Calculated area was </span><span class="si">%f</span><span class="s">, expected 1.0 deg^2&#39;</span> <span class="o">%</span> <span class="n">A</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Realistic polygon</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;test_polygon.shp&#39;</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="c"># Verify against area reported by qgis (only three decimals)</span>
        <span class="n">qgis_area</span> <span class="o">=</span> <span class="mf">0.003</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">qgis_area</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">)</span>

        <span class="c"># Verify against area reported by ESRI ARC (very good correspondence)</span>
        <span class="n">esri_area</span> <span class="o">=</span> <span class="mf">2.63924787273461e-3</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">esri_area</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_polygon_centroids"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_polygon_centroids">[docs]</a>    <span class="k">def</span> <span class="nf">test_polygon_centroids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Polygon centroids are computed correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create closed simple polygon (counter clock wise)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">calculate_polygon_centroid</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated centroid was (</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">), expected &#39;</span>
               <span class="s">&#39;(0.5, 0.5)&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]),</span> <span class="n">msg</span>

        <span class="c"># Create closed simple polygon (clock wise)</span>
        <span class="c"># FIXME (Ole): Not sure whether to raise an exception or</span>
        <span class="c">#              to return absolute value in this case</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">calculate_polygon_centroid</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated centroid was (</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">), expected &#39;</span>
               <span class="s">&#39;(0.5, 0.5)&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]),</span> <span class="n">msg</span>

        <span class="c"># Not starting at zero</span>
        <span class="c"># Create closed simple polygon (counter clock wise)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">169</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">169</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">calculate_polygon_centroid</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated centroid was (</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">), expected &#39;</span>
               <span class="s">&#39;(168.5, -1.5)&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="p">[</span><span class="mf">168.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">]),</span> <span class="n">msg</span>

        <span class="c"># Realistic polygon</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;test_polygon.shp&#39;</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">calculate_polygon_centroid</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="c"># Check against reference centroid</span>
        <span class="n">reference_centroid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">106.7036938</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.134533855</span><span class="p">]</span>  <span class="c"># From qgis</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">reference_centroid</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>

        <span class="c"># Store centroid to file (to e.g. check with qgis)</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;test_centroid&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">DEFAULT_PROJECTION</span><span class="p">,</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">C</span><span class="p">],</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&#39;Test centroid&#39;</span><span class="p">)</span>
        <span class="n">V</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>

        <span class="c"># Another realistic polygon</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">106.7922547</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2297884</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.7924589</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2298087</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.7924538</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2299127</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.7922547</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2298899</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">106.7922547</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.2297884</span><span class="p">]])</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">calculate_polygon_centroid</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="c"># Check against reference centroid from qgis</span>
        <span class="n">reference_centroid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">106.79235602697445</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.229849764722536</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Got </span><span class="si">%s</span><span class="s"> but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reference_centroid</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">reference_centroid</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Store centroid to file (to e.g. check with qgis)</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;test_centroid&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">DEFAULT_PROJECTION</span><span class="p">,</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">C</span><span class="p">],</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&#39;Test centroid&#39;</span><span class="p">)</span>
        <span class="n">V</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_line_to_points"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_line_to_points">[docs]</a>    <span class="k">def</span> <span class="nf">test_line_to_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Points along line are computed correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c"># Create simple line</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">points_along_line</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">expected_V</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated points were </span><span class="si">%s</span><span class="s">, expected &#39;</span>
               <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">expected_V</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">expected_V</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Not starting at zero</span>
        <span class="c"># Create line</span>
        <span class="n">L2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">V2</span> <span class="o">=</span> <span class="n">points_along_line</span><span class="p">(</span><span class="n">L2</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>

        <span class="n">expected_V2</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">169</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                      <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated points were </span><span class="si">%s</span><span class="s">, expected &#39;</span>
               <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">V2</span><span class="p">,</span> <span class="n">expected_V2</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">V2</span><span class="p">,</span> <span class="n">expected_V2</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Realistic polygon</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;indonesia_highway_sample.shp&#39;</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">points_along_line</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>

        <span class="c"># Check against reference centroid</span>
        <span class="n">expected_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">106.7168975</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.15530081</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">106.85224176</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.15344678</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">106.93660016</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.21370279</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">expected_v</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>

        <span class="c"># Store points to file (to e.g. check with qgis)</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;test_points_along_line&#39;</span><span class="p">,</span>
                                       <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">DEFAULT_PROJECTION</span><span class="p">,</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">C</span><span class="p">],</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&#39;Test points_along_line&#39;</span><span class="p">)</span>
        <span class="n">V</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_geotransform2bbox"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_geotransform2bbox">[docs]</a>    <span class="k">def</span> <span class="nf">test_geotransform2bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bounding box can be extracted from geotransform</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">M</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">for</span> <span class="n">gt</span> <span class="ow">in</span> <span class="n">GEOTRANSFORMS</span><span class="p">:</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">geotransform2bbox</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

            <span class="c"># FIXME: Need better tests here, but this is better than nothing</span>

            <span class="c"># Lower bounds</span>
            <span class="k">assert</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">gt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c"># Upper bounds</span>
            <span class="k">assert</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">gt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Test_IO.test_geotransform2resolution"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_geotransform2resolution">[docs]</a>    <span class="k">def</span> <span class="nf">test_geotransform2resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolution can be extracted from geotransform</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">gt</span> <span class="ow">in</span> <span class="n">GEOTRANSFORMS</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">geotransform2resolution</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">isotropic</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span> <span class="n">gt</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">geotransform2resolution</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">isotropic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">gt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">-</span> <span class="n">gt</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Test_IO.test_reading_and_writing_of_vector_line_data"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_reading_and_writing_of_vector_line_data">[docs]</a>    <span class="k">def</span> <span class="nf">test_reading_and_writing_of_vector_line_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vector line data can be read and written correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read and verify test data</span>
        <span class="n">vectorname</span> <span class="o">=</span> <span class="s">&#39;indonesia_highway_sample.shp&#39;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">vectorname</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Check basic data integrity</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="k">assert</span> <span class="n">FEATURE_COUNTS</span><span class="p">[</span><span class="n">vectorname</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="nb">basestring</span><span class="p">)</span>

        <span class="c"># Check projection</span>
        <span class="n">wkt</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">wkt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;GEOGCS&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">Projection</span><span class="p">(</span><span class="n">DEFAULT_PROJECTION</span><span class="p">)</span>

        <span class="c"># Check each line</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># A line should have more than one point.</span>
            <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="c"># A point should have two dimensions.</span>
            <span class="k">assert</span> <span class="n">geom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

            <span class="c"># Check that not all points are the same</span>
            <span class="n">max_dist</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">geom</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">max_dist</span><span class="p">:</span>
                    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">assert</span> <span class="n">max_dist</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">expected_features</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;LANES&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                 <span class="s">&#39;TYPE&#39;</span><span class="p">:</span> <span class="s">&#39;primary&#39;</span><span class="p">,</span>
                                 <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="s">&#39;route1&#39;</span><span class="p">},</span>
                             <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;LANES&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="s">&#39;TYPE&#39;</span><span class="p">:</span> <span class="s">&#39;secondary&#39;</span><span class="p">,</span>
                                 <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="s">&#39;route2&#39;</span><span class="p">}}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="c"># Consistency with attributes read manually with qgis</span>

            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expected_features</span><span class="p">:</span>
                <span class="n">att</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="n">expected_features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected attribute </span><span class="si">%s</span><span class="s"> was not found in feature </span><span class="si">%i</span><span class="s">&#39;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">att</span><span class="p">,</span> <span class="n">msg</span>

                    <span class="n">a</span> <span class="o">=</span> <span class="n">att</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Got </span><span class="si">%s</span><span class="s">: &quot;</span><span class="si">%s</span><span class="s">&quot; but expected &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">a</span> <span class="o">==</span> <span class="n">e</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Write data back to file</span>
        <span class="c"># FIXME (Ole): I would like to use gml here, but OGR does not</span>
        <span class="c">#              store the spatial reference! Ticket #18</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wkt</span><span class="p">,</span>
               <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>

        <span class="c"># Read again and check</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">layer</span><span class="o">.</span><span class="n">is_line_data</span>
        <span class="n">geometry_new</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">attributes_new</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry_new</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes_new</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">geometry_new</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>  <span class="c"># OGR works in single precision</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes_new</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attributes_new</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">attributes_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
</div>
    <span class="nd">@numpy.testing.dec.skipif</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">,</span> <span class="s">&#39;Fails in OSX, #198&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="Test_IO.test_i18n"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_i18n">[docs]</a>    <span class="k">def</span> <span class="nf">test_i18n</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test to see if internationalisation is working correctly.</span>
<span class="sd">        Make sure to include this file when using xgettext to scan for</span>
<span class="sd">        translatable strings.</span>
<span class="sd">        .. see:: :doc:`/developer-docs/i18n`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># If you want to modify this code, please get acquainted with</span>
        <span class="c"># Python&#39;s locale module. In particular:</span>
        <span class="c"># http://docs.python.org/library/locale.html#locale.getdefaultlocale</span>

        <span class="c"># Set the standard C locale.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LANG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LC_ALL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;C.UTF-8&#39;</span>

        <span class="c">#must be after above</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">tr</span><span class="p">(</span><span class="s">&#39;Hello!&#39;</span><span class="p">)</span>
        <span class="n">expected1</span> <span class="o">=</span> <span class="s">&#39;Hello!&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%s</span><span class="s">, got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expected1</span><span class="p">,</span> <span class="n">out1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">out1</span> <span class="o">==</span> <span class="n">expected1</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Set the Indonesian locale to test translations.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LANG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LC_ALL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;id_ID.UTF-8&#39;</span>

        <span class="c">#must be after above</span>
        <span class="n">indoout1</span> <span class="o">=</span> <span class="n">tr</span><span class="p">(</span><span class="s">&#39;Hello!&#39;</span><span class="p">)</span>  <span class="c"># translate as &#39;Hi&#39;</span>
        <span class="n">indoexpected1</span> <span class="o">=</span> <span class="s">&#39;Hi!&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%s</span><span class="s">, got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indoexpected1</span><span class="p">,</span> <span class="n">indoout1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">indoout1</span> <span class="o">==</span> <span class="n">indoexpected1</span><span class="p">,</span> <span class="n">msg</span>
</div>
<div class="viewcode-block" id="Test_IO.test_multipart_polygon_can_be_read"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_multipart_polygon_can_be_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_multipart_polygon_can_be_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Multipart polygons are be converted to singlepart</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/boundaries/rw_jakarta.shp&#39;</span> <span class="o">%</span> <span class="n">DATADIR</span><span class="p">)</span>
        <span class="n">L0</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">L0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2685</span>
        <span class="k">assert</span> <span class="n">L0</span><span class="o">.</span><span class="n">is_polygon_data</span>

        <span class="n">geometry</span> <span class="o">=</span> <span class="n">L0</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">L0</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">L0</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">L0</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span>

        <span class="c"># Store temporarily e.g. for inspection with QGIS</span>
        <span class="n">tmp_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span>
               <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
               <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">)</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>

        <span class="c"># Read again</span>
        <span class="n">L1</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">tmp_filename</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">L1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">L0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">L1</span><span class="o">.</span><span class="n">is_polygon_data</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">L0</span><span class="p">)):</span>
            <span class="c"># Check geometry</span>
            <span class="n">g0</span> <span class="o">=</span> <span class="n">L0</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">L1</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">outer_ring</span><span class="p">,</span> <span class="n">g1</span><span class="o">.</span><span class="n">outer_ring</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)):</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">g1</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c"># Check attributes</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">L0</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">L1</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">v0</span> <span class="o">==</span> <span class="n">v1</span>

        <span class="c"># Check projection</span>
        <span class="k">assert</span> <span class="n">L0</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">L1</span><span class="o">.</span><span class="n">projection</span>

        <span class="c"># Compare all</span>
        <span class="k">assert</span> <span class="n">L0</span> <span class="o">==</span> <span class="n">L1</span>
</div>
    <span class="n">test_multipart_polygon_can_be_read</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.test_projection_comparisons"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_projection_comparisons">[docs]</a>    <span class="k">def</span> <span class="nf">test_projection_comparisons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Projection information can be correctly compared</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Although the two test datasets have the same projection,</span>
        <span class="c"># this example failed with the message:</span>
        <span class="c"># The reason was that comparison was done with get_projection()</span>
        <span class="c"># rather than the projection objects themselves.</span>

        <span class="c">#Projections must be the same: I got</span>
        <span class="c">#GEOGCS[&quot;GCS_WGS_1984&quot;,DATUM[&quot;WGS_1984&quot;,</span>
        <span class="c">#       SPHEROID[&quot;WGS_1984&quot;,6378137,298.257223563]],</span>
        <span class="c">#       PRIMEM[&quot;Greenwich&quot;,0],UNIT[&quot;Degree&quot;,0.017453292519943295]] and</span>
        <span class="c">#GEOGCS[&quot;WGS 84&quot;,DATUM[&quot;WGS_1984&quot;,</span>
        <span class="c">#       SPHEROID[&quot;WGS 84&quot;,6378137,298.257223563,</span>
        <span class="c">#       AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]],TOWGS84[0,0,0,0,0,0,0],</span>
        <span class="c">#       AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]],PRIMEM[&quot;Greenwich&quot;,0,</span>
        <span class="c">#       AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]],UNIT[&quot;degree&quot;,0.01745329251994328,</span>
        <span class="c">#       AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]]</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/rw_jakarta_singlepart.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/indonesia_highway_sample.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">Hp</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">projection</span>
        <span class="n">Ep</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">projection</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Projections did not match: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Hp</span><span class="p">,</span> <span class="n">Ep</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">Hp</span> <span class="o">==</span> <span class="n">Ep</span><span class="p">,</span> <span class="n">msg</span>
</div>
    <span class="n">test_projection_comparisons</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Test_IO.Xtest_reading_and_writing_of_multiband_rasters"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.Xtest_reading_and_writing_of_multiband_rasters">[docs]</a>    <span class="k">def</span> <span class="nf">Xtest_reading_and_writing_of_multiband_rasters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Multiband rasters can be read and written correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># FIXME (Ole, Sep 2012): WORK IN PROGRESS</span>
        <span class="n">rastername</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;201208140700_Jakarta_200m_Sobek_Hypothetical_&#39;</span>
                      <span class="s">&#39;Scenario_ACCESSA.nc&#39;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">rastername</span><span class="p">)</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Check consistency of raster</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">A1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Dimensions of raster array do not match those of &#39;</span>
               <span class="s">&#39;raster file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">R1</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">M</span> <span class="o">==</span> <span class="n">R1</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="n">R1</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">msg</span>
        <span class="c"># More...</span>
</div>
<div class="viewcode-block" id="Test_IO.test_compatible_projections"><a class="viewcode-back" href="../../../api-docs/safe/storage/test_io.html#safe.storage.test_io.Test_IO.test_compatible_projections">[docs]</a>    <span class="k">def</span> <span class="nf">test_compatible_projections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Projections that are compatible but not identical are recognised</span>

<span class="sd">        This is a test for issue #304</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read two layers with compatible projections</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/donut.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/pop_merapi_prj_problem.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="c"># Verify that their projection strings are different</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span> <span class="o">!=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_projection</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">!=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="n">proj4</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># But the InaSAFE comparison does pass</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">projection</span> <span class="o">==</span> <span class="n">E</span><span class="o">.</span><span class="n">projection</span>

</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="n">Test_IO</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../../../contents.html">
          <img class="logo" src="../../../_static/icon.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Home</a> &raquo;</li>
    <li><a href="../../../contents.html">Contents</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, BNPB/AIFDR/GFDRR.
      Last updated on Feb 26, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    <!-- cloud_sptheme 1.3 -->
  </body>
</html>