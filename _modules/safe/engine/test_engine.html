


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>safe.engine.test_engine &mdash; InaSAFE 1.0.1-final documentation</title>
    
    <link rel="stylesheet" href="../../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.1-final',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../../_static/toggle_sections.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="InaSAFE 1.0.1-final documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Home</a> &raquo;</li>
    <li><a href="../../../contents.html">Contents</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for safe.engine.test_engine</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>

<span class="c"># Import InaSAFE modules</span>
<span class="kn">from</span> <span class="nn">safe.engine.core</span> <span class="kn">import</span> <span class="n">calculate_impact</span>
<span class="kn">from</span> <span class="nn">safe.engine.interpolation</span> <span class="kn">import</span> <span class="n">interpolate_polygon_raster</span>
<span class="kn">from</span> <span class="nn">safe.engine.interpolation</span> <span class="kn">import</span> <span class="n">interpolate_raster_vector_points</span>
<span class="kn">from</span> <span class="nn">safe.engine.interpolation</span> <span class="kn">import</span> <span class="n">assign_hazard_values_to_exposure_data</span>
<span class="kn">from</span> <span class="nn">safe.engine.interpolation</span> <span class="kn">import</span> <span class="n">tag_polygons_by_grid</span>


<span class="kn">from</span> <span class="nn">safe.storage.core</span> <span class="kn">import</span> <span class="n">read_layer</span>
<span class="kn">from</span> <span class="nn">safe.storage.core</span> <span class="kn">import</span> <span class="n">write_vector_data</span>
<span class="kn">from</span> <span class="nn">safe.storage.core</span> <span class="kn">import</span> <span class="n">write_raster_data</span>
<span class="kn">from</span> <span class="nn">safe.storage.vector</span> <span class="kn">import</span> <span class="n">Vector</span>
<span class="kn">from</span> <span class="nn">safe.storage.utilities</span> <span class="kn">import</span> <span class="n">DEFAULT_ATTRIBUTE</span>

<span class="kn">from</span> <span class="nn">safe.common.polygon</span> <span class="kn">import</span> <span class="n">separate_points_by_polygon</span>
<span class="kn">from</span> <span class="nn">safe.common.polygon</span> <span class="kn">import</span> <span class="n">is_inside_polygon</span><span class="p">,</span> <span class="n">inside_polygon</span>
<span class="kn">from</span> <span class="nn">safe.common.polygon</span> <span class="kn">import</span> <span class="n">clip_lines_by_polygon</span><span class="p">,</span> <span class="n">clip_grid_by_polygons</span>
<span class="kn">from</span> <span class="nn">safe.common.polygon</span> <span class="kn">import</span> <span class="n">line_dictionary_to_geometry</span>
<span class="kn">from</span> <span class="nn">safe.common.interpolation2d</span> <span class="kn">import</span> <span class="n">interpolate_raster</span>
<span class="kn">from</span> <span class="nn">safe.common.numerics</span> <span class="kn">import</span> <span class="n">normal_cdf</span><span class="p">,</span> <span class="n">lognormal_cdf</span><span class="p">,</span> <span class="n">erf</span><span class="p">,</span> <span class="n">ensure_numeric</span>
<span class="kn">from</span> <span class="nn">safe.common.numerics</span> <span class="kn">import</span> <span class="n">nanallclose</span>
<span class="kn">from</span> <span class="nn">safe.common.utilities</span> <span class="kn">import</span> <span class="n">VerificationError</span><span class="p">,</span> <span class="n">unique_filename</span>
<span class="kn">from</span> <span class="nn">safe.common.testing</span> <span class="kn">import</span> <span class="n">TESTDATA</span><span class="p">,</span> <span class="n">HAZDATA</span><span class="p">,</span> <span class="n">EXPDATA</span>
<span class="kn">from</span> <span class="nn">safe.common.exceptions</span> <span class="kn">import</span> <span class="n">InaSAFEError</span>
<span class="kn">from</span> <span class="nn">safe.impact_functions</span> <span class="kn">import</span> <span class="n">get_plugins</span><span class="p">,</span> <span class="n">get_plugin</span>
<span class="kn">from</span> <span class="nn">safe.impact_functions.core</span> <span class="kn">import</span> <span class="n">format_int</span>

<span class="c"># These imports are needed for impact function registration - dont remove</span>
<span class="c"># If any of these get reinstated as &quot;official&quot; public impact functions,</span>
<span class="c"># remove from here and update test to use the real one.</span>
<span class="c"># pylint: disable=W0611</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">empirical_fatality_model</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">allen_fatality_model</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">unspecific_building_impact_model</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">earthquake_impact_on_women</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">NEXIS_building_impact_model</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">HKV_flood_study</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">BNPB_earthquake_guidelines</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">general_ashload_impact</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">flood_road_impact</span>
<span class="kn">from</span> <span class="nn">impact_functions_for_testing</span> <span class="kn">import</span> <span class="n">itb_fatality_model_org</span>
<span class="kn">from</span> <span class="nn">safe.impact_functions.earthquake.pager_earthquake_fatality_model</span> <span class="kn">import</span> <span class="p">(</span>
<span class="n">PAGFatalityFunction</span><span class="p">)</span>
<span class="c"># pylint: enable=W0611</span>


<div class="viewcode-block" id="linear_function"><a class="viewcode-back" href="../../../api-docs/safe/engine/test_engine.html#safe.engine.test_engine.linear_function">[docs]</a><span class="k">def</span> <span class="nf">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Auxiliary function for use with interpolation test</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">/</span> <span class="mf">2.0</span>

</div>
<span class="k">def</span> <span class="nf">lembang_damage_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">6.0</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.692</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span>
                 <span class="mf">15.82</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
                 <span class="mf">135.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
                 <span class="mf">509.0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span>
                 <span class="mf">714.4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<div class="viewcode-block" id="padang_check_results"><a class="viewcode-back" href="../../../api-docs/safe/engine/test_engine.html#safe.engine.test_engine.padang_check_results">[docs]</a><span class="k">def</span> <span class="nf">padang_check_results</span><span class="p">(</span><span class="n">mmi</span><span class="p">,</span> <span class="n">building_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check calculated results through a lookup table</span>
<span class="sd">    returns False if the lookup fails and</span>
<span class="sd">    an exception if more than one lookup returned&quot;&quot;&quot;</span>

    <span class="c"># Reference table established from plugin as of 28 July 2011</span>
    <span class="c"># It was then manually verified against an Excel table by Abbie Baca</span>
    <span class="c"># and Ted Dunstone. Format is</span>
    <span class="c"># MMI, Building class, impact [%]</span>
    <span class="n">padang_verified_results</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">7.50352</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">50.17018</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.49936</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">49.96942</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.63961</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">20.35277</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.09855</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">5.895076</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.49990</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">7.307292</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.80284</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">13.71306</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.66337</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">3.320895</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.12665</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">0.050489</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.12665</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1.013092</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.85400</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">7.521769</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.54040</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">4.657564</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.48122</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">4.167858</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.31694</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">3.008460</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.54057</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">1.349811</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.12753</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">0.177422</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.61912</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">1.866942</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.64828</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">1.518264</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.43644</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.513577</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.12665</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.075070</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.64828</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mf">1.731623</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.48122</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mf">1.191497</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.12665</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mf">0.488944</span><span class="p">]]</span>

    <span class="n">impact_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">verified_impact</span>
        <span class="k">for</span> <span class="n">verified_mmi</span><span class="p">,</span> <span class="n">verified_building_class</span><span class="p">,</span> <span class="n">verified_impact</span>
               <span class="ow">in</span> <span class="n">padang_verified_results</span>
                    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">verified_mmi</span><span class="p">,</span> <span class="n">mmi</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">verified_building_class</span><span class="p">,</span> <span class="n">building_class</span><span class="p">,</span>
                                   <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">impact_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">impact_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">impact_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;More than one lookup result returned. May be precision error.&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">impact_array</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">msg</span>

    <span class="c"># FIXME (Ole): Count how many buildings were damaged in each category?</span>

</div>
<span class="k">class</span> <span class="nc">Test_Engine</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_earthquake_fatality_estimation_allen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fatalities from ground shaking can be computed correctly 1</span>
<span class="sd">           using aligned rasters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Earthquake_Ground_Shaking_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Population_2010_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Earthquake Fatality Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="c"># Call calculation engine</span>
        <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                        <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

        <span class="c"># Do calculation manually and check result</span>
        <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">exposure_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">exposure_raster</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Calculate impact manually</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.97429</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">11.037</span>
        <span class="n">F</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">H</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>

        <span class="c"># Verify correctness of result</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Compare shape and extrema</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Shape of calculated raster differs from reference raster: &#39;</span>
               <span class="s">&#39;C=</span><span class="si">%s</span><span class="s">, F=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Minimum of calculated raster differs from reference raster: &#39;</span>
               <span class="s">&#39;C=</span><span class="si">%s</span><span class="s">, F=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">F</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Maximum of calculated raster differs from reference raster: &#39;</span>
               <span class="s">&#39;C=</span><span class="si">%s</span><span class="s">, F=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">F</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Compare every single value numerically</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Array values of written raster array were not as expected&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Check that extrema are in range</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">C</span> <span class="o">&gt;=</span> <span class="n">xmin</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">C</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">C</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">test_earthquake_fatality_estimation_allen</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_ITB_earthquake_fatality_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fatalities from ground shaking can be computed correctly</span>
<span class="sd">           using the ITB fatality model (Test data from Hadi Ghasemi).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/itb_test_mmi.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/itb_test_pop.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="c">#fatality_filename = &#39;%s/itb_test_fat.asc&#39; % TESTDATA</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;I T B Fatality Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="c"># Call calculation engine</span>
        <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                        <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="n">impact_filename</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">impact_filename</span><span class="p">)</span>
        <span class="c">#calculated_result = I.get_data()</span>
        <span class="c">#print calculated_result.shape</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span>
        <span class="c"># print &quot;keywords&quot;, keywords</span>
        <span class="n">population</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;total_population&#39;</span><span class="p">])</span>
        <span class="n">fatalities</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;total_fatalities&#39;</span><span class="p">])</span>

        <span class="c"># Check aggregated values</span>
        <span class="n">expected_population</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">85424650.</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected population was </span><span class="si">%f</span><span class="s">, I got </span><span class="si">%f</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">expected_population</span><span class="p">,</span> <span class="n">population</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">population</span> <span class="o">==</span> <span class="n">expected_population</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">expected_fatalities</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">40871.3028</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected fatalities was </span><span class="si">%f</span><span class="s">, I got </span><span class="si">%f</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">expected_fatalities</span><span class="p">,</span> <span class="n">fatalities</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fatalities</span><span class="p">,</span> <span class="n">expected_fatalities</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-5</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Check that aggregated number of fatilites is as expected</span>
        <span class="n">all_numbers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mf">31.8937368131</span><span class="p">,</span>
                                     <span class="mf">2539.26369372</span><span class="p">,</span>
                                     <span class="mf">1688.72362573</span><span class="p">,</span>
                                     <span class="mf">17174.9261705</span><span class="p">,</span>
                                     <span class="mf">19436.834531</span><span class="p">]))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Aggregated number of fatalities not as expected: </span><span class="si">%i</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="n">all_numbers</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">all_numbers</span> <span class="o">==</span> <span class="mi">40871</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Did not find expected fatality value </span><span class="si">%i</span><span class="s"> in summary </span><span class="si">%s</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;impact_summary&#39;</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">format_int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;impact_summary&#39;</span><span class="p">],</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">test_pager_earthquake_fatality_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fatalities from ground shaking can be computed correctly</span>
<span class="sd">            using the Pager fatality model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/itb_test_mmi.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/itb_test_pop.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;P A G Fatality Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="c"># Call calculation engine</span>
        <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                        <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="n">impact_filename</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">impact_filename</span><span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span>
        <span class="n">population</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;total_population&#39;</span><span class="p">])</span>
        <span class="n">fatalities</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;total_fatalities&#39;</span><span class="p">])</span>

        <span class="c"># Check aggregated values</span>
        <span class="n">expected_population</span> <span class="o">=</span> <span class="mf">85425000.0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected population was </span><span class="si">%f</span><span class="s">, I got </span><span class="si">%f</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">expected_population</span><span class="p">,</span> <span class="n">population</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">population</span> <span class="o">==</span> <span class="n">expected_population</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">expected_fatalities</span> <span class="o">=</span> <span class="mf">409000.0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected fatalities was </span><span class="si">%f</span><span class="s">, I got </span><span class="si">%f</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">expected_fatalities</span><span class="p">,</span> <span class="n">fatalities</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fatalities</span><span class="p">,</span> <span class="n">expected_fatalities</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-5</span><span class="p">),</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">test_ITB_earthquake_fatality_estimation_org</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fatalities from ground shaking can be computed correctly</span>
<span class="sd">           using the ITB fatality model (Test data from Hadi Ghasemi).</span>

<span class="sd">           This function is using the original implementation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/itb_test_mmi.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/itb_test_pop.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">fatality_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/itb_test_fat.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;I T B Fatality Function Org&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="c"># Call calculation engine</span>
        <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                        <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="n">impact_filename</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">impact_filename</span><span class="p">)</span>
        <span class="n">calculated_result</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="c">#        print calculated_result.shape</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span>
<span class="c">#        print &quot;keywords&quot;, keywords</span>
        <span class="n">population</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;total_population&#39;</span><span class="p">])</span>
        <span class="n">fatalities</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;total_fatalities&#39;</span><span class="p">])</span>

        <span class="c"># Check aggregated values</span>
        <span class="n">expected_population</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">85424650.</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected population was </span><span class="si">%f</span><span class="s">, I got </span><span class="si">%f</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">expected_population</span><span class="p">,</span> <span class="n">population</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">population</span> <span class="o">==</span> <span class="n">expected_population</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">expected_fatalities</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">40871.3028</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected fatalities was </span><span class="si">%f</span><span class="s">, I got </span><span class="si">%f</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="p">(</span><span class="n">expected_fatalities</span><span class="p">,</span> <span class="n">fatalities</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fatalities</span><span class="p">,</span> <span class="n">expected_fatalities</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-5</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Compare with reference data</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">fatality_filename</span><span class="p">)</span>
        <span class="n">fatality_result</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated fatality map did not match expected result: &#39;</span>
               <span class="s">&#39;I got </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span>
               <span class="s">&#39;Expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calculated_result</span><span class="p">,</span> <span class="n">fatality_result</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">calculated_result</span><span class="p">,</span> <span class="n">fatality_result</span><span class="p">,</span>
                           <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-4</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Check for expected numbers (from Hadi Ghasemi) in keywords</span>
        <span class="c"># NOTE: Commented out because function no longer needs to return</span>
        <span class="c"># individual exposure numbers.</span>
        <span class="k">for</span> <span class="n">population_count</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">2649040.0</span><span class="p">,</span> <span class="mf">50273440.0</span><span class="p">,</span> <span class="mf">7969610.0</span><span class="p">,</span>
                                 <span class="mf">19320620.0</span><span class="p">,</span> <span class="mf">5211940.0</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">population_count</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="ow">in</span> \
                <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;impact_summary&#39;</span><span class="p">]</span>

        <span class="c"># Check that aggregated number of fatilites is as expected</span>
        <span class="n">all_numbers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mf">31.8937368131</span><span class="p">,</span>
                                     <span class="mf">2539.26369372</span><span class="p">,</span>
                                     <span class="mf">1688.72362573</span><span class="p">,</span>
                                     <span class="mf">17174.9261705</span><span class="p">,</span>
                                     <span class="mf">19436.834531</span><span class="p">]))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Aggregated number of fatalities not as expected: </span><span class="si">%i</span><span class="s">&#39;</span>
               <span class="o">%</span> <span class="n">all_numbers</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">all_numbers</span> <span class="o">==</span> <span class="mi">40871</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find expected fatality value </span><span class="si">%i</span><span class="s"> in summary&#39;</span> <span class="o">%</span> <span class="n">x</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;impact_summary&#39;</span><span class="p">],</span> <span class="n">msg</span>

        <span class="k">for</span> <span class="n">fatality_count</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">31.8937368131</span><span class="p">,</span> <span class="mf">2539.26369372</span><span class="p">,</span>
                               <span class="mf">1688.72362573</span><span class="p">,</span> <span class="mf">17174.9261705</span><span class="p">,</span> <span class="mf">19436.834531</span><span class="p">]:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fatality_count</span><span class="p">))</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;impact_summary&#39;</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%s</span><span class="s"> in impact_summary: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">,</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">test_earthquake_fatality_estimation_ghasemi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fatalities from ground shaking can be computed correctly 2</span>
<span class="sd">           using the Hadi Ghasemi function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># FIXME (Ole): Maybe this is no longer relevant (20120501)</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Earthquake_Ground_Shaking_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Population_2010_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Empirical Fatality Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="c"># Call calculation engine</span>
        <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                        <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

        <span class="c"># Do calculation manually and check result</span>
        <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">exposure_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">exposure_raster</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Verify correctness of result</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">263</span><span class="p">,</span> <span class="mi">345</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Shape of calculated raster not as expected: &#39;</span>
               <span class="s">&#39;C=</span><span class="si">%s</span><span class="s">, expected=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">expected_shape</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">expected_shape</span><span class="p">,</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Calculate impact manually</span>
        <span class="c"># FIXME (Ole): Jono will do this</span>

        <span class="c"># # Compare shape and extrema</span>
        <span class="c"># msg = (&#39;Shape of calculated raster differs from reference raster: &#39;</span>
        <span class="c">#        &#39;C=%s, F=%s&#39; % (C.shape, F.shape))</span>
        <span class="c"># assert numpy.allclose(C.shape, F.shape, rtol=1e-12, atol=1e-12), msg</span>

        <span class="c"># msg = (&#39;Minimum of calculated raster differs from reference raster: &#39;</span>
        <span class="c">#        &#39;C=%s, F=%s&#39; % (numpy.min(C), numpy.min(F)))</span>
        <span class="c"># assert numpy.allclose(numpy.min(C), numpy.min(F),</span>
        <span class="c">#                       rtol=1e-12, atol=1e-12), msg</span>
        <span class="c"># msg = (&#39;Maximum of calculated raster differs from reference raster: &#39;</span>
        <span class="c">#        &#39;C=%s, F=%s&#39; % (numpy.max(C), numpy.max(F)))</span>
        <span class="c"># assert numpy.allclose(numpy.max(C), numpy.max(F),</span>
        <span class="c">#                       rtol=1e-12, atol=1e-12), msg</span>

        <span class="c"># # Compare every single value numerically</span>
        <span class="c"># msg = &#39;Array values of written raster array were not as expected&#39;</span>
        <span class="c"># assert numpy.allclose(C, F, rtol=1e-12, atol=1e-12), msg</span>

        <span class="c"># # Check that extrema are in range</span>
        <span class="c"># xmin, xmax = impact_layer.get_extrema()</span>
        <span class="c"># assert numpy.alltrue(C &gt;= xmin)</span>
        <span class="c"># assert numpy.alltrue(C &lt;= xmax)</span>
        <span class="c"># assert numpy.alltrue(C &gt;= 0)</span>

    <span class="n">test_earthquake_fatality_estimation_ghasemi</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_earthquake_impact_on_women_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Earthquake impact on women example works</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># This only tests that the function runs and has the right</span>
        <span class="c"># strings in the output. No test of quantitative numbers</span>
        <span class="c"># (because we can&#39;t).</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Earthquake_Ground_Shaking_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Population_2010_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Earthquake Women Impact Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="c"># Call calculation engine</span>
        <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                        <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="n">impact_filename</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>

        <span class="n">read_layer</span><span class="p">(</span><span class="n">impact_filename</span><span class="p">)</span>  <span class="c"># Can read result</span>

        <span class="k">assert</span> <span class="s">&#39;women displaced&#39;</span> <span class="ow">in</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_impact_summary</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s">&#39;pregnant&#39;</span> <span class="ow">in</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_impact_summary</span><span class="p">()</span>

    <span class="n">test_earthquake_impact_on_women_example</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_jakarta_flood_study</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;HKV Jakarta flood study calculated correctly using aligned rasters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># FIXME (Ole): Redo with population as shapefile later</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>

        <span class="n">population</span> <span class="o">=</span> <span class="s">&#39;Population_Jakarta_geographic.asc&#39;</span>
        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;HKVtest&#39;</span>

        <span class="c"># Expected values from HKV</span>
        <span class="n">expected_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2485442</span><span class="p">,</span> <span class="mi">1537920</span><span class="p">]</span>
        <span class="n">expected_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">format_int</span><span class="p">(</span><span class="mi">2480</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&lt;/b&gt;&#39;</span><span class="p">,</span>
                            <span class="s">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">format_int</span><span class="p">(</span><span class="mi">1533</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&lt;/b&gt;&#39;</span><span class="p">]</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Flood_Current_Depth_Jakarta_geographic.asc&#39;</span><span class="p">,</span>
                         <span class="s">&#39;Flood_Design_Depth_Jakarta_geographic.asc&#39;</span><span class="p">]:</span>

            <span class="n">hazard_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">exposure_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">population</span><span class="p">)</span>

            <span class="c"># Get layers using API</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

            <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

            <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>
            <span class="c"># Call impact calculation engine</span>
            <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                            <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
            <span class="n">impact_filename</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>

            <span class="c"># Do calculation manually and check result</span>
            <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">exposure_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">exposure_raster</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># Calculate impact manually</span>
            <span class="n">pixel_area</span> <span class="o">=</span> <span class="mi">2500</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">H</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100000.0</span> <span class="o">*</span> <span class="n">pixel_area</span>

            <span class="c"># Verify correctness against results from HKV</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">expected_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c">#print filename, &#39;Result=%f&#39; % res, &#39; Expected=%f&#39; % ref</span>
            <span class="c">#print &#39;Pct relative error=%f&#39; % (abs(res-ref)*100./ref)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Got result </span><span class="si">%f</span><span class="s"> but expected </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-2</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c"># Verify correctness of result</span>
            <span class="n">calculated_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">impact_filename</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">calculated_raster</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># Check impact_summary</span>
            <span class="n">impact_summary</span> <span class="o">=</span> <span class="n">calculated_raster</span><span class="o">.</span><span class="n">get_impact_summary</span><span class="p">()</span>
            <span class="n">expct</span> <span class="o">=</span> <span class="n">expected_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c"># Number of people affected (HTML)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;impact_summary </span><span class="si">%s</span><span class="s"> did not contain expected &#39;</span>
                   <span class="s">&#39;string </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">impact_summary</span><span class="p">,</span> <span class="n">expct</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">expct</span> <span class="ow">in</span> <span class="n">impact_summary</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Compare shape and extrema</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Shape of calculated raster differs from reference raster: &#39;</span>
                   <span class="s">&#39;C=</span><span class="si">%s</span><span class="s">, I=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                  <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Minimum of calculated raster differs from reference &#39;</span>
                   <span class="s">&#39;raster: &#39;</span>
                   <span class="s">&#39;C=</span><span class="si">%s</span><span class="s">, I=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">I</span><span class="p">)))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">I</span><span class="p">),</span>
                                  <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Maximum of calculated raster differs from reference &#39;</span>
                   <span class="s">&#39;raster: &#39;</span>
                   <span class="s">&#39;C=</span><span class="si">%s</span><span class="s">, I=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I</span><span class="p">)))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I</span><span class="p">),</span>
                                  <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c"># Compare every single value numerically</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Array values of written raster array were not as expected&#39;</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c"># Check that extrema are in range</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">calculated_raster</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">C</span> <span class="o">&gt;=</span> <span class="n">xmin</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">C</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">C</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">test_jakarta_flood_study</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_volcano_population_evacuation_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Population impact from volcanic hazard is computed correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/donut.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/pop_merapi_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="c"># Slow</span>
        <span class="c"># FIXME (Ole): Results are different - check!</span>
        <span class="c">#exposure_filename = (&#39;%s/population_indonesia_2010_BNPB_BPS.asc&#39;</span>
        <span class="c">#                     % EXPDATA)</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Volcano Polygon Hazard Population&#39;</span>
        <span class="n">IF</span> <span class="o">=</span> <span class="n">get_plugin</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;Calculating&#39;</span>
        <span class="c"># Call calculation engine</span>
        <span class="n">impact_layer</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                        <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="n">impact_filename</span> <span class="o">=</span> <span class="n">impact_layer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">impact_filename</span><span class="p">)</span>

        <span class="n">keywords</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()</span>

        <span class="c"># Check for expected results:</span>
        <span class="c">#for value in [&#39;Merapi&#39;, 192055, 56514, 68568, 66971]:</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Merapi&#39;</span><span class="p">,</span> <span class="mi">190000</span><span class="p">,</span> <span class="mi">56000</span><span class="p">,</span> <span class="mi">66000</span><span class="p">,</span> <span class="mi">68000</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">format_int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;impact_summary&#39;</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Did not find expected value </span><span class="si">%s</span><span class="s"> in summary </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">summary</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># FIXME (Ole): Should also have test for concentric circle</span>
        <span class="c">#              evacuation zones</span>

    <span class="n">test_volcano_population_evacuation_impact</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># This one currently fails because the clipped input data has</span>
    <span class="c"># different resolution to the full data. Issue #344</span>
    <span class="c">#</span>
    <span class="c"># This test is not finished, but must wait &#39;till #344 has been sorted</span>
    <span class="nd">@unittest.expectedFailure</span>
    <span class="k">def</span> <span class="nf">test_polygon_hazard_raster_exposure_clipped_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rasters clipped by polygons irrespective of pre-clipping</span>

<span class="sd">        Double check that a raster clipped by the QGIS front-end</span>
<span class="sd">        produces the same results as when full raster is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read test files</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/donut.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename_clip</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/pop_merapi_clip.tif&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename_full</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/pop_merapi_prj_problem.asc&#39;</span>
                                  <span class="o">%</span> <span class="n">EXPDATA</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E_clip</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename_clip</span><span class="p">)</span>
        <span class="n">E_full</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename_full</span><span class="p">)</span>

        <span class="c"># Establish whether full and clipped grids coincide</span>
        <span class="c"># in clipped area</span>
        <span class="n">gt_clip</span> <span class="o">=</span> <span class="n">E_clip</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">()</span>
        <span class="n">gt_full</span> <span class="o">=</span> <span class="n">E_full</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">()</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Resolutions were different. Geotransform full grid: </span><span class="si">%s</span><span class="s">, &#39;</span>
               <span class="s">&#39;clipped grid: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gt_full</span><span class="p">,</span> <span class="n">gt_clip</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">gt_clip</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gt_full</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">gt_clip</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">gt_full</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">msg</span>

        <span class="n">polygons</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Clip</span>
        <span class="n">res_clip</span> <span class="o">=</span> <span class="n">clip_grid_by_polygons</span><span class="p">(</span><span class="n">E_clip</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
                                         <span class="n">E_clip</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span>
                                         <span class="n">polygons</span><span class="p">)</span>

        <span class="c">#print res_clip</span>
        <span class="c">#print len(res_clip)</span>

        <span class="n">res_full</span> <span class="o">=</span> <span class="n">clip_grid_by_polygons</span><span class="p">(</span><span class="n">E_full</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
                                         <span class="n">E_full</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span>
                                         <span class="n">polygons</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_clip</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_full</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_clip</span><span class="p">)):</span>
            <span class="c">#print</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">res_clip</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">res_full</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c">#print x</span>
            <span class="c">#print y</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Got len(x) == </span><span class="si">%i</span><span class="s">, len(y) == </span><span class="si">%i</span><span class="s">. Should be the same&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c"># Check that they are inside the respective polygon</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">inside_polygon</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>  <span class="c"># pylint: disable=W0612</span>
                                 <span class="n">P</span><span class="o">.</span><span class="n">outer_ring</span><span class="p">,</span>
                                 <span class="n">holes</span><span class="o">=</span><span class="n">P</span><span class="o">.</span><span class="n">inner_rings</span><span class="p">)</span>
            <span class="c">#print idx</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected point locations to be the same in clipped &#39;</span>
                   <span class="s">&#39;and full grids, Got </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_polygon_hazard_and_raster_exposure_big</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rasters can be converted to points and clipped by polygons</span>

<span class="sd">        This is a test for the basic machinery needed for issue #91</span>

<span class="sd">        It uses over 400,000 gridpoints and 2704 complex polygons,</span>
<span class="sd">        each with 10-200 vertices, and serves a test for optimising</span>
<span class="sd">        the polygon clipping algorithm. With the optimisations requested</span>
<span class="sd">        in https://github.com/AIFDR/inasafe/issues/222 it takes about 100</span>
<span class="sd">        seconds on a good workstation while it takes over 2000 seconds</span>
<span class="sd">        without it.</span>

<span class="sd">        This test also runs the high level interpolation routine which assigns</span>
<span class="sd">        attributes to the new point layer. The runtime is virtually the same as</span>
<span class="sd">        the underlying function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name input files</span>
        <span class="n">polyhazard</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;rw_jakarta_singlepart.shp&#39;</span><span class="p">)</span>
        <span class="n">population</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;Population_Jakarta_geographic.asc&#39;</span><span class="p">)</span>

        <span class="c"># Get layers using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">polyhazard</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">2704</span>

        <span class="c"># Run and test the fundamental clipping routine</span>
        <span class="c">#import time</span>
        <span class="c">#t0 = time.time()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">clip_grid_by_polygons</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
                                    <span class="n">E</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span>
                                    <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="c">#print &#39;Engine took %i seconds&#39; % (time.time() - t0)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>

        <span class="c"># Characterisation test</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;RW&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;RW 01&#39;</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;KAB_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;JAKARTA UTARA&#39;</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;KEC_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;TANJUNG PRIOK&#39;</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;KEL_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;KEBON BAWANG&#39;</span>

        <span class="n">geom</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="mf">1481.98</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geom</span><span class="p">[</span><span class="mi">17</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">106.88746869</span><span class="p">)</span>  <span class="c"># LON</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geom</span><span class="p">[</span><span class="mi">17</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">6.11493812</span><span class="p">)</span>  <span class="c"># LAT</span>

        <span class="c"># Then run and test the high level interpolation function</span>
        <span class="c">#t0 = time.time()</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">interpolate_polygon_raster</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                       <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;poly2raster_test&#39;</span><span class="p">,</span>
                                       <span class="n">attribute_name</span><span class="o">=</span><span class="s">&#39;grid_value&#39;</span><span class="p">)</span>
        <span class="c">#print &#39;High level function took %i seconds&#39; % (time.time() - t0)</span>
        <span class="c">#P.write_to_file(&#39;polygon_raster_interpolation_example_big.shp&#39;)</span>

        <span class="c"># Characterisation tests (values verified using QGIS)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">17</span><span class="p">]</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="mi">17</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;RW&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;RW 01&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KAB_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;JAKARTA UTARA&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KEC_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;TANJUNG PRIOK&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KEL_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;KEBON BAWANG&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">1481.984</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">106.88746869</span><span class="p">)</span>  <span class="c"># LON</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">6.11493812</span><span class="p">)</span>  <span class="c"># LAT</span>

        <span class="c"># A second characterisation test</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">10000</span><span class="p">]</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="mi">10000</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;RW&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;RW 06&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KAB_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;JAKARTA UTARA&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KEC_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;PENJARINGAN&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KEL_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;KAMAL MUARA&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">93</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">715.6508</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">106.74092731</span><span class="p">)</span>  <span class="c"># LON</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">6.1081538</span><span class="p">)</span>  <span class="c"># LAT</span>

        <span class="c"># A third characterisation test</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">99000</span><span class="p">]</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()[</span><span class="mi">99000</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;RW&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;RW 08&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KAB_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;JAKARTA TIMUR&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KEC_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CAKUNG&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KEL_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CAKUNG TIMUR&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">927</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">770.7628</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">106.9675237</span><span class="p">)</span>  <span class="c"># LON</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">6.16966499</span><span class="p">)</span>  <span class="c"># LAT</span>

    <span class="n">test_polygon_hazard_and_raster_exposure_big</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_polygon_hazard_and_raster_exposure_small</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exposure rasters can be clipped by polygon exposure</span>

<span class="sd">        This is a test for the basic machinery needed for issue #91</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name input files</span>
        <span class="n">polyhazard</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;test_polygon_on_test_grid.shp&#39;</span><span class="p">)</span>
        <span class="n">population</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;test_grid.asc&#39;</span><span class="p">)</span>

        <span class="c"># Get layers using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">polyhazard</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">4</span>

        <span class="c"># Run underlying clipping routine</span>
        <span class="n">res0</span> <span class="o">=</span> <span class="n">clip_grid_by_polygons</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
                                     <span class="n">E</span><span class="o">.</span><span class="n">get_geotransform</span><span class="p">(),</span>
                                     <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">(</span><span class="n">as_geometry_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res0</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>

        <span class="c"># Run higher level interpolation routine</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">interpolate_polygon_raster</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                       <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;poly2raster_test&#39;</span><span class="p">,</span>
                                       <span class="n">attribute_name</span><span class="o">=</span><span class="s">&#39;grid_value&#39;</span><span class="p">)</span>

        <span class="c"># Verify result (numbers obtained from using QGIS)</span>
        <span class="c">#P.write_to_file(&#39;poly2raster_test.shp&#39;)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="c"># Polygon 0</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">31415</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">50.8147</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">96.97137053</span><span class="p">)</span>  <span class="c"># Lon</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">5.349657148</span><span class="p">)</span>  <span class="c"># Lat</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">31415</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">31415</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">50.127</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c"># Polygon 1</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;B&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">13</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;B&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">13</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;B&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">97.063559372</span><span class="p">)</span>  <span class="c"># Lon</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">5.472621404</span><span class="p">)</span>  <span class="c"># Lat</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">13</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">50.8258</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c"># Polygon 2 (overlapping)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Intersecting&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">50.9574</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">21</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">21</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Intersecting&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">21</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">21</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">50.2238</span><span class="p">)</span>

        <span class="c"># Polygon 3</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;D&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">97.0021116</span><span class="p">)</span>  <span class="c"># Lon</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">5.503362468</span><span class="p">)</span>  <span class="c"># Lat</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">50</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="s">&#39;grid_value&#39;</span><span class="p">],</span> <span class="mf">50.0377</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="mi">23</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">test_tagging_polygons_by_raster_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Polygons can be tagged by raster values</span>

<span class="sd">        This is testing a simple application of clip_grid_by_polygons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name input files</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;test_polygon_on_test_grid.shp&#39;</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;test_grid.asc&#39;</span><span class="p">)</span>

        <span class="c"># Get layers using API</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

        <span class="c"># Run tagging routine</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">tag_polygons_by_grid</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">50.85</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s">&#39;tag&#39;</span> <span class="ow">in</span> <span class="n">d</span>

        <span class="c"># Check against inspection with QGIS. Only polygon 1 and 2</span>
        <span class="c"># contain grid points with values greater than 50.85</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">test_polygon_hazard_with_holes_and_raster_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rasters can be clipped by polygons (with holes)</span>

<span class="sd">        This is testing that a collection of polygons - some with holes -</span>
<span class="sd">        can correctly clip and tag raster points.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name input files</span>
        <span class="n">polyhazard</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;donut.shp&#39;</span><span class="p">)</span>
        <span class="n">population</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;pop_merapi_clip.tif&#39;</span><span class="p">)</span>

        <span class="c"># Get layers using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">polyhazard</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">10</span>

        <span class="c"># Characterisation test</span>
        <span class="k">assert</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">9</span><span class="p">][</span><span class="s">&#39;KRB&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Kawasan Rawan Bencana II&#39;</span>

        <span class="c"># Then run and test the high level interpolation function</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">interpolate_polygon_raster</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                       <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;poly2raster_test&#39;</span><span class="p">,</span>
                                       <span class="n">attribute_name</span><span class="o">=</span><span class="s">&#39;grid_value&#39;</span><span class="p">)</span>

        <span class="c"># Possibly write result to file for visual inspection, e.g. with QGIS</span>
        <span class="c">#P.write_to_file(&#39;polygon_raster_interpolation_example_holes.shp&#39;)</span>

        <span class="c"># Characterisation tests (values verified using QGIS)</span>
        <span class="c"># In internal polygon</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">43</span><span class="p">]</span>
        <span class="c">#geometry = P.get_geometry()[43]</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KRB&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Kawasan Rawan Bencana III&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span>

        <span class="c"># In polygon ring</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">222</span><span class="p">]</span>
        <span class="c">#geometry = P.get_geometry()[222]</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KRB&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Kawasan Rawan Bencana II&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span>

        <span class="c"># In one of the outer polygons</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">26</span><span class="p">]</span>
        <span class="c">#geometry = P.get_geometry()[26]</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;KRB&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Kawasan Rawan Bencana I&#39;</span>
        <span class="k">assert</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>

    <span class="n">test_polygon_hazard_with_holes_and_raster_exposure</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_flood_building_impact_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flood building impact function works</span>

<span class="sd">        This test also exercises interpolation of hazard level (raster) to</span>
<span class="sd">        building locations (vector data).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">haz_filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Flood_Current_Depth_Jakarta_geographic.asc&#39;</span><span class="p">,</span>
                             <span class="s">&#39;Flood_Design_Depth_Jakarta_geographic.asc&#39;</span><span class="p">]:</span>

            <span class="c"># Name file names for hazard level and exposure</span>
            <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="n">haz_filename</span><span class="p">)</span>
            <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/OSM_building_polygons_20110905.shp&#39;</span>
                                 <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

            <span class="c"># Calculate impact using API</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

            <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;FloodBuildingImpactFunction&#39;</span>
            <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

            <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

            <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                             <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

            <span class="c"># Extract calculated result</span>
            <span class="n">icoordinates</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">iattributes</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Check</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">icoordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">34960</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">iattributes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">34960</span>

            <span class="c"># FIXME (Ole): check more numbers</span>

    <span class="n">test_flood_building_impact_function</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_data_sources_are_carried_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Data sources are carried forward to impact layer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">haz_filename</span> <span class="o">=</span> <span class="s">&#39;Flood_Current_Depth_Jakarta_geographic.asc&#39;</span>

        <span class="c"># File names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="n">haz_filename</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/OSM_building_polygons_20110905.shp&#39;</span>
                             <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">H_tit</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
        <span class="n">E_tit</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>

        <span class="n">H_src</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;source&#39;</span><span class="p">]</span>
        <span class="n">E_src</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;source&#39;</span><span class="p">]</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;FloodBuildingImpactFunction&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                         <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;hazard_title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">H_tit</span>
        <span class="k">assert</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;exposure_title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_tit</span>
        <span class="k">assert</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;hazard_source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">H_src</span>
        <span class="k">assert</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_keywords</span><span class="p">()[</span><span class="s">&#39;exposure_source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_src</span>

    <span class="n">test_data_sources_are_carried_forward</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_earthquake_damage_schools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lembang building damage from ground shaking works</span>

<span class="sd">        This test also exercises interpolation of hazard level (raster) to</span>
<span class="sd">        building locations (vector data).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">exp_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_buildings.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="k">for</span> <span class="n">haz_filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;lembang_mmi_hazmap.asc&#39;</span><span class="p">),</span>
                             <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span>   <span class="c"># NaN&#39;s</span>
                                  <span class="s">&#39;Earthquake_Ground_Shaking_clip.tif&#39;</span><span class="p">),</span>
                             <span class="n">join</span><span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="s">&#39;Lembang_Earthquake_Scenario.asc&#39;</span><span class="p">)]:</span>

            <span class="c"># Calculate impact using API</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">haz_filename</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exp_filename</span><span class="p">)</span>

            <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Earthquake Building Damage Function&#39;</span>
            <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

            <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

            <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                             <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

            <span class="c"># Read input data</span>
            <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">haz_filename</span><span class="p">)</span>
            <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

            <span class="c"># Extract calculated result</span>
            <span class="n">icoordinates</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">iattributes</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># First check that interpolated MMI was done as expected</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_buildings_percentage_loss_and_mmi.txt&#39;</span>
                       <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
            <span class="n">reference_points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">MMI</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">DAM</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

                <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">mmi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dam</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">reference_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))</span>
                <span class="n">MMI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mmi</span><span class="p">)</span>
                <span class="n">DAM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dam</span><span class="p">)</span>

            <span class="c"># Verify that coordinates are consistent</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Interpolated coordinates do not match those of test data&#39;</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">icoordinates</span><span class="p">,</span> <span class="n">reference_points</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c"># Verify interpolated MMI with test result</span>
            <span class="n">min_damage</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxint</span>
            <span class="n">max_damage</span> <span class="o">=</span> <span class="o">-</span><span class="n">min_damage</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MMI</span><span class="p">)):</span>
                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">icoordinates</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span>
                <span class="n">calculated_mmi</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;MMI&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">calculated_mmi</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c"># Check that interpolated points are within range</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Interpolated mmi </span><span class="si">%f</span><span class="s"> from file </span><span class="si">%s</span><span class="s"> was outside &#39;</span>
                       <span class="s">&#39;extrema: [</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">] at location &#39;</span>
                       <span class="s">&#39;[</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">].&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span> <span class="n">haz_filename</span><span class="p">,</span>
                                      <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">mmi_min</span> <span class="o">&lt;=</span> <span class="n">calculated_mmi</span> <span class="o">&lt;=</span> <span class="n">mmi_max</span><span class="p">,</span> <span class="n">msg</span>

                <span class="c"># Set up some tolerances for comparison with test set.</span>
                <span class="k">if</span> <span class="s">&#39;Lembang_Earthquake&#39;</span> <span class="ow">in</span> <span class="n">haz_filename</span><span class="p">:</span>
                    <span class="n">pct</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pct</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="c"># Check that interpolated result is within specified tolerance</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated MMI </span><span class="si">%f</span><span class="s"> deviated more than </span><span class="si">%.1f%%</span><span class="s"> from &#39;</span>
                       <span class="s">&#39;what was expected </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">MMI</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span> <span class="n">MMI</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                      <span class="n">rtol</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">pct</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="n">msg</span>

                <span class="n">calculated_dam</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;DAMAGE&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">calculated_dam</span> <span class="o">&gt;</span> <span class="n">max_damage</span><span class="p">:</span>
                    <span class="n">max_damage</span> <span class="o">=</span> <span class="n">calculated_dam</span>

                <span class="k">if</span> <span class="n">calculated_dam</span> <span class="o">&lt;</span> <span class="n">min_damage</span><span class="p">:</span>
                    <span class="n">min_damage</span> <span class="o">=</span> <span class="n">calculated_dam</span>

                <span class="n">ref_dam</span> <span class="o">=</span> <span class="n">lembang_damage_function</span><span class="p">(</span><span class="n">calculated_mmi</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated damage was not as expected&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">calculated_dam</span><span class="p">,</span> <span class="n">ref_dam</span><span class="p">,</span>
                                      <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

                <span class="c"># Test that test data is correct by calculating damage based</span>
                <span class="c"># on reference MMI.</span>
                <span class="c"># FIXME (Ole): UNCOMMENT WHEN WE GET THE CORRECT DATASET</span>
                <span class="c">#expected_test_damage = lembang_damage_function(MMI[i])</span>
                <span class="c">#msg = (&#39;Test data is inconsistent: i = %i, MMI = %f,&#39;</span>
                <span class="c">#       &#39;expected_test_damage = %f, &#39;</span>
                <span class="c">#       &#39;actual_test_damage = %f&#39; % (i, MMI[i],</span>
                <span class="c">#                                    expected_test_damage,</span>
                <span class="c">#                                    DAM[i]))</span>
                <span class="c">#if not numpy.allclose(expected_test_damage,</span>
                <span class="c">#                      DAM[i], rtol=1.0e-12):</span>
                <span class="c">#    print msg</span>

                <span class="c"># Note this test doesn&#39;t work, but the question is whether the</span>
                <span class="c"># independent test data is correct.</span>
                <span class="c"># Also small fluctuations in MMI can cause very large changes</span>
                <span class="c"># in computed damage for this example.</span>
                <span class="c"># print mmi, MMI[i], calculated_damage, DAM[i]</span>
                <span class="c">#msg = (&#39;Calculated damage was not as expected for point %i:&#39;</span>
                <span class="c">#       &#39;Got %f, expected %f&#39; % (i, calculated_dam, DAM[i]))</span>
                <span class="c">#assert numpy.allclose(calculated_dam, DAM[i], rtol=0.8), msg</span>

            <span class="k">assert</span> <span class="n">min_damage</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="n">max_damage</span> <span class="o">&lt;=</span> <span class="mi">100</span>
            <span class="c">#print &#39;Extrema&#39;, mmi_filename, min_damage, max_damage</span>
            <span class="c">#print len(MMI)</span>

    <span class="n">test_earthquake_damage_schools</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_earthquake_impact_OSM_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Earthquake layer interpolation to OSM building data works</span>

<span class="sd">        The impact function used is based on the guidelines plugin</span>

<span class="sd">        This test also exercises interpolation of hazard level (raster) to</span>
<span class="sd">        building locations (vector data).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># FIXME: Still needs some reference data to compare to</span>
        <span class="k">for</span> <span class="n">mmi_filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Shakemap_Padang_2009.asc&#39;</span><span class="p">,</span>
                             <span class="c"># Time consuming</span>
                             <span class="c">#&#39;Earthquake_Ground_Shaking.asc&#39;,</span>
                             <span class="s">&#39;Lembang_Earthquake_Scenario.asc&#39;</span><span class="p">]:</span>

            <span class="c"># Name file names for hazard level and exposure</span>
            <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="n">mmi_filename</span><span class="p">)</span>
            <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/OSM_building_polygons_20110905.shp&#39;</span>
                                 <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

            <span class="c"># Calculate impact using API</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

            <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Earthquake Guidelines Function&#39;</span>
            <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

            <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>
            <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                             <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

            <span class="c"># Read input data</span>
            <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

            <span class="c"># Extract calculated result</span>
            <span class="n">iattributes</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Verify interpolated MMI with test result</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iattributes</span><span class="p">)):</span>
                <span class="n">calculated_mmi</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;MMI&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">calculated_mmi</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c"># Check that interpolated points are within range</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Interpolated mmi </span><span class="si">%f</span><span class="s"> from file </span><span class="si">%s</span><span class="s"> was outside &#39;</span>
                       <span class="s">&#39;extrema: [</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">] at point </span><span class="si">%i</span><span class="s"> &#39;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span> <span class="n">hazard_filename</span><span class="p">,</span>
                          <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">mmi_min</span> <span class="o">&lt;=</span> <span class="n">calculated_mmi</span> <span class="o">&lt;=</span> <span class="n">mmi_max</span><span class="p">,</span> <span class="n">msg</span>

                <span class="n">calculated_dam</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;DMGLEVEL&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">calculated_dam</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="n">test_earthquake_impact_OSM_data</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_tsunami_loss_use_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Building loss from tsunami use case works</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># This test merely exercises the use case as there is</span>
        <span class="c"># no reference data. It does check the sanity of values as</span>
        <span class="c"># far as possible.</span>

        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_max_inundation_depth_4326.tif&#39;</span>
                            <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_building_exposure.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_with_depth_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_building_exposure&#39;</span>
                                        <span class="s">&#39;.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">reference_impact_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_building_assessment&#39;</span>
                                     <span class="s">&#39;.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="c"># Check hazard data</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20855</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">A</span><span class="p">))</span> <span class="o">==</span> <span class="mi">8547</span>

        <span class="c"># Do interpolation using underlying library</span>
        <span class="c"># This was to debug this test failing under Windows</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;Tsunami Ma&#39;</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">interpolate_raster_vector_points</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> not found in field list:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
            <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">feature</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">150.1787</span> <span class="ow">and</span>
                <span class="n">feature</span><span class="p">[</span><span class="s">&#39;LATITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">35.70413</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">150.1793</span> <span class="ow">and</span>
                  <span class="n">feature</span><span class="p">[</span><span class="s">&#39;LATITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">35.70632</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">150.18208</span> <span class="ow">and</span>
                  <span class="n">feature</span><span class="p">[</span><span class="s">&#39;LATITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">35.70996</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">150.18664</span> <span class="ow">and</span>
                  <span class="n">feature</span><span class="p">[</span><span class="s">&#39;LATITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">35.70253</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s">&#39;LONGITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">150.18487</span> <span class="ow">and</span>
                  <span class="n">feature</span><span class="p">[</span><span class="s">&#39;LATITUDE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">35.70561</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="c"># Run main test</span>
        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Tsunami Building Loss Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>
        <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                         <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="n">impact_filename</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
        <span class="c"># Read calculated result</span>
        <span class="c"># Read to have truncation</span>
        <span class="n">my_impact_vector</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">impact_filename</span><span class="p">)</span>
        <span class="n">icoordinates</span> <span class="o">=</span> <span class="n">my_impact_vector</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">iattributes</span> <span class="o">=</span> <span class="n">my_impact_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">icoordinates</span><span class="p">)</span>

        <span class="c"># Ensure that calculated point locations coincide with</span>
        <span class="c"># original exposure point locations</span>
        <span class="n">ref_exp</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">refcoordinates</span> <span class="o">=</span> <span class="n">ref_exp</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">refcoordinates</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Coordinates of impact results do not match those of &#39;</span>
               <span class="s">&#39;exposure data&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">icoordinates</span><span class="p">,</span> <span class="n">refcoordinates</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Ensure that calculated point locations coincide with</span>
        <span class="c"># original exposure point (with depth) locations</span>
        <span class="n">ref_depth</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_with_depth_filename</span><span class="p">)</span>
        <span class="n">refdepth_coordinates</span> <span class="o">=</span> <span class="n">ref_depth</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="c">#refdepth_attributes = ref_depth.get_data()</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">refdepth_coordinates</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Coordinates of impact results do not match those of &#39;</span>
               <span class="s">&#39;exposure data (with depth)&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">icoordinates</span><span class="p">,</span> <span class="n">refdepth_coordinates</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Read reference results</span>
        <span class="c">#hazard_raster = read_layer(hazard_filename)</span>
        <span class="c">#A = hazard_raster.get_data()</span>
        <span class="c">#depth_min, depth_max = hazard_raster.get_extrema()</span>

        <span class="n">ref_impact</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">reference_impact_filename</span><span class="p">)</span>
        <span class="c">#refimpact_coordinates = ref_impact.get_geometry()</span>
        <span class="n">refimpact_attributes</span> <span class="o">=</span> <span class="n">ref_impact</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Check for None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">refimpact_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Element </span><span class="si">%i</span><span class="s"> was None&#39;</span> <span class="o">%</span> <span class="n">i</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Check sanity of calculated attributes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="c">#lon, lat = icoordinates[i]</span>

            <span class="n">depth</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;DEPTH&#39;</span><span class="p">]</span>

            <span class="c"># Ignore NaN&#39;s</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">structural_damage</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;STRUCT_DAM&#39;</span><span class="p">]</span>
            <span class="n">contents_damage</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;CONTENTS_D&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">structural_damage</span><span class="p">,</span> <span class="n">contents_damage</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Percent damage was outside range [0,1] at depth </span><span class="si">%f</span><span class="s">: </span><span class="si">%f</span><span class="s">&#39;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">imp</span><span class="p">))</span>
                <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">imp</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">structural_loss</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;STRUCT_LOS&#39;</span><span class="p">]</span>
            <span class="n">contents_loss</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;CONTENTS_L&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">structural_loss</span> <span class="o">==</span> <span class="mf">0.0</span>
                <span class="k">assert</span> <span class="n">contents_loss</span> <span class="o">==</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">structural_loss</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                <span class="k">assert</span> <span class="n">contents_loss</span> <span class="o">&gt;</span> <span class="mf">0.0</span>

            <span class="n">number_of_people</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;NEXIS_PEOP&#39;</span><span class="p">]</span>
            <span class="n">people_affected</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;PEOPLE_AFF&#39;</span><span class="p">]</span>
            <span class="n">people_severely_affected</span> <span class="o">=</span> <span class="n">iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;PEOPLE_SEV&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="mf">0.01</span> <span class="o">&lt;</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">people_affected</span> <span class="o">==</span> <span class="n">number_of_people</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">people_affected</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">people_severely_affected</span> <span class="o">==</span> <span class="n">number_of_people</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">people_severely_affected</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="c"># Contents and structural damage is done according</span>
            <span class="c"># to different damage curves and should therefore be different</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">contents_damage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">contents_damage</span> <span class="o">!=</span> <span class="n">structural_damage</span>

    <span class="k">def</span> <span class="nf">test_raster_vector_interpolation_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exceptions are caught by interpolate_raster_points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_max_inundation_depth_4326.tif&#39;</span>
                            <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_building_exposure.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">interpolate_raster_vector_points</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;oexoeua&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InaSAFEError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised InaSAFEError&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c"># FIXME (Ole): Try some other error conditions</span>

    <span class="k">def</span> <span class="nf">test_tephra_load_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hypothetical tephra load scenario can be computed</span>

<span class="sd">        This test also exercises reprojection of UTM data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># File names for hazard level and exposure</span>

        <span class="c"># FIXME - when we know how to reproject, replace hazard</span>
        <span class="c"># file with UTM version (i.e. without _geographic).</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span>
                                       <span class="s">&#39;Ashload_Gede_VEI4_geographic.asc&#39;</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;test_buildings.shp&#39;</span><span class="p">)</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Tephra Building Impact Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>

        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>
        <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                         <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

        <span class="c"># Read input data</span>
        <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">load_min</span><span class="p">,</span> <span class="n">load_max</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

        <span class="n">exposure_vector</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">exposure_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Extract calculated result</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Test that results are as expected</span>
        <span class="c"># FIXME: Change test when we decide what values should actually be</span>
        <span class="c">#        calculated :-) :-) :-)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;ASHLOAD&#39;</span><span class="p">]</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;DAMAGE&#39;</span><span class="p">]</span>

            <span class="c"># Test interpolation</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Load </span><span class="si">%.15f</span><span class="s"> was outside bounds [</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">load</span><span class="p">,</span>
                                                           <span class="n">load_min</span><span class="p">,</span>
                                                           <span class="n">load_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">load</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">load_min</span> <span class="o">&lt;=</span> <span class="n">load</span> <span class="o">&lt;=</span> <span class="n">load_max</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Test calcalated values</span>
            <span class="c">#if 0.01 &lt;= load &lt; 90.0:</span>
            <span class="c">#    assert impact == 1</span>
            <span class="c">#elif 90.0 &lt;= load &lt; 150.0:</span>
            <span class="c">#    assert impact == 2</span>
            <span class="c">#elif 150.0 &lt;= load &lt; 300.0:</span>
            <span class="c">#    assert impact == 3</span>
            <span class="c">#elif load &gt;= 300.0:</span>
            <span class="c">#    assert impact == 4</span>
            <span class="c">#else:</span>
            <span class="c">#    assert impact == 0</span>

            <span class="k">if</span> <span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">load</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">impact</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="mf">0.5</span> <span class="o">&lt;=</span> <span class="n">load</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">impact</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mf">2.0</span> <span class="o">&lt;=</span> <span class="n">load</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">impact</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">load</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">impact</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">impact</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">test_interpolation_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolation library works for linear function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create test data</span>
        <span class="n">lon_ul</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c"># Longitude of upper left corner</span>
        <span class="n">lat_ul</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c"># Latitude of upper left corner</span>
        <span class="n">numlon</span> <span class="o">=</span> <span class="mi">8</span>    <span class="c"># Number of longitudes</span>
        <span class="n">numlat</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c"># Number of latitudes</span>

        <span class="c"># Define array where latitudes are rows and longitude columns</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numlat</span><span class="p">,</span> <span class="n">numlon</span><span class="p">))</span>

        <span class="c"># Establish coordinates for lower left corner</span>
        <span class="n">lat_ll</span> <span class="o">=</span> <span class="n">lat_ul</span> <span class="o">-</span> <span class="n">numlat</span>
        <span class="n">lon_ll</span> <span class="o">=</span> <span class="n">lon_ul</span>

        <span class="c"># Define pixel centers along each direction</span>
        <span class="n">longitudes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                                    <span class="n">lon_ll</span> <span class="o">+</span> <span class="n">numlon</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">numlon</span><span class="p">)</span>
        <span class="n">latitudes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                                   <span class="n">lat_ll</span> <span class="o">+</span> <span class="n">numlat</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">numlat</span><span class="p">)</span>

        <span class="c"># Define raster with latitudes going bottom-up (south to north).</span>
        <span class="c"># Longitudes go left-right (west to east)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlon</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">numlat</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">longitudes</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                   <span class="n">latitudes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># Test first that original points are reproduced correctly</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">latitudes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">longitudes</span><span class="p">):</span>

                <span class="n">val</span> <span class="o">=</span> <span class="n">interpolate_raster</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span>
                                         <span class="p">[(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)],</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>
                                      <span class="n">linear_function</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
                                      <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>

        <span class="c"># Then test that genuinly interpolated points are correct</span>
        <span class="n">xis</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_ll</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lon_ll</span> <span class="o">+</span> <span class="n">numlon</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">numlon</span><span class="p">)</span>
        <span class="n">etas</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_ll</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lat_ll</span> <span class="o">+</span> <span class="n">numlat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">numlat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">xis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">eta</span> <span class="ow">in</span> <span class="n">etas</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">interpolate_raster</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span>
                                         <span class="p">[(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)],</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>
                                      <span class="n">linear_function</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
                                      <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>

    <span class="n">test_interpolation_wrapper</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_interpolation_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolation using Raster and Vector objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create test data</span>
        <span class="n">lon_ul</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c"># Longitude of upper left corner</span>
        <span class="n">lat_ul</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c"># Latitude of upper left corner</span>
        <span class="n">numlon</span> <span class="o">=</span> <span class="mi">8</span>    <span class="c"># Number of longitudes</span>
        <span class="n">numlat</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c"># Number of latitudes</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c"># Define array where latitudes are rows and longitude columns</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numlat</span><span class="p">,</span> <span class="n">numlon</span><span class="p">))</span>

        <span class="c"># Establish coordinates for lower left corner</span>
        <span class="n">lat_ll</span> <span class="o">=</span> <span class="n">lat_ul</span> <span class="o">-</span> <span class="n">numlat</span>
        <span class="n">lon_ll</span> <span class="o">=</span> <span class="n">lon_ul</span>

        <span class="c"># Define pixel centers along each direction</span>
        <span class="n">longitudes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                                    <span class="n">lon_ll</span> <span class="o">+</span> <span class="n">numlon</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
                                    <span class="n">numlon</span><span class="p">)</span>
        <span class="n">latitudes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_ll</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                                   <span class="n">lat_ll</span> <span class="o">+</span> <span class="n">numlat</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
                                   <span class="n">numlat</span><span class="p">)</span>

        <span class="c"># Define raster with latitudes going bottom-up (south to north).</span>
        <span class="c"># Longitudes go left-right (west to east)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlon</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">numlat</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">longitudes</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                       <span class="n">latitudes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># Write array to a raster file</span>
        <span class="n">geotransform</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_ul</span><span class="p">,</span> <span class="n">dlon</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lat_ul</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dlat</span><span class="p">)</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;GEOGCS[&quot;GCS_WGS_1984&quot;,&#39;</span>
                      <span class="s">&#39;DATUM[&quot;WGS_1984&quot;,&#39;</span>
                      <span class="s">&#39;SPHEROID[&quot;WGS_1984&quot;,6378137.0,298.257223563]],&#39;</span>
                      <span class="s">&#39;PRIMEM[&quot;Greenwich&quot;,0.0],&#39;</span>
                      <span class="s">&#39;UNIT[&quot;Degree&quot;,0.0174532925199433]]&#39;</span><span class="p">)</span>

        <span class="n">raster_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.tif&#39;</span><span class="p">)</span>
        <span class="n">write_raster_data</span><span class="p">(</span><span class="n">A</span><span class="p">,</span>
                          <span class="n">projection</span><span class="p">,</span>
                          <span class="n">geotransform</span><span class="p">,</span>
                          <span class="n">raster_filename</span><span class="p">)</span>

        <span class="c"># Write test interpolation point to a vector file</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">longitudes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">eta</span> <span class="ow">in</span> <span class="n">latitudes</span><span class="p">:</span>
                <span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>

        <span class="n">vector_filename</span> <span class="o">=</span> <span class="n">unique_filename</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.shp&#39;</span><span class="p">)</span>
        <span class="n">write_vector_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
                          <span class="n">geometry</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                          <span class="n">filename</span><span class="o">=</span><span class="n">vector_filename</span><span class="p">)</span>

        <span class="c"># Read both datasets back in</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">raster_filename</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">vector_filename</span><span class="p">)</span>

        <span class="c"># Then test that axes and data returned by R are correct</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;X axes was </span><span class="si">%s</span><span class="s">, should have been </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Y axes was </span><span class="si">%s</span><span class="s">, should have been </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">latitudes</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">latitudes</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">AA</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Raster data was </span><span class="si">%s</span><span class="s">, should have been </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">AA</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">AA</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Test interpolation function with default layer_name</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s">&#39;value&#39;</span><span class="p">)</span>
        <span class="c">#msg = &#39;Got name %s, expected %s&#39; % (I.get_name(), V.get_name())</span>
        <span class="c">#assert V.get_name() == I.get_name(), msg</span>

        <span class="n">Icoordinates</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">Iattributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>

        <span class="c"># Test that interpolated points are correct</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">):</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">Iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
            <span class="c">#print xi, eta, z, linear_function(xi, eta)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">linear_function</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
                                  <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>

        <span class="c"># FIXME (Ole): Need test for values outside grid.</span>
        <span class="c">#              They should be NaN or something</span>

        <span class="c"># Cleanup</span>
        <span class="c"># FIXME (Ole): Shape files are a collection of files. How to remove?</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vector_filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_interpolation_lembang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolation using Lembang data set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/lembang_mmi_hazmap.asc&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_buildings.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>

        <span class="c"># Read input data</span>
        <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

        <span class="n">exposure_vector</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">exposure_vector</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">exposure_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Test interpolation function</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">hazard_raster</span><span class="p">,</span>
                                                  <span class="n">exposure_vector</span><span class="p">,</span>
                                                  <span class="n">attribute_name</span><span class="o">=</span><span class="s">&#39;MMI&#39;</span><span class="p">)</span>
        <span class="n">Icoordinates</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">Iattributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>

        <span class="c"># Check that interpolated MMI was done as expected</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_buildings_percentage_loss_and_mmi.txt&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">reference_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">MMI</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

            <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">mmi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">reference_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))</span>
            <span class="n">MMI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mmi</span><span class="p">)</span>

        <span class="c"># Verify that coordinates are consistent</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Interpolated coordinates do not match those of test data&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">,</span> <span class="n">reference_points</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Verify interpolated MMI with test result</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MMI</span><span class="p">)):</span>
            <span class="n">calculated_mmi</span> <span class="o">=</span> <span class="n">Iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;MMI&#39;</span><span class="p">]</span>

            <span class="c"># Check that interpolated points are within range</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Interpolated MMI </span><span class="si">%f</span><span class="s"> was outside extrema: &#39;</span>
                   <span class="s">&#39;[</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">]. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span> <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">mmi_min</span> <span class="o">&lt;=</span> <span class="n">calculated_mmi</span> <span class="o">&lt;=</span> <span class="n">mmi_max</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Check that result is within 2% - this is good enough</span>
            <span class="c"># as this was calculated using EQRM and thus different.</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span> <span class="n">MMI</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>

            <span class="c"># Check that all original attributes were carried through</span>
            <span class="c"># according to issue #101</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected key </span><span class="si">%s</span><span class="s"> in interpolated attributes&#39;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">msg</span>

                <span class="n">Ival</span> <span class="o">=</span> <span class="n">Iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Interpolated attribute </span><span class="si">%s</span><span class="s"> did not have the &#39;</span>
                       <span class="s">&#39;expected value </span><span class="si">%s</span><span class="s">. I got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">Ival</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">Ival</span> <span class="o">==</span> <span class="n">val</span><span class="p">,</span> <span class="n">msg</span>
                <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Ival</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">),</span> <span class="n">msg</span>

    <span class="n">test_interpolation_lembang</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_interpolation_tsunami</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolation using tsunami data set works</span>

<span class="sd">        This is test for issue #19 about interpolation overshoot</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_max_inundation_depth_4326.tif&#39;</span>
                            <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_building_exposure.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read input data</span>
        <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">depth_min</span><span class="p">,</span> <span class="n">depth_max</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

        <span class="n">exposure_vector</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">exposure_vector</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="c"># Test interpolation function</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">hazard_raster</span><span class="p">,</span>
                                                  <span class="n">exposure_vector</span><span class="p">,</span>
                                                  <span class="n">attribute_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>
        <span class="n">Icoordinates</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">Iattributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>

        <span class="c"># Verify interpolated values with test result</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">)):</span>

            <span class="n">interpolated_depth</span> <span class="o">=</span> <span class="n">Iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;depth&#39;</span><span class="p">]</span>
            <span class="c"># Check that interpolated points are within range</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Interpolated depth </span><span class="si">%f</span><span class="s"> at point </span><span class="si">%i</span><span class="s"> was outside extrema: &#39;</span>
                   <span class="s">&#39;[</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">]. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">interpolated_depth</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                   <span class="n">depth_min</span><span class="p">,</span> <span class="n">depth_max</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">interpolated_depth</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">depth_min</span> <span class="o">&lt;=</span> <span class="n">interpolated_depth</span> <span class="o">&lt;=</span> <span class="n">depth_max</span><span class="p">,</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">test_interpolation_tsunami_maumere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolation using tsunami data set from Maumere</span>

<span class="sd">        This is a test for interpolation (issue #19)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected fatalities</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/maumere_aos_depth_20m_land_wgs84.asc&#39;</span>
                           <span class="o">%</span> <span class="n">HAZDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/maumere_pop_prj.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">depth_min</span><span class="p">,</span> <span class="n">depth_max</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

        <span class="c"># Compare extrema to values read off QGIS for this layer</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">([</span><span class="n">depth_min</span><span class="p">,</span> <span class="n">depth_max</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">16.68</span><span class="p">],</span>
                              <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">)</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Test the interpolation function</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>
        <span class="n">Icoordinates</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">Iattributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Icoordinates</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">891</span>

        <span class="c"># Verify interpolated values with test result</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>

            <span class="n">interpolated_depth</span> <span class="o">=</span> <span class="n">Iattributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;depth&#39;</span><span class="p">]</span>
            <span class="n">pointid</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;POINTID&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">pointid</span> <span class="o">==</span> <span class="mi">263</span><span class="p">:</span>

                <span class="c">#print i, pointid, attributes[i],</span>
                <span class="c">#print interpolated_depth, coordinates[i]</span>

                <span class="c"># Check that location is correct</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                      <span class="p">[</span><span class="mf">122.20367299</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.61300358</span><span class="p">])</span>

                <span class="c"># This is known to be outside inundation area so should</span>
                <span class="c"># near zero</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">interpolated_depth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                      <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pointid</span> <span class="o">==</span> <span class="mi">148</span><span class="p">:</span>
                <span class="c"># Check that location is correct</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                      <span class="p">[</span><span class="mf">122.2045912</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.608483265</span><span class="p">])</span>

                <span class="c"># This is in an inundated area with a surrounding depths of</span>
                <span class="c"># 4.531, 3.911</span>
                <span class="c"># 2.675, 2.583</span>
                <span class="k">assert</span> <span class="n">interpolated_depth</span> <span class="o">&lt;</span> <span class="mf">4.531</span>
                <span class="k">assert</span> <span class="n">interpolated_depth</span> <span class="o">&lt;</span> <span class="mf">3.911</span>
                <span class="k">assert</span> <span class="n">interpolated_depth</span> <span class="o">&gt;</span> <span class="mf">2.583</span>
                <span class="k">assert</span> <span class="n">interpolated_depth</span> <span class="o">&gt;</span> <span class="mf">2.675</span>

                <span class="c"># This is a characterisation test for bilinear interpolation</span>
                <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">interpolated_depth</span><span class="p">,</span> <span class="mf">3.62477204455</span><span class="p">,</span>
                                      <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>

            <span class="c"># Check that interpolated points are within range</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Interpolated depth </span><span class="si">%f</span><span class="s"> at point </span><span class="si">%i</span><span class="s"> was outside extrema: &#39;</span>
                   <span class="s">&#39;[</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">]. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">interpolated_depth</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                   <span class="n">depth_min</span><span class="p">,</span> <span class="n">depth_max</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">interpolated_depth</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">depth_min</span> <span class="o">&lt;=</span> <span class="n">interpolated_depth</span> <span class="o">&lt;=</span> <span class="n">depth_max</span><span class="p">,</span> <span class="n">msg</span>

    <span class="n">test_interpolation_tsunami_maumere</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_polygon_clipping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clipping using real polygon and point data from Maumere</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Test data</span>
        <span class="n">polygon_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_poly.txt&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>  <span class="c"># Polygon 799</span>
        <span class="n">points_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_points.txt&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">polygon_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">polygon</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">ensure_numeric</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">points_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">ensure_numeric</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="c"># Clip</span>
        <span class="n">inside</span><span class="p">,</span> <span class="n">outside</span> <span class="o">=</span> <span class="n">separate_points_by_polygon</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">polygon</span><span class="p">)</span>

        <span class="c"># Expected number of points inside</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inside</span><span class="p">)</span> <span class="o">==</span> <span class="mi">458</span>

        <span class="c"># First 10 inside</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">inside</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2279</span><span class="p">,</span> <span class="mi">2290</span><span class="p">,</span> <span class="mi">2297</span><span class="p">,</span> <span class="mi">2306</span><span class="p">,</span> <span class="mi">2307</span><span class="p">,</span>
                                             <span class="mi">2313</span><span class="p">,</span> <span class="mi">2316</span><span class="p">,</span> <span class="mi">2319</span><span class="p">,</span> <span class="mi">2321</span><span class="p">,</span> <span class="mi">2322</span><span class="p">])</span>

        <span class="c"># Last 10 outside</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">outside</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">3519</span><span class="p">,</span> <span class="mi">3520</span><span class="p">,</span> <span class="mi">3521</span><span class="p">,</span> <span class="mi">3522</span><span class="p">,</span> <span class="mi">3523</span><span class="p">,</span>
                                               <span class="mi">3524</span><span class="p">,</span> <span class="mi">3525</span><span class="p">,</span> <span class="mi">3526</span><span class="p">,</span> <span class="mi">3527</span><span class="p">,</span> <span class="mi">3528</span><span class="p">])</span>
        <span class="c"># Store for viewing in e.g. QGis</span>
        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>  <span class="c"># True:</span>
            <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">polygon</span><span class="p">])</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_poly.shp&#39;</span><span class="p">)</span>
            <span class="n">pts_inside</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">inside</span><span class="p">]</span>
            <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">pts_inside</span><span class="p">)</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_points_in.shp&#39;</span><span class="p">)</span>
            <span class="n">pts_outside</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">outside</span><span class="p">]</span>
            <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">pts_outside</span><span class="p">)</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_points_out.shp&#39;</span><span class="p">)</span>

    <span class="n">test_polygon_clipping</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_interpolation_from_polygons_one_poly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Point interpolation using one polygon from Maumere works</span>

<span class="sd">        This is a test for interpolation (issue #48)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_polygon_WGS84.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/building_Maumere.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometry</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="c"># Cut down to make test quick</span>
        <span class="c"># Polygon #799 is the one used in separate test</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">H_attributes</span><span class="p">[</span><span class="mi">799</span><span class="p">:</span><span class="mi">800</span><span class="p">],</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">H_geometry</span><span class="p">[</span><span class="mi">799</span><span class="p">:</span><span class="mi">800</span><span class="p">],</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">get_projection</span><span class="p">())</span>
        <span class="c">#H.write_to_file(&#39;MM_799.shp&#39;)  # E.g. to view with QGis</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">E_attributes</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Test interpolation function</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                                  <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>

        <span class="n">I_attributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected &quot;depth&quot;, got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">I</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">I</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;depth&#39;</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_attributes</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_attributes</span><span class="p">)</span>

        <span class="c"># Assert that expected attribute names exist</span>
        <span class="n">I_names</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">H_names</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">E_names</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">H_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find hazard name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">E_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find exposure name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Verify interpolated values with test result</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">I_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Category&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 458 points tagged with category, &#39;</span>
               <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">458</span><span class="p">,</span> <span class="n">msg</span>

    <span class="n">test_interpolation_from_polygons_one_poly</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_interpolation_from_polygons_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Point interpolation using multiple polygons from Maumere works</span>

<span class="sd">        This is a test for interpolation (issue #48)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># FIXME (Ole): Really should move this and subsequent tests to</span>
        <span class="c">#              test_io.py</span>

        <span class="c"># Name file names for hazard and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_polygon_WGS84.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/building_Maumere.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometry</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="c"># Full version</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">H_attributes</span><span class="p">,</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">H_geometry</span><span class="p">,</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">get_projection</span><span class="p">())</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">E_attributes</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Test interpolation function</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                                  <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>

        <span class="n">I_attributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_attributes</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_attributes</span><span class="p">)</span>

        <span class="c"># Assert that expected attribute names exist</span>
        <span class="n">I_names</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">H_names</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">E_names</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">H_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find hazard name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">E_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find exposure name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Verify interpolated values with test result</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">I_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Did not find default attribute </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="n">DEFAULT_ATTRIBUTE</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Count items using default attribute</span>
            <span class="k">if</span> <span class="n">DEFAULT_ATTRIBUTE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># Count items in each specific category</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;Category&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">==</span> <span class="mi">192</span><span class="p">:</span>
            <span class="c"># In case we used cut down version</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 100 points tagged with category &quot;High&quot;, &#39;</span>
                   <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;High&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;High&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 739 points tagged with category &quot;Very High&quot;, &#39;</span>
                   <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Very High&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Very High&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">739</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Check default attribute too</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 839 points tagged with default attribute &quot;</span><span class="si">%s</span><span class="s">&quot;, &#39;</span>
                   <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span>
                                        <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">839</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Affected and not affected does not add up&#39;</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+</span>
                    <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">),</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1032</span><span class="p">:</span>
            <span class="c"># The full version</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 2258 points tagged with category &quot;High&quot;, &#39;</span>
                   <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;High&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;High&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2258</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 1190 points tagged with category &quot;Very High&quot;, &#39;</span>
                   <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Very High&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Very High&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1190</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Check default attribute too</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 3452 points tagged with default attribute &#39;</span>
                   <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s"> = True&quot;, &#39;</span>
                   <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span>
                                        <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3452</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 76 points tagged with default attribute &#39;</span>
                   <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s"> = False&quot;, &#39;</span>
                   <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span>
                                        <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">76</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Affected and not affected does not add up&#39;</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+</span>
                    <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c">#for key in counts:</span>
        <span class="c">#    print key, counts[key]</span>

    <span class="n">test_interpolation_from_polygons_multiple</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_interpolation_from_polygons_error_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolation using polygons handles input errors as expected</span>

<span class="sd">        This catches situation where input data have different projections</span>
<span class="sd">        This is a test for interpolation (issue #48)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Input data</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_polygon.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>  <span class="c"># UTM</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/building_Maumere.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>  <span class="c"># GEO</span>

        <span class="c"># Read input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="c"># Check projection mismatch is caught</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">VerificationError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Projection mismatch should have been caught: </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">assert</span> <span class="s">&#39;Projections&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Should have raised error about projection mismatch&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">test_interpolation_from_polygons_error_handling</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_line_clipping_by_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Multiple lines are clipped correctly by complex polygon</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Test data</span>

        <span class="c"># Polygon 799  (520 x 2)</span>
        <span class="n">polygon_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_poly.txt&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="c"># 156 composite lines</span>
        <span class="n">lines_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/test_lines.pck&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read</span>
        <span class="n">test_polygon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">polygon_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">test_polygon</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">test_polygon</span> <span class="o">=</span> <span class="n">ensure_numeric</span><span class="p">(</span><span class="n">test_polygon</span><span class="p">)</span>

        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">lines_filename</span><span class="p">)</span>
        <span class="n">test_lines</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Clip</span>
        <span class="n">inside_lines</span><span class="p">,</span> <span class="n">outside_lines</span> <span class="o">=</span> <span class="n">clip_lines_by_polygon</span><span class="p">(</span><span class="n">test_lines</span><span class="p">,</span>
                                                            <span class="n">test_polygon</span><span class="p">)</span>

        <span class="c"># Convert dictionaries to lists of lines (to fit test)</span>
        <span class="n">inside_line_geometry</span> <span class="o">=</span> <span class="n">line_dictionary_to_geometry</span><span class="p">(</span><span class="n">inside_lines</span><span class="p">)</span>
        <span class="n">outside_line_geometry</span> <span class="o">=</span> <span class="n">line_dictionary_to_geometry</span><span class="p">(</span><span class="n">outside_lines</span><span class="p">)</span>

        <span class="c"># These lines have compontes both inside and outside</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inside_line_geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">14</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">outside_line_geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">167</span>

        <span class="c"># Check that midpoints of each segment are correctly placed</span>
        <span class="n">inside_centroids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inside_line_geometry</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">seg0</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">seg1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">seg0</span> <span class="o">+</span> <span class="n">seg1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">inside_centroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">midpoint</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">is_inside_polygon</span><span class="p">(</span><span class="n">midpoint</span><span class="p">,</span> <span class="n">test_polygon</span><span class="p">)</span>

        <span class="n">outside_centroids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outside_line_geometry</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">seg0</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">seg1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">seg0</span> <span class="o">+</span> <span class="n">seg1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">outside_centroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">midpoint</span><span class="p">)</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">is_inside_polygon</span><span class="p">(</span><span class="n">midpoint</span><span class="p">,</span> <span class="n">test_polygon</span><span class="p">)</span>

        <span class="c"># Possibly generate files for visual inspection with e.g. QGis</span>
        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>  <span class="c"># True:</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">test_polygon</span><span class="p">])</span>
            <span class="n">P</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_polygon.shp&#39;</span><span class="p">)</span>

            <span class="n">L</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_lines</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_lines.shp&#39;</span><span class="p">)</span>

            <span class="n">L</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">inside_line_geometry</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;inside_lines.shp&#39;</span><span class="p">)</span>

            <span class="n">L</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">outside_line_geometry</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;outside_lines.shp&#39;</span><span class="p">)</span>

            <span class="n">L</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">inside_centroids</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;point&#39;</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;inside_centroids.shp&#39;</span><span class="p">)</span>

            <span class="n">L</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">outside_centroids</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;point&#39;</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;outside_centroids.shp&#39;</span><span class="p">)</span>

        <span class="c"># Characterisation test based on against visual inspection with QGIS</span>
        <span class="c">#print inside_line_geometry[6]</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">inside_line_geometry</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                              <span class="p">[[</span><span class="mf">122.23438722</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.6277337</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.23316953</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.62733247</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.23162128</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.62683715</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.23156661</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.62681168</span><span class="p">]])</span>

        <span class="c">#print outside_line_geometry[5]</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">outside_line_geometry</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                              <span class="p">[[</span><span class="mf">122.18321143</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58901526</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18353015</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58890024</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18370883</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58884135</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18376524</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58881115</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18381025</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58878405</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.1838646</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58875119</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18389685</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58873165</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18394329</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58869283</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18401084</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58862284</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18408657</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58853526</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18414936</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58845887</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18425204</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58832279</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18449009</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58804974</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18457453</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.58798668</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">122.18466284</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.5878697</span><span class="p">]])</span>

    <span class="n">test_line_clipping_by_polygon</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_line_interpolation_from_polygons_one_poly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Line clipping and interpolation using one polygon works</span>

<span class="sd">        This is a test for road interpolation (issue #55)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_polygon_WGS84.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/roads_Maumere.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometry</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="c"># Cut down to polygon #799 to make test quick</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">H_attributes</span><span class="p">[</span><span class="mi">799</span><span class="p">:</span><span class="mi">800</span><span class="p">],</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">H_geometry</span><span class="p">[</span><span class="mi">799</span><span class="p">:</span><span class="mi">800</span><span class="p">],</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">get_projection</span><span class="p">())</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometry</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="c"># Test interpolation function</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                                  <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>

        <span class="n">I_geometry</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">I_attributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">I</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;depth&#39;</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_attributes</span><span class="p">)</span>

        <span class="c"># Possibly generate files for visual inspection with e.g. QGis</span>
        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">H</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_polygon.shp&#39;</span><span class="p">)</span>
            <span class="n">E</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_lines.shp&#39;</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;interpolated_lines.shp&#39;</span><span class="p">)</span>

        <span class="c"># Assert that all expected attribute names exist</span>
        <span class="n">I_names</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">H_names</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">E_names</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>

        <span class="c"># Attributes from polygons</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">H_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find hazard name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Attributes from original lines</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">E_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find exposure name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># New attributes</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span> <span class="s">&#39;polygon_id&#39;</span><span class="p">,</span> <span class="s">&#39;parent_line_id&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find new attribute name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                                                  <span class="n">I_names</span><span class="p">)</span>
            <span class="c"># FIXME (Ole): Shapefiles cut name down to 10 characters.</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Verify interpolated values with test result</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>

            <span class="c"># Check that default attribute is present</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">I_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Did not find default attribute </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="n">DEFAULT_ATTRIBUTE</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Count items using default attribute</span>
            <span class="k">if</span> <span class="n">DEFAULT_ATTRIBUTE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># Check specific attribute</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">I_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Category&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;high&#39;</span><span class="p">,</span> <span class="s">&#39;very high&#39;</span><span class="p">]</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 14 lines tagged with category, &#39;</span>
               <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">14</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">14</span>

        <span class="c"># Check default attribute too</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 14 segments tagged with default attribute &#39;</span>
               <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s"> = True&quot;, &#39;</span>
               <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span>
                                    <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">14</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Check against correctness verified in QGIS</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;highway&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;road&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;osm_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">69372744</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="s">&#39;parent_line_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">131</span>

    <span class="n">test_line_interpolation_from_polygons_one_poly</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_line_interpolation_from_multiple_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Line interpolation using multiple polygons works</span>

<span class="sd">        This is a test for road interpolation (issue #55)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/tsunami_polygon_WGS84.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/roads_Maumere.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>

        <span class="c"># Read input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometry</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>

        <span class="c"># Cut down to 500 polygons</span>
        <span class="c"># (some e.g. #657 have thousands of vertices, others just a few)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">H_attributes</span><span class="p">[</span><span class="mi">300</span><span class="p">:</span><span class="mi">657</span><span class="p">]</span> <span class="o">+</span> <span class="n">H_attributes</span><span class="p">[</span><span class="mi">658</span><span class="p">:</span><span class="mi">800</span><span class="p">],</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">H_geometry</span><span class="p">[</span><span class="mi">300</span><span class="p">:</span><span class="mi">657</span><span class="p">]</span> <span class="o">+</span> <span class="n">H_geometry</span><span class="p">[</span><span class="mi">658</span><span class="p">:</span><span class="mi">800</span><span class="p">],</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">get_projection</span><span class="p">())</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometry</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="c"># Test interpolation function</span>
        <span class="c">#import time</span>
        <span class="c">#t0 = time.time()</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                                  <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>
        <span class="c">#print &#39;This took&#39;, time.time() - t0</span>

        <span class="n">I_geometry</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">I_attributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">I</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;depth&#39;</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_attributes</span><span class="p">)</span>

        <span class="c"># Possibly generate files for visual inspection with e.g. QGis</span>
        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>  <span class="c"># True:</span>
            <span class="n">H</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_polygon.shp&#39;</span><span class="p">)</span>
            <span class="n">E</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;test_lines.shp&#39;</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;interpolated_lines.shp&#39;</span><span class="p">)</span>

        <span class="c"># Assert that all expected attribute names exist</span>
        <span class="n">I_names</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">H_names</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">E_names</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>

        <span class="c"># Attributes from polygons</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">H_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find hazard name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Attributes from original lines</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">E_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find exposure name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># New attributes</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span> <span class="s">&#39;polygon_id&#39;</span><span class="p">,</span> <span class="s">&#39;parent_line_id&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find new attribute name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                                                  <span class="n">I_names</span><span class="p">)</span>
            <span class="c"># FIXME (Ole): Shapefiles cut name down to 10 characters.</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Verify interpolated values with test result</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>

            <span class="c"># Check that default attribute is present</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">I_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Did not find default attribute </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="n">DEFAULT_ATTRIBUTE</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Count items using default attribute</span>
            <span class="k">if</span> <span class="n">DEFAULT_ATTRIBUTE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="s">&#39;Not &#39;</span> <span class="o">+</span> <span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># Check specific attribute</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">I_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Category&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;category = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">category</span>
                <span class="k">assert</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;low&#39;</span><span class="p">,</span> <span class="s">&#39;medium&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;high&#39;</span><span class="p">,</span> <span class="s">&#39;very high&#39;</span><span class="p">],</span> <span class="n">msg</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 103 lines tagged with category, &#39;</span>
               <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">103</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">103</span>

        <span class="c"># Check default attribute too</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expected 103 segments tagged with default attribute &#39;</span>
               <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s"> = True&quot;, &#39;</span>
               <span class="s">&#39;but got only </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">,</span>
                                    <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">counts</span><span class="p">[</span><span class="n">DEFAULT_ATTRIBUTE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">103</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># Check against correctness verified in QGIS</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">40</span><span class="p">][</span><span class="s">&#39;highway&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;residential&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">40</span><span class="p">][</span><span class="s">&#39;osm_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">69373107</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">40</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">111</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">40</span><span class="p">][</span><span class="s">&#39;parent_line_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">54</span>

        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">76</span><span class="p">][</span><span class="s">&#39;highway&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;secondary&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">76</span><span class="p">][</span><span class="s">&#39;Category&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;High&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">76</span><span class="p">][</span><span class="s">&#39;osm_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">69370718</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">76</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">374</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">76</span><span class="p">][</span><span class="s">&#39;parent_line_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">85</span><span class="p">][</span><span class="s">&#39;highway&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;secondary&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">85</span><span class="p">][</span><span class="s">&#39;Category&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Very High&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">85</span><span class="p">][</span><span class="s">&#39;osm_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">69371482</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">85</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">453</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">85</span><span class="p">][</span><span class="s">&#39;parent_line_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">133</span>

    <span class="n">test_line_interpolation_from_multiple_polygons</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_polygon_to_roads_interpolation_flood_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Roads can be tagged with values from flood polygons</span>

<span class="sd">        This is a test for road interpolation (issue #55)</span>

<span class="sd">        # The dataset is large: 2704 complex polygons</span>
<span class="sd">        and 108082 complex line features - so has been cut down</span>
<span class="sd">        in this test.</span>

<span class="sd">        The runtime for the whole set is in the order of more than</span>
<span class="sd">        1 hour. Cutting the number of lines down by a factor of 10 years</span>
<span class="sd">        brings it down to about 10 minutes (500 seconds).</span>
<span class="sd">        A factor of 100 gives about 1 minute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/rw_jakarta_singlepart.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/indonesia_highway.shp&#39;</span> <span class="o">%</span> <span class="n">EXPDATA</span><span class="p">)</span>

        <span class="c"># Read all input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>  <span class="c"># Polygons</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometry</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2704</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>  <span class="c"># Lines - this is slow to read</span>
        <span class="n">E_geometry</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">E_attributes</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">==</span> <span class="mi">108082</span>

        <span class="c"># Cut number of road features down</span>
        <span class="c"># A factor of ten brings the runtime down to about 10 minutes.</span>
        <span class="c"># A factor of ten brings the runtime down to less than 1 minute.</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">E_attributes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">E_geometry</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">E</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                   <span class="n">geometry_type</span><span class="o">=</span><span class="n">E</span><span class="o">.</span><span class="n">geometry_type</span><span class="p">)</span>

        <span class="c"># Test interpolation function</span>
        <span class="c">#import time</span>
        <span class="c">#t0 = time.time()</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                                  <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>
        <span class="c">#print &#39;That took %f seconds&#39; % (time.time() - t0)</span>

        <span class="c"># TODO:</span>
        <span class="c"># Keep only those roads that are marked FLOODPRONE == &#39;YES&#39;</span>

        <span class="n">I_geometry</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">I_attributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="c"># Possibly generate files for visual inspection with e.g. QGis</span>
        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">H_geometry</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;polygon&#39;</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">H_attributes</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;flood_polygon.shp&#39;</span><span class="p">)</span>

            <span class="n">L</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">I_geometry</span><span class="p">,</span> <span class="n">geometry_type</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">I_attributes</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;flood_tagged_roads.shp&#39;</span><span class="p">)</span>

        <span class="c"># Assert that expected attribute names exist</span>
        <span class="n">I_names</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">H_names</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="n">E_names</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_attribute_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">H_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find hazard name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">E_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Did not find exposure name &quot;</span><span class="si">%s</span><span class="s">&quot; in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">I_names</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">I_names</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c"># FIXME (Ole): Finish this test</span>
        <span class="c"># Check that attributes have been carried through</span>
        <span class="c">#for i, attr in enumerate(I_attributes):</span>
        <span class="c">#    pass</span>
        <span class="c">#    # TODO</span>
        <span class="c"># Check against correctness verified in QGIS</span>
        <span class="c">#assert I_attributes[][&#39;highway&#39;] ==</span>
        <span class="c">#assert I_attributes[][&#39;osm_id&#39;] ==</span>
        <span class="c">#assert I_attributes[][&#39;polygon_id&#39;] ==</span>
        <span class="c">#assert I_attributes[][&#39;parent_line_id&#39;] ==</span>

    <span class="n">test_polygon_to_roads_interpolation_flood_example</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">Xtest_polygon_to_roads_interpolation_jakarta_flood_example1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Roads can be tagged with values from flood polygons</span>

<span class="sd">        This is a test for road interpolation (issue #55)</span>

<span class="sd">        # The dataset is: 2704 complex polygons and 18574 complex line features</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/rw_jakarta_singlepart.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/jakarta_roads.shp&#39;</span> <span class="o">%</span> <span class="n">EXPDATA</span><span class="p">)</span>

        <span class="c"># Read all input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>  <span class="c"># Polygons</span>
        <span class="n">H_attributes</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">H_geometries</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2704</span>

        <span class="c"># Use only polygons marked as flood prone</span>
        <span class="c"># to get the result quicker.</span>
        <span class="n">cut_attributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cut_geometries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">H_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;FLOODPRONE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;yes&#39;</span><span class="p">):</span>
                <span class="n">cut_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">H_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">cut_geometries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">H_geometries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cut_attributes</span><span class="p">,</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">cut_geometries</span><span class="p">,</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                   <span class="n">geometry_type</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">geometry_type</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1011</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">E_geometries</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="n">E_attributes</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">==</span> <span class="mi">18574</span>

        <span class="c"># Get statistics of road types</span>
        <span class="n">road_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">E_attributes</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)):</span>
            <span class="n">roadtype</span> <span class="o">=</span> <span class="n">E_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;TYPE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">roadtype</span> <span class="ow">in</span> <span class="n">road_types</span><span class="p">:</span>
                <span class="n">road_types</span><span class="p">[</span><span class="n">roadtype</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">road_types</span><span class="p">[</span><span class="n">roadtype</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c">#for att in road_types:</span>
        <span class="c">#    print att, road_types[att]</span>
        <span class="k">assert</span> <span class="n">road_types</span><span class="p">[</span><span class="s">&#39;residential&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">14853</span>

        <span class="c"># Remove residental roads</span>
        <span class="n">cut_attributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cut_geometries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">E_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;TYPE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s">&#39;residential&#39;</span><span class="p">:</span>
                <span class="n">cut_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">cut_geometries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_geometries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># Cut even further for the purpose of testing</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cut_attributes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">cut_geometries</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">E</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                   <span class="n">geometry_type</span><span class="o">=</span><span class="n">E</span><span class="o">.</span><span class="n">geometry_type</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">==</span> <span class="mi">744</span>

        <span class="c"># Test interpolation function</span>
        <span class="c">#import time</span>
        <span class="c">#t0 = time.time()</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                                  <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>
        <span class="c">#print (&#39;Using 2704 individual polygons took %f seconds&#39;</span>
        <span class="c">#       % (time.time() - t0))</span>
        <span class="c">#I.write_to_file(&#39;flood_prone_roads_jakarta_individual.shp&#39;)</span>

        <span class="c"># Check against correctness verified in QGIS</span>
        <span class="n">I_attributes</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">198</span><span class="p">][</span><span class="s">&#39;TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;secondary&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">198</span><span class="p">][</span><span class="s">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Lingkar Mega Kuningan&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">198</span><span class="p">][</span><span class="s">&#39;KEL_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;KUNINGAN TIMUR&#39;</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">198</span><span class="p">][</span><span class="s">&#39;polygon_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">235</span>
        <span class="k">assert</span> <span class="n">I_attributes</span><span class="p">[</span><span class="mi">198</span><span class="p">][</span><span class="s">&#39;parent_line_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">333</span>

    <span class="n">Xtest_polygon_to_roads_interpolation_jakarta_flood_example1</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">Xtest_polygon_to_roads_interpolation_jakarta_flood_merged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Roads can be tagged with values from flood polygons</span>

<span class="sd">        This is a test for road interpolation (issue #55)</span>

<span class="sd">        # The dataset is: 59 merged complex polygons and 18574</span>
<span class="sd">        # complex line features</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level and exposure</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/RW_2007_dissolve.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/jakarta_roads.shp&#39;</span> <span class="o">%</span> <span class="n">EXPDATA</span><span class="p">)</span>

        <span class="c"># Read all input data</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>  <span class="c"># Polygons</span>
        <span class="c">#H_attributes = H.get_data()</span>
        <span class="c">#H_geometries = H.get_geometry()</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">==</span> <span class="mi">35</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>
        <span class="n">E_geometries</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
        <span class="c">#E_attributes = E.get_data()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">==</span> <span class="mi">18574</span>

        <span class="c"># Get statistics of road types</span>
        <span class="n">road_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">E_attributes</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)):</span>
            <span class="n">roadtype</span> <span class="o">=</span> <span class="n">E_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;TYPE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">roadtype</span> <span class="ow">in</span> <span class="n">road_types</span><span class="p">:</span>
                <span class="n">road_types</span><span class="p">[</span><span class="n">roadtype</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">road_types</span><span class="p">[</span><span class="n">roadtype</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c">#for att in road_types:</span>
        <span class="c">#    print att, road_types[att]</span>
        <span class="k">assert</span> <span class="n">road_types</span><span class="p">[</span><span class="s">&#39;residential&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">14853</span>

        <span class="c"># Remove residental roads</span>
        <span class="n">cut_attributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cut_geometries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">E_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;TYPE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s">&#39;residential&#39;</span><span class="p">:</span>
                <span class="n">cut_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">cut_geometries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_geometries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># Cut even further for the purpose of testing</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cut_attributes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span>
                   <span class="n">geometry</span><span class="o">=</span><span class="n">cut_geometries</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span>
                   <span class="n">projection</span><span class="o">=</span><span class="n">E</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(),</span>
                   <span class="n">geometry_type</span><span class="o">=</span><span class="n">E</span><span class="o">.</span><span class="n">geometry_type</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">==</span> <span class="mi">744</span>

        <span class="c"># Test interpolation function</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&#39;start&#39;</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">assign_hazard_values_to_exposure_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
                                                  <span class="n">layer_name</span><span class="o">=</span><span class="s">&#39;depth&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;Using merged polygon took </span><span class="si">%f</span><span class="s"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="s">&#39;flood_prone_roads_jakarta_merged.shp&#39;</span><span class="p">)</span>

        <span class="c"># Check against correctness verified in QGIS</span>
        <span class="c">#I_attributes = I.get_data()</span>
        <span class="c">#assert I_attributes[198][&#39;TYPE&#39;] == &#39;secondary&#39;</span>
        <span class="c">#assert I_attributes[198][&#39;NAME&#39;] == &#39;Lingkar Mega Kuningan&#39;</span>
        <span class="c">#assert I_attributes[198][&#39;KEL_NAME&#39;] == &#39;KUNINGAN TIMUR&#39;</span>
        <span class="c">#assert I_attributes[198][&#39;polygon_id&#39;] == 235</span>
        <span class="c">#assert I_attributes[198][&#39;parent_line_id&#39;] == 333</span>

    <span class="n">Xtest_polygon_to_roads_interpolation_jakarta_flood_merged</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_layer_integrity_raises_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Layers without keywords raise exception</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">population</span> <span class="o">=</span> <span class="s">&#39;Population_Jakarta_geographic.asc&#39;</span>
        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;HKVtest&#39;</span>

        <span class="n">hazard_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Flood_Current_Depth_Jakarta_geographic.asc&#39;</span><span class="p">,</span>
                         <span class="s">&#39;Flood_Design_Depth_Jakarta_geographic.asc&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hazard_layers</span><span class="p">):</span>
            <span class="n">hazard_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">exposure_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">population</span><span class="p">)</span>

            <span class="c"># Get layers using API</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

            <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
            <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

            <span class="c"># Call impact calculation engine normally</span>
            <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                             <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

            <span class="c"># Make keyword value empty and verify exception is raised</span>
            <span class="n">expected_category</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span>
            <span class="n">E</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                 <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">VerificationError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="c"># Check expected error message</span>
                <span class="k">assert</span> <span class="s">&#39;No value found&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Empty keyword value should have raised exception&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c"># Restore for next test</span>
            <span class="n">E</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected_category</span>

            <span class="c"># Remove critical keywords and verify exception is raised</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">H</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">H</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;subcategory&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                 <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">VerificationError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="c"># Check expected error message</span>
                <span class="k">assert</span> <span class="s">&#39;did not have required keyword&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Missing keyword should have raised exception&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">test_layer_integrity_raises_exception</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_padang_building_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Padang building impact calculation works through the API</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Padang Earthquake Building Damage Function&#39;</span>

        <span class="c"># Test for a range of hazard layers</span>
        <span class="k">for</span> <span class="n">mmi_filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Shakemap_Padang_2009.asc&#39;</span><span class="p">]:</span>
                             <span class="c">#&#39;Lembang_Earthquake_Scenario.asc&#39;]:</span>

            <span class="c"># Upload input data</span>
            <span class="n">hazard_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="n">mmi_filename</span><span class="p">)</span>
            <span class="n">exposure_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="s">&#39;Padang_WGS84.shp&#39;</span><span class="p">)</span>

            <span class="c"># Get layers using API</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

            <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>
            <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

            <span class="c"># Call impact calculation engine</span>
            <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                             <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>

            <span class="c"># Read hazard data for reference</span>
            <span class="n">hazard_raster</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
            <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span> <span class="o">=</span> <span class="n">hazard_raster</span><span class="o">.</span><span class="n">get_extrema</span><span class="p">()</span>

            <span class="c"># Extract calculated result</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_geometry</span><span class="p">()</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c"># Verify calculated result</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">verified_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)):</span>
                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span>
                <span class="n">calculated_mmi</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;MMI&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">calculated_mmi</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="c"># FIXME (Ole): Some points have MMI==0 here.</span>
                    <span class="c"># Weird but not a show stopper</span>
                    <span class="k">continue</span>

                <span class="c"># Check that interpolated points are within range</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Interpolated mmi </span><span class="si">%f</span><span class="s"> was outside extrema: &#39;</span>
                       <span class="s">&#39;[</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">] at location &#39;</span>
                       <span class="s">&#39;[</span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">]. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span>
                                       <span class="n">mmi_min</span><span class="p">,</span> <span class="n">mmi_max</span><span class="p">,</span>
                                       <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">mmi_min</span> <span class="o">&lt;=</span> <span class="n">calculated_mmi</span> <span class="o">&lt;=</span> <span class="n">mmi_max</span><span class="p">,</span> <span class="n">msg</span>

                <span class="n">building_class</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;VCLASS&#39;</span><span class="p">]</span>

                <span class="c"># Check calculated damage</span>
                <span class="n">calculated_dam</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;DAMAGE&#39;</span><span class="p">]</span>
                <span class="c">#print calculated_mmi</span>
                <span class="n">verified_dam</span> <span class="o">=</span> <span class="n">padang_check_results</span><span class="p">(</span><span class="n">calculated_mmi</span><span class="p">,</span>
                                                    <span class="n">building_class</span><span class="p">)</span>
                <span class="c">#print calculated_mmi, building_class, calculated_dam</span>
                <span class="k">if</span> <span class="n">verified_dam</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated damage was not as expected &#39;</span>
                             <span class="s">&#39;for hazard layer </span><span class="si">%s</span><span class="s">. I got </span><span class="si">%f</span><span class="s"> &#39;</span>
                           <span class="s">&#39;but expected </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hazard_filename</span><span class="p">,</span>
                                                <span class="n">calculated_dam</span><span class="p">,</span>
                                                <span class="n">verified_dam</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">calculated_dam</span><span class="p">,</span> <span class="n">verified_dam</span><span class="p">,</span>
                                          <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-4</span><span class="p">),</span> <span class="n">msg</span>
                    <span class="n">verified_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;No points was verified in output. Please create &#39;</span>
                   <span class="s">&#39;table withe reference data&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">verified_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Number buildings was not 3896.&#39;</span>
            <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">3896</span><span class="p">,</span> <span class="n">msg</span>

    <span class="n">test_padang_building_examples</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_itb_building_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Damage ratio (estimated repair cost relative to replacement cost)</span>
<span class="sd">           can be computed using the ITB building vulnerability model.</span>
<span class="sd">           (Test data from Hyeuk Ryu).</span>
<span class="sd">           As of July 4, 2012, the vulnerability model used to generate</span>
<span class="sd">           the reference values is dummy one, and it will be updated with</span>
<span class="sd">           the ITB&#39;s model later.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Name file names for hazard level, exposure and expected impact</span>
        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Shakemap_Padang_2009.asc&#39;</span> <span class="o">%</span> <span class="n">HAZDATA</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/Padang_WGS84.shp&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>
        <span class="n">damage_filename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/reference_result_itb.csv&#39;</span> <span class="o">%</span> <span class="n">TESTDATA</span>

        <span class="n">a</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">damage_filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ref_damage</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">ref_damage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">ref_damage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ref_damage</span><span class="p">)</span>

        <span class="c"># Calculate impact using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;I T B Earthquake Building Damage Function&#39;</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">plugin_name</span>
        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="c"># Call impact calculation engine</span>
        <span class="n">impact_vector</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                                             <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">impact_vector</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

<span class="c">#        calculated_damage = []</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)):</span>
            <span class="n">calculated_damage</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;DAMAGE&#39;</span><span class="p">]</span>
            <span class="n">bldg_class</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;ITB_Class&#39;</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Calculated damage did not match expected result: </span><span class="se">\n</span><span class="s">&#39;</span>
               <span class="s">&#39;I got </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span>
               <span class="s">&#39;Expected </span><span class="si">%s</span><span class="s"> for bldg type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calculated_damage</span><span class="p">,</span>
                                                  <span class="n">ref_damage</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bldg_class</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">nanallclose</span><span class="p">(</span><span class="n">calculated_damage</span><span class="p">,</span> <span class="n">ref_damage</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="c"># Reference data is single precision</span>
                               <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">),</span> <span class="n">msg</span>

<span class="c">#        print calculated_damage.shape</span>
<span class="c">#        bldg_class = attributes[:][&#39;VCLASS&#39;]</span>
<span class="c">#        impact_filename = impact_vector.get_filename()</span>
<span class="c">#        I = read_layer(impact_filename)</span>
<span class="c">#        calculated_result = I.get_data()</span>

<span class="c">#        keywords = I.get_keywords()</span>

<span class="c">#        print keywords</span>
<span class="c">#        print calculated_damage</span>

    <span class="n">test_itb_building_function</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_flood_on_roads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Jakarta flood (raster) impact on roads calculated correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">floods</span> <span class="o">=</span> <span class="s">&#39;Flood_Current_Depth_Jakarta_geographic.asc&#39;</span>
        <span class="n">roads</span> <span class="o">=</span> <span class="s">&#39;indonesia_highway_sample.shp&#39;</span>
        <span class="n">plugin_name</span> <span class="o">=</span> <span class="s">&#39;Flood Road Impact Function&#39;</span>

        <span class="n">hazard_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">HAZDATA</span><span class="p">,</span> <span class="n">floods</span><span class="p">)</span>
        <span class="n">exposure_filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">roads</span><span class="p">)</span>

        <span class="c"># Get layers using API</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">hazard_filename</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">read_layer</span><span class="p">(</span><span class="n">exposure_filename</span><span class="p">)</span>

        <span class="n">plugin_list</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>
        <span class="n">IF</span> <span class="o">=</span> <span class="n">plugin_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">plugin_name</span><span class="p">]</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">calculate_impact</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">E</span><span class="p">],</span>
                             <span class="n">impact_fcn</span><span class="o">=</span><span class="n">IF</span><span class="p">)</span>
        <span class="c"># FIXME (Ole): To do when road functionality is done</span>

    <span class="n">test_flood_on_roads</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_erf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test ERF approximation</span>

<span class="sd">        Reference data obtained from scipy as follows:</span>
<span class="sd">        A = (numpy.arange(20) - 10.) / 2</span>
<span class="sd">        F = scipy.special.erf(A)</span>

<span class="sd">        See also table at http://en.wikipedia.org/wiki/Error_function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Simple tests</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">erf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">erf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.842700792949715</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">erf</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5204999</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">erf</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.999977909503001</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Reference data</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99999998</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99999926</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99997791</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99959305</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.99532227</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.96610515</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.84270079</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.52049988</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
              <span class="mf">0.52049988</span><span class="p">,</span> <span class="mf">0.84270079</span><span class="p">,</span> <span class="mf">0.96610515</span><span class="p">,</span> <span class="mf">0.99532227</span><span class="p">,</span> <span class="mf">0.99959305</span><span class="p">,</span>
              <span class="mf">0.99997791</span><span class="p">,</span> <span class="mf">0.99999926</span><span class="p">,</span> <span class="mf">0.99999998</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>

        <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">erf</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;ERF was not correct. I got </span><span class="si">%s</span><span class="s"> but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
               <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">test_normal_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test Normal Cumulative Distribution Function</span>

<span class="sd">        Reference data obtained from scipy as follows:</span>

<span class="sd">        A = (numpy.arange(20) - 10.) / 5</span>
<span class="sd">        R = scipy.stats.norm.cdf(A)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Simple tests</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.69146246127401312</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="mf">3.50</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.99976737092096446</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Out of bounds</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Reference data</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02275013</span><span class="p">,</span> <span class="mf">0.03593032</span><span class="p">,</span> <span class="mf">0.05479929</span><span class="p">,</span> <span class="mf">0.08075666</span><span class="p">,</span> <span class="mf">0.11506967</span><span class="p">,</span>
             <span class="mf">0.15865525</span><span class="p">,</span> <span class="mf">0.2118554</span><span class="p">,</span> <span class="mf">0.27425312</span><span class="p">,</span> <span class="mf">0.34457826</span><span class="p">,</span> <span class="mf">0.42074029</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
             <span class="mf">0.57925971</span><span class="p">,</span> <span class="mf">0.65542174</span><span class="p">,</span> <span class="mf">0.72574688</span><span class="p">,</span> <span class="mf">0.7881446</span><span class="p">,</span> <span class="mf">0.84134475</span><span class="p">,</span>
             <span class="mf">0.88493033</span><span class="p">,</span> <span class="mf">0.91924334</span><span class="p">,</span> <span class="mf">0.94520071</span><span class="p">,</span> <span class="mf">0.96406968</span><span class="p">]</span>

        <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;CDF was not correct. I got </span><span class="si">%s</span><span class="s"> but expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
               <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">test_lognormal_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test Log-normal Cumulative Distribution Function</span>

<span class="sd">        Reference data obtained from scipy as follows:</span>

<span class="sd">        A = (numpy.arange(20) - 10.) / 5</span>
<span class="sd">        R = scipy.stats.lognorm.cdf(A)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Suppress warnings about invalid value in multiply and divide zero</span>
        <span class="c"># http://comments.gmane.org/gmane.comp.python.numeric.general/43218</span>
        <span class="c"># http://docs.scipy.org/doc/numpy/reference/generated/numpy.seterr.html</span>
        <span class="n">old_numpy_setting</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="c"># Simple tests</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">lognormal_cdf</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="o">**</span><span class="n">old_numpy_setting</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">lognormal_cdf</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">lognormal_cdf</span><span class="p">(</span><span class="mf">3.50</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">3.5</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">),</span> <span class="n">msg</span>

        <span class="c"># Out of bounds</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">lognormal_cdf</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected </span><span class="si">%.12f</span><span class="s">, but got </span><span class="si">%.12f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">),</span> <span class="n">msg</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="n">Test_Engine</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../../../contents.html">
          <img class="logo" src="../../../_static/icon.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Home</a> &raquo;</li>
    <li><a href="../../../contents.html">Contents</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, BNPB/AIFDR/GFDRR.
      Last updated on Feb 28, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    <!-- cloud_sptheme 1.3 -->
  </body>
</html>