


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>InaSAFE Realtime &mdash; InaSAFE 1.0.1-final documentation</title>
    
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.1-final',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/toggle_sections.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="InaSAFE 1.0.1-final documentation" href="../index.html" />
    <link rel="up" title="InaSAFE developer documentation" href="index.html" />
    <link rel="next" title="InaSAFE’s API documentation" href="../api-docs/index.html" />
    <link rel="prev" title="Todo List" href="todo.html" /> 
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../api-docs/index.html" title="InaSAFE’s API documentation"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="todo.html" title="Todo List"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Home</a> &raquo;</li>
    <li><a href="../contents.html">Contents</a> &raquo;</li>

          <li><a href="index.html" accesskey="U">InaSAFE developer documentation</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="inasafe-realtime">
<h1>InaSAFE Realtime<a class="headerlink" href="#inasafe-realtime" title="Permalink to this headline">¶</a></h1>
<p>InaSAFE Realtime is a component of the InaSAFE project designed for deployment
on a server and creation of Impact Maps a short interval after an event occurs.</p>
<p>Currently the realtime system supports Earthquake fatality impact assessments,
though in future we envisage additional support for other disaster types being
facilitated.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This work was funded by the Australia-Indonesia Facility for Disaster
Reduction, Geoscience Australia and the GFDRR. We thank you for your
support.</p>
</div>
<div class="section" id="historical-note">
<h2>Historical Note<a class="headerlink" href="#historical-note" title="Permalink to this headline">¶</a></h2>
<p>The original prototype of the realtime system was implemented by Ole Nielsen
(AusAID). The subsequent port of the realtime system to InaSAFE was implemented
by Tim Sutton (Linfiniti Consulting CC., funded by The World Bank and the
AIFDR).</p>
</div>
<div class="section" id="supported-platforms">
<h2>Supported Platforms<a class="headerlink" href="#supported-platforms" title="Permalink to this headline">¶</a></h2>
<p>Currently only Ubuntu 12.04 is supported. The software may work or can easily
be made to work on other platforms but it is untested.</p>
</div>
<div class="section" id="generated-products">
<h2>Generated Products<a class="headerlink" href="#generated-products" title="Permalink to this headline">¶</a></h2>
<p>For every shake event, the tool produces a number of GIS products:</p>
<ul>
<li><dl class="first docutils">
<dt>A raster layer interpolated from the original MMI point matrix and symbolized</dt>
<dd><p class="first last">according to the MMI scale colours.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A vector (shapefile) layer generated from the original MMI point matrix and</dt>
<dd><p class="first last">symbolized according to the MMI scale colours.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A vector (shapefile) layer depicting MMI isolines and symbolized according to</dt>
<dd><p class="first last">the MMI scale colours.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A cities layer (shapefile) which lists the affected cities along with key</dt>
<dd><p class="first last">data such as distance from and direction to epicenter, number of people resident in the city, mmi exposure etc.</p>
</dd>
</dl>
</li>
</ul>
<p>In addition to the above mentioned GIS products, the following 3 files are
created for each event:</p>
<ul>
<li><p class="first">A PNG file containing a single page report as illustrated above.</p>
</li>
<li><dl class="first docutils">
<dt>A large PNG image which contains exactly the same content as the pdf but in</dt>
<dd><p class="first last">an image format.</p>
</dd>
</dl>
</li>
<li><p class="first">A thumbnail PNG image which contains a reduced size image of the report.</p>
</li>
</ul>
</div>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>InaSAFE Realtime is implemented by four main python modules:</p>
<ul>
<li><dl class="first docutils">
<dt><strong>ftp_client</strong> - A generic tool to fetch directory listings and</dt>
<dd><p class="first last">files from a remote server.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>shake_data</strong> - A mostly generic tool to fetch shake files from</dt>
<dd><p class="first last">an ftp server. There is an expectation that the server layout
follows a simple flat structure where files are named
after the shake event and are in the format of shake data as
provided by the USGS (XXXXXX TODO fact check XXXX).
<tt class="samp docutils literal"><span class="pre">ftp://118.97.83.243/20110413170148.inp.zip</span></tt>
<strong>Note:</strong> This data is now no longer hosted via ftp and requires an ssh
account in order to retrieve it.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>shake_event</strong> - A rather monolithic module that &#8216;knows&#8217; how to</dt>
<dd><p class="first last">fetch, unpack, process and generate a report for a quake event.
The module logic is based on the standard shake data packaging
format supplied by the USGS. We have restricted out implementation
to require only the <tt class="file docutils literal"><span class="pre">grid.xml</span></tt> file contained in the inp.zip
file in the downloaded zip file.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>make_map</strong> - A simple python tool for running one or multiple shake</dt>
<dd><p class="first last">analyses.</p>
</dd>
</dl>
</li>
</ul>
<p>InaSAFE has strong dependencies on QGIS (<a class="reference external" href="http://qgis.org">http://qgis.org</a>) which is
used for much of the data processing and reporting functionality.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently version 779e16603ee3fb8781c85a0e95913a1f6bbd2d6a is
the &#8216;known good&#8217; SHA1.</p>
</div>
<p>Two of these dependencies is a template QGIS project and a map
composition template. We have designed the realtime reporting engine
to allow end users to customise the map report to their needs with little
or no programming. The primary way to achieve this is by opening the custom
template <tt class="file docutils literal"><span class="pre">realtime/fixtures/realtime-template.qpt</span></tt> in QGIS and modifying
its contents. You could also build a new template from scratch provided the
item IDs listed in the section that follows are used.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>The supported platform is currently Ubuntu 12.04 LTS. The instructions provided
below are for that OS. First we are going to hand build QGIS. This may not be
needed in future once 2.0 packages are available, but for now it is
recommended.:</p>
<div class="highlight-python"><pre>sudo apt-get install python-software-properties
sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable
sudo apt-get update
sudo apt-get build-dep qgis
cd ~
mkdir -p dev/cpp
sudo mkdir /home/web
sudo chown &lt;youruser&gt;.&lt;youruser&gt; /home/web
cd ~/dev/cpp
sudo apt-get install git cmake-curses-gui
git clone git://github.com/qgis/Quantum-GIS.git</pre>
</div>
<p>At this point you should enter ‘yes’ when prompted:</p>
<div class="highlight-python"><pre>cd Quantum-GIS
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local/qgis-realtime \
-DCMAKE_BUILD_TYPE=Debug
make -j4
sudo mkdir /usr/local/qgis-realtime
sudo chown &lt;youruser&gt;.&lt;youruser&gt; /usr/local/qgis-realtime
make install</pre>
</div>
<p>At this point you can test if your hand build QGIS is working by doing:</p>
<div class="highlight-python"><pre>export LD_LIBRARY_PATH=/usr/local/qgis-realtime/lib
export QGIS_PREFIX_PATH=/usr/local/qgis-realtime
export PYTHONPATH=/usr/local/qgis-realtime/share/qgis/python
python
from qgis.core import *
ctrl-d</pre>
</div>
<p>You should see something like the listing below:</p>
<div class="highlight-python"><pre>timlinux@waterfall:~/dev/python/inasafe-realtime$ python
Python 2.7.3 (default, Sep 26 2012, 21:51:14)
[GCC 4.7.2] on linux2
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; from qgis.core import *
&gt;&gt;&gt;</pre>
</div>
<p>Get InaSAFE</p>
<div class="highlight-python"><pre>cd ~
mkdir -p dev/python
cd dev/python
git clone git://github.com/AIFDR/inasafe.git inasafe-realtime
cd inasafe-realtime
sudo apt-get install python-tz paramikio</pre>
</div>
<p>Setup Apache:</p>
<div class="highlight-python"><pre>sudo apt-get install apache2-mpm-worker
cd /etc/apache2/sites-available
sudo cp ~/dev/python/inasafe-realtime/realtime/fixtures/web/quake-apache.conf .
sudo apt-get install rpl
sudo chown &lt;yourname&gt;.&lt;yourname&gt; quake-apache.conf
rpl “quake.linfiniti.com” “quake.&lt;yourhost&gt;” quake-apache.conf</pre>
</div>
<p>For local testing only you can use quake.localhost for your host then add this to your /etc/hosts:</p>
<div class="highlight-python"><pre>127.0.0.1 localhost quake.localhost</pre>
</div>
<p>Now deploy your site:</p>
<blockquote>
<div>sudo a2dissite default
sudo a2enssite quake.apache.conf
cd /home
chmod a+X web
mkdir web/quake
chmod a+X web/quake
cd /home/web/quake</div></blockquote>
<p>Just for testing do:</p>
<div class="highlight-python"><pre>mkdir public
echo 'Hello' &gt; public/foo.txt
sudo service apache2 restart</pre>
</div>
<p>Open your web browser and point it to : <a class="reference external" href="http://quake.localhost">http://quake.localhost</a></p>
<p>You should see a basic directory listing containing file foo.</p>
<p>Now copy over some required datasets:</p>
<div class="highlight-python"><pre>cd ~/dev/python/inasafe-realtime/realtime/fixtures/
wget http://quake.linfiniti.com/indonesia.sqlite

mkdir ~/dev/python/inasafe-realtime/realtime/fixtures/exposure
cd ~/dev/python/inasafe-realtime/realtime/fixtures/exposure
wget http://quake.linfiniti.com/population.tif
wget http://quake.linfiniti.com/population.keywords

cd /home/web/quake/public
wget http://quake.linfiniti.com/web.tar.gz
tar xfz web.tar.gz
rm web.tar.gz</pre>
</div>
<p>Running your first report:</p>
<div class="highlight-python"><pre>cd ~/dev/python/inasafe-realtime
scripts/make-latest-shakemap.sh</pre>
</div>
<p>Running all back reports:</p>
<div class="highlight-python"><pre>cd ~/dev/python/inasafe-realtime
scripts/make-all-shakemaps.sh</pre>
</div>
<p>Listing shake files on ftp server:</p>
<div class="highlight-python"><pre>cd ~/dev/python/inasafe-realtime
scripts/make-list-shakes.sh</pre>
</div>
<p>Cron Jobs:</p>
<p>There are two cron jobs - one to run the latest shake event regularly, and one
to synchronise all the shake outputs:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">crontab</span> <span class="o">-</span><span class="n">e</span>
</pre></div>
</div>
<p>Now add these lines (replacing &lt;yourname&gt;):</p>
<div class="highlight-python"><pre>* * * * * /home/&lt;yourname&gt;/dev/python/inasafe-realtime/realtime/fixtures/web/make-public.sh
* * * * * /home/&lt;yourname&gt;/bin/realtime.sh</pre>
</div>
<p>Finally make a small script to run the analysis every minute:</p>
<div class="highlight-python"><pre>cd ~
mkdir bin
cd bin
touch realtime.sh
chmod +x realtime.sh</pre>
</div>
<p>Now edit the file and set its content to this:</p>
<div class="highlight-python"><pre>#!/bin/bash
cd /home/&lt;yourname&gt;/dev/python/inasafe-realtime
scripts/make-latest-shakemap.sh</pre>
</div>
<p>You also need to have the standard datasets needed for the cartography:</p>
<ul class="simple">
<li>population</li>
<li>indonesia.sqlite (can be changed by adjusting the QGIS project).</li>
</ul>
</div>
<div class="section" id="qgis-map-template-elements">
<h2>QGIS Map Template Elements<a class="headerlink" href="#qgis-map-template-elements" title="Permalink to this headline">¶</a></h2>
<p>This section describes the various elements that comprise the standard map
template, and which you can modify directly in the template. These fall into
three groups:</p>
<ul class="simple">
<li><strong>Static elements</strong>.</li>
<li><strong>Elements containing tokens for replacement</strong>.</li>
<li><strong>Elements that are directly updated by the renderer</strong>.</li>
</ul>
<div class="section" id="static-elements">
<h3>Static Elements<a class="headerlink" href="#static-elements" title="Permalink to this headline">¶</a></h3>
<p>These are e.g. logos which are not touched by the realtime map renderer at all.
You can remove or replace them with your own elements as needed.</p>
<ul>
<li><p class="first"><strong>logo-left</strong> - the logo element at the top left corner of the map layout.</p>
</li>
<li><p class="first"><strong>right-logo</strong> - the logo element at the top right corner of the map layout.</p>
</li>
<li><dl class="first docutils">
<dt><strong>overview-map</strong> - a map overview showing the locality of the event. This</dt>
<dd><p class="first last">is the overview frame for map-0 (the main map in the layout). It is
locked and limited to show the population layer only.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>legend</strong> - a map legend, by default configured to show only the layer for</dt>
<dd><p class="first last">the population layer. It is locked and limited to the population layer.</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="elements-containing-tokens-for-replacement">
<h3>Elements containing tokens for replacement<a class="headerlink" href="#elements-containing-tokens-for-replacement" title="Permalink to this headline">¶</a></h3>
<p>In this case the element name is not significant, only the token(s) it
contains. At render time any of the tokens in these elements will be replaced
with translated (if an alternative locale is in effect) content from the
map renderer according to the keywords listed below in this document.</p>
<ul>
<li><dl class="first docutils">
<dt><strong>main-title</strong> - the main title at the top of the page. By default this</dt>
<dd><p class="first last">element contains the keyword:
<tt class="samp docutils literal"><span class="pre">[map-name]</span></tt>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>intensity-date</strong> - the date and intensity of the event. By default this</dt>
<dd><p class="first last">label contains the following replacement tokens:
<tt class="samp docutils literal"><span class="pre">M[mmi]</span> <span class="pre">[date]</span> <span class="pre">[time]</span></tt></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>position-depth</strong> - the position (lon, lat) and depth of the event. By</dt>
<dd><p class="first last">default this label contains the following replacement tokens:
<tt class="samp docutils literal"><span class="pre">[longitude-name]</span> <span class="pre">[longitude-value]</span> <span class="pre">[latitude-name]</span> <span class="pre">[latitude-value]</span> <span class="pre">[depth-name]</span> <span class="pre">[depth-value]</span> <span class="pre">[depth-unit]</span></tt></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>location-description</strong> - the postion of the event described relative to</dt>
<dd><p class="first last">the nearest major populated place. By default this label contains the
following replacement tokens:
<tt class="samp docutils literal"><span class="pre">[located-label]</span> <span class="pre">[distance]</span> <span class="pre">[distance-unit],</span> <span class="pre">[bearing-degrees]</span> <span class="pre">[bearing-compass]</span> <span class="pre">[direction-relation]</span> <span class="pre">[place-name]</span></tt></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>elapsed-time</strong> - the time elapsed between the event and when this report</dt>
<dd><p class="first last">was generated. By default this label contains the following replacement
tokens:
<tt class="samp docutils literal"><span class="pre">[elapsed-time-label]</span> <span class="pre">[elapsed-time]</span></tt></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>scalebar</strong> - the scalebar which reflects the scale of the main map.</dt>
<dd><p class="first last">This is <strong>Currently disabled</strong>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>disclaimer</strong> - A block of text for displaying caveats, cautionary notes,</dt>
<dd><p class="first last">interpretive information and so on. This contains the following replacement
tokens: <tt class="samp docutils literal"><span class="pre">[limitations]</span></tt>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>credits</strong> - A block of text for displaying credits on the map output.</dt>
<dd><p class="first last">This contains the following replacement tokens: <tt class="samp docutils literal"><span class="pre">[credits]</span></tt>.</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="elements-that-are-directly-updated-by-the-renderer">
<h3>Elements that are directly updated by the renderer<a class="headerlink" href="#elements-that-are-directly-updated-by-the-renderer" title="Permalink to this headline">¶</a></h3>
<p>In this case any content that may be present in the element is completely
replaced by the realtime map renderer, although certain styling options
(e.g. graticule settings on the map) will remain in effect.</p>
<ul>
<li><dl class="first docutils">
<dt><strong>impacts-table</strong> - a table generated by ShakeEvent which will list the</dt>
<dd><p class="first last">number of modelled affected people in each of the MMI bands. This is an
HTML element and output will fail if it is not present.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>main-map</strong> - primary map used to display the event and neighbouring towns.</dt>
<dd><p class="first last">Developers can set a minimum number of neighbouring towns to display using
the ShakeEvent api. This is a map element and output will fail if it is
not present. This is an HTML element and output will fail if it is not
present.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>affected-cities</strong> - a table generated by ShakeEvent which will list the</dt>
<dd><p class="first last">closes N cities (configurable using the ShakeEvent api) listed in order of
shake intensity then number of people likely to be affected.</p>
</dd>
</dl>
</li>
</ul>
</div>
</div>
<div class="section" id="replaceable-keywords">
<h2>Replaceable Keywords<a class="headerlink" href="#replaceable-keywords" title="Permalink to this headline">¶</a></h2>
<p>This section describes tokenised keywords that are passed to the map template.
To insert any of these keywords into the map template, simply enclose the
key in [] (e.g. [place-name]) and it will be replaced by the text value (e.g.
Tondano). The list includes static phrases which have been internationalised
(and so will display in the language of the selected map local, defaulting to
English where no translation if available. In cases where static definitions
are used (e.g. [credits]) you can substitute your own definitions by creating
your own template. More on that below in the next section.</p>
<ul class="simple">
<li><strong>map-name</strong>: Estimated Earthquake Impact</li>
<li><strong>exposure-table-name</strong>: Estimated number of people exposed to each MMI level</li>
<li><strong>city-table-name</strong>: Places Affected</li>
<li><strong>legend-name</strong>: Population density</li>
<li><strong>limitations</strong>: This impact estimation is automatically generated and only takes
into account the population and cities affected by different
levels of ground shaking. The estimate is based on ground
shaking data from BMKG, population density data from asiapop
.org, place information from geonames.org and software developed
by BNPB. Limitations in the estimates of ground shaking,
population  data and place names datasets may result in
significant misrepresentation of the on-the-ground situation in
the figures shown here. Consequently decisions should not be
made solely on the information presented here and should always
be verified by ground truthing and other reliable information
sources.</li>
<li><strong>credits</strong>: Supported by the Australia-Indonesia Facility for Disaster
Reduction and Geoscience Australia.</li>
<li><strong>place-name</strong>: Tondano</li>
<li><strong>depth-name</strong>: Depth</li>
<li><strong>location-info</strong>: M 5.0 26-7-2012 2:15:35 Latitude: 12 &#8216;36.00&#8221;S Longitude:
124&#8216;27&#8216;0.00&#8221;E Depth: 11.0km Located 2.50km SSW of Tondano</li>
<li><strong>depth-unit</strong>: km</li>
<li><strong>bearing-compass</strong>: SSW</li>
<li><strong>distance-unit</strong>: km</li>
<li><strong>mmi</strong>: 5.0</li>
<li><strong>longitude-name</strong>: Longitude</li>
<li><strong>date</strong>: 26-7-2012</li>
<li><strong>time</strong>: 2:15:35</li>
<li><a href="#id1"><span class="problematic" id="id2">**</span></a>formatted-date-time: 26-Jul-12 02:15:35</li>
<li><strong>located-label</strong>: Located</li>
<li><strong>bearing-degrees</strong>: -163.055923462</li>
<li><strong>distance</strong>: 2.50</li>
<li><strong>direction-relation</strong>: of</li>
<li><strong>latitude-name</strong>: Latitude</li>
<li><strong>latitude-value</strong>: 12&#8216;36.00&#8221;S</li>
<li><strong>longitude-value</strong>: 12&#8216;4&#8216;27.00</li>
<li><strong>depth-value</strong>: 11.0</li>
<li><strong>version</strong>: Version: 1.0.1</li>
<li><strong>bearing-text</strong>: bearing</li>
<li><strong>elapsed-time-name</strong>: Elapsed time</li>
<li><strong>elapsed-time</strong>: 26-Jul-12 02:15:35</li>
<li><strong>fatalities-name</strong>: Estimated Fatalities</li>
<li><strong>fatalities-range</strong>: 5 - 55</li>
<li><strong>fatalities-count</strong>: 55</li>
</ul>
</div>
<div class="section" id="customising-the-template">
<h2>Customising the template<a class="headerlink" href="#customising-the-template" title="Permalink to this headline">¶</a></h2>
<p>You have a few options to customise the template - we have gone to great
lengths to ensure that you can flexibly adjust the report composition
<strong>without doing any programming</strong>. There are three primary ways you can achieve
this:</p>
<ul>
<li><p class="first">Moving replacement tags into different elements, or removing them completely.</p>
</li>
<li><dl class="first docutils">
<dt>Moving the template elements themselves around or adding / removing them</dt>
<dd><p class="first last">completely.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Creating your own template from scratch and pointing the realtime tool to</dt>
<dd><p class="first last">your preferred template.</p>
</dd>
</dl>
</li>
</ul>
<p>The template is provided as <tt class="file docutils literal"><span class="pre">realtime/fixtures/realtime-template.qpt</span></tt>
and can be modified by opening the template using the QGIS map composer,
making your changes and then overwriting the template. You should take care
to test your template changes before deploying them to a live server, and
after deploying them to a live server.</p>
<p>If you wish to use your own custom template, you need to specify the
<tt class="samp docutils literal"><span class="pre">INSAFE_REALTIME_TEMPLATE</span></tt> environment variable, populating it with
the path to your preferred template file.</p>
</div>
<div class="section" id="qgis-realtime-project">
<h2>QGIS Realtime Project<a class="headerlink" href="#qgis-realtime-project" title="Permalink to this headline">¶</a></h2>
<p>The cartography provided in the realtime maps is loaded from the
<tt class="file docutils literal"><span class="pre">realtime/fixtures/realtime.qgs</span></tt> QGIS project file. You can open this
file using QGIS, change the layers and their symbology, and your changes
will be reflected in the generated realtime shake report.</p>
<p>There are however some caveats to this:</p>
<ul class="simple">
<li>The overview map has locked layers</li>
<li>The main map should always have a population layer with grayscale legend
matching that provided in the original. If you do remove / change the
population layer you should also remove / change the population layer legend.</li>
</ul>
<p>If you wish to use your own custom project, you need to specify the
<tt class="samp docutils literal"><span class="pre">INSAFE_REALTIME_PROJECT</span></tt> environment variable, populating it with
the path to your preferred project file.</p>
</div>
<div class="section" id="configuration-of-population-data">
<h2>Configuration of population data<a class="headerlink" href="#configuration-of-population-data" title="Permalink to this headline">¶</a></h2>
<p>Population data is used as the &#8216;exposure&#8217; dataset for shake reports.
The following priority will be used to determine the path of the population
raster dataset.
# the class attribute <strong>self.populationRasterPath</strong></p>
<blockquote>
<div>will be checked and if not None it will be used.</div></blockquote>
<dl class="docutils">
<dt># the environment variable <tt class="samp docutils literal"><span class="pre">INASAFE_POPULATION_PATH</span></tt> will be</dt>
<dd>checked if set it will be used.</dd>
<dt># A hard coded path of</dt>
<dd><tt class="file docutils literal"><span class="pre">/fixtures/exposure/population.tif</span></tt> will be checked.</dd>
<dt># A hard coded path of</dt>
<dd><tt class="file docutils literal"><span class="pre">/usr/local/share/inasafe/exposure/population.tif</span></tt> will be used.</dd>
</dl>
</div>
<div class="section" id="running-a-shake-event">
<h2>Running a shake event<a class="headerlink" href="#running-a-shake-event" title="Permalink to this headline">¶</a></h2>
<p>To run a single event locally on a system with an X-Server you can
use the provided script <tt class="file docutils literal"><span class="pre">scripts/make-shakemap.sh</span></tt>. The script can be
used with the following options:</p>
<ul>
<li><dl class="first docutils">
<dt><strong>&#8211;list</strong>: <tt class="samp docutils literal"><span class="pre">scripts/make-shakemap.sh</span> <span class="pre">--list</span></tt> - retrieve a list of</dt>
<dd><p class="first last">all known shake events on the server. Events are listed as their full
ftp url e.g. <tt class="file docutils literal"><span class="pre">ftp://118.97.83.243/20121106084105.out.zip</span></tt> and
both <em>inp</em> and <em>out</em> files are listed.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>[event id]</strong>: <tt class="samp docutils literal"><span class="pre">scripts/make-shakemap.sh</span> <span class="pre">20121106084105</span></tt> - retrieve</dt>
<dd><p class="first last">and process a single shake event. A pdf, png and thumbnail will be produced.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>&#8211;all</strong>: <tt class="samp docutils literal"><span class="pre">scripts/make-shakemap.sh</span> <span class="pre">--all</span></tt> - process all identified</dt>
<dd><p class="first last">events on the server in batch mode. <strong>Note:</strong> this is experimental and
not production ready - we recommend to use the approach described in
<a class="reference internal" href="#realtime-batch"><em>Batch validation &amp; running</em></a>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>no parameters</strong>: <tt class="samp docutils literal"><span class="pre">scripts/make-shakemap.sh</span></tt> - fetch and process</dt>
<dd><p class="first last">the latest existing shake dataset. This is typically what you would want
to use as the target of a cron job.</p>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="file docutils literal"><span class="pre">make_shakemap.sh</span></tt> script is just a thin wrapper around
the python <tt class="xref py py-mod docutils literal"><span class="pre">realtime.make_map</span></tt> python module.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An english local shakemap will always be generated regardless of
the locale you have chosen (using the INASAFE_LOCALE env var). This en
version will be in addition to your chosen locale.</p>
</div>
</div>
<div class="section" id="unit-tests">
<h2>Unit tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h2>
<p>A complete set of unit tests is provided with the realtime package for InaSAFE.
You can execute these tests like this:</p>
<div class="highlight-python"><pre>nosetests -v --with-id --with-xcoverage --with-xunit --verbose \
    --cover-package=realtime realtime</pre>
</div>
<p>There are also a number of Jenkins tasks provided in the Makefile for InaSAFE
to automate testing on our continuous integration server. You can view the
current state of these tests by visiting this URL:</p>
<p><a class="reference external" href="http://jenkins.linfiniti.com/job/InaSAFE-Realtime/">http://jenkins.linfiniti.com/job/InaSAFE-Realtime/</a></p>
</div>
<div class="section" id="batch-validation-running">
<span id="realtime-batch"></span><h2>Batch validation &amp; running<a class="headerlink" href="#batch-validation-running" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="file docutils literal"><span class="pre">scripts/make-all-shakemaps.sh</span></tt> provided in the InaSAFE source tree
will automate the production of one shakemap report per event found on the
shake ftp server. It contains a number of environment variable settings which
can be used to control batch execution. First a complete script listing:</p>
<div class="highlight-python"><pre>#!/bin/bash

export QGIS_DEBUG=0
export QGIS_LOG_FILE=/tmp/inasafe/realtime/logs/qgis.log
export QGIS_DEBUG_FILE=/tmp/inasafe/realtime/logs/qgis-debug.log
export QGIS_PREFIX_PATH=/usr/local/qgis-realtime/
export PYTHONPATH=/usr/local/qgis-realtime/share/qgis/python/:`pwd`
export LD_LIBRARY_PATH=/usr/local/qgis-realtime/lib
export INASAFE_WORK_DIR=/home/web/quake
export SAFE_POPULATION_PATH=/var/lib/jenkins/jobs/InaSAFE-Realtime/exposure/population.tif
for FILE in `xvfb-run -a --server-args="-screen 0, 1024x768x24" python realtime/make_map.py --list | grep -v inp | grep -v Proces`
do
    FILE=`echo $FILE | sed 's/ftp:\/\/118.97.83.243\///g'`
    FILE=`echo $FILE | sed 's/.out.zip//g'`
    echo "Running: $FILE"
    xvfb-run -a --server-args="-screen 0, 1024x768x24" python realtime/make_map.py $FILE
done
exit</pre>
</div>
<p>An example of the output produced from such a batch run is provided at:</p>
<p><a class="reference external" href="http://quake.linfiniti.com/">http://quake.linfiniti.com/</a></p>
</div>
<div class="section" id="hosting-the-shakemaps">
<h2>Hosting the shakemaps<a class="headerlink" href="#hosting-the-shakemaps" title="Permalink to this headline">¶</a></h2>
<p>In this section we describe how to easily host the shakemaps on a public web
site.</p>
<p>An apache configuration file and a set of resources are provided to make it easy
to host the shakemap outputs. The resources provided can easily be modified to
provide a pleasing, user friendly directory listing of shakemap reports.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You should adapt the paths used below to match the configuration of
your system.</p>
</div>
<p>First create a file (as root / sudo) with this content in your
<tt class="file docutils literal"><span class="pre">/etc/apache2/sites-available/quake-apache.conf.</span></tt> for example:</p>
<div class="highlight-python"><pre>&lt;VirtualHost *:80&gt;
  ServerAdmin tim@linfiniti.com
  ServerName quake.linfiniti.com

  DocumentRoot /home/web/quake/public/
  &lt;Directory /home/web/quake/public/&gt;
    Options Indexes FollowSymLinks
    IndexOptions +FancyIndexing
    IndexOptions +FoldersFirst
    IndexOptions +XHTML
    IndexOptions +HTMLTable
    IndexOptions +SuppressRules
    HeaderName resource/header.html
    ReadmeName resource/footer.html
    IndexStyleSheet "resource/bootstrap.css"
    IndexIgnore .htaccess /resource
    AllowOverride None
    Order allow,deny
    allow from all
  &lt;/Directory&gt;

  ErrorLog /var/log/apache2/quake.linfiniti.error.log
  CustomLog /var/log/apache2/quake.linfiniti.access.log combined
  ServerSignature Off

&lt;/VirtualHost&gt;</pre>
</div>
<p>Now make the <tt class="file docutils literal"><span class="pre">/home/web/quake/public</span></tt> directory in which the outputs will
be hosted:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">quake</span><span class="o">/</span><span class="n">public</span>
</pre></div>
</div>
<p>Unpack the <tt class="file docutils literal"><span class="pre">realtime/fixtures/web/resource</span></tt> directory into the
above mentioned public directory. For example:</p>
<div class="highlight-python"><pre>cd /home/web/quake/public
cp -r ~/dev/python/inasafe/realtime/fixtures/web/resource .</pre>
</div>
<p>Next ensure that apache has read access to your hosting directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">chmod</span> <span class="o">+</span><span class="n">X</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">quake</span><span class="o">/</span><span class="n">public</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">X</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">quake</span><span class="o">/</span><span class="n">public</span><span class="o">/</span><span class="n">resource</span>
</pre></div>
</div>
<p>You can customise the look and feel of the hosted site by editing the files in
<tt class="file docutils literal"><span class="pre">/home/web/quake/public/resource</span></tt> (assumes basic knowledge of HTML).</p>
<p>Lastly, you should regularly run a script to move generated pdf and png
outputs into the public directory. An example of such a script is provided as
<tt class="file docutils literal"><span class="pre">realtime/fixtures/web/make-public.sh</span></tt>. To run this script regularly, you
could add it to a cron job e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">crontab</span> <span class="o">-</span><span class="n">e</span>
</pre></div>
</div>
<p>And then add a line like this to the cron file:</p>
<div class="highlight-python"><pre>* * * * * /home/timlinux/dev/python/inasafe-realtime/realtime/fixtures/web/make-public.sh</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The resources used in the above examples are all available in the
source code under <tt class="file docutils literal"><span class="pre">realtime/fixtures/web</span></tt>.</p>
</div>
<p><a class="reference external" href="http://paradox460.newsvine.com/_news/2008/04/05/1413490-how2-stylish-apache-directory-listings">http://paradox460.newsvine.com/_news/2008/04/05/1413490-how2-stylish-apache-directory-listings</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../contents.html">
          <img class="logo" src="../_static/icon.png" alt="Logo"/>
        </a></p>
  <h3><a href="../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">InaSAFE Realtime</a><ul>
<li><a class="reference internal" href="#historical-note">Historical Note</a></li>
<li><a class="reference internal" href="#supported-platforms">Supported Platforms</a></li>
<li><a class="reference internal" href="#generated-products">Generated Products</a></li>
<li><a class="reference internal" href="#architecture">Architecture</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#qgis-map-template-elements">QGIS Map Template Elements</a><ul>
<li><a class="reference internal" href="#static-elements">Static Elements</a></li>
<li><a class="reference internal" href="#elements-containing-tokens-for-replacement">Elements containing tokens for replacement</a></li>
<li><a class="reference internal" href="#elements-that-are-directly-updated-by-the-renderer">Elements that are directly updated by the renderer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#replaceable-keywords">Replaceable Keywords</a></li>
<li><a class="reference internal" href="#customising-the-template">Customising the template</a></li>
<li><a class="reference internal" href="#qgis-realtime-project">QGIS Realtime Project</a></li>
<li><a class="reference internal" href="#configuration-of-population-data">Configuration of population data</a></li>
<li><a class="reference internal" href="#running-a-shake-event">Running a shake event</a></li>
<li><a class="reference internal" href="#unit-tests">Unit tests</a></li>
<li><a class="reference internal" href="#batch-validation-running">Batch validation &amp; running</a></li>
<li><a class="reference internal" href="#hosting-the-shakemaps">Hosting the shakemaps</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="todo.html"
                        title="previous chapter">Todo List</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../api-docs/index.html"
                        title="next chapter">InaSAFE&#8217;s API documentation</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/developer-docs/realtime.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../api-docs/index.html" title="InaSAFE’s API documentation"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="todo.html" title="Todo List"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Home</a> &raquo;</li>
    <li><a href="../contents.html">Contents</a> &raquo;</li>

          <li><a href="index.html" >InaSAFE developer documentation</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, BNPB/AIFDR/GFDRR.
      Last updated on Feb 25, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    <!-- cloud_sptheme 1.3 -->
  </body>
</html>